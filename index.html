<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HORTIFRUTI CLIENTE 2</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- NO HORTIFRUTI 2 - ap√≥s Firebase -->
<script>
// PROTE√á√ÉO HORTIFRUTI 2 - CLIENTE B - VERS√ÉO CORRIGIDA
// Chave: horti2_cart
// ============================================
(function() {
    'use strict';
    
    const SISTEMA = 'HORTIFRUTI 2 (Cliente B)';
    const CHAVE_CART = 'horti2_cart';
    // REMOVA horti2_cart da lista de chaves bloqueadas
    const CHAVES_BLOQUEAR = ['horti1_cart', 'horti3_cart', 'cart', 'horti_cart']; // REMOVEU horti2_cart
    
    console.log(`üõ°Ô∏è ${SISTEMA} - Usando: ${CHAVE_CART}`);
    
    // 1. VERIFICAR SE J√Å EXISTE horti2_cart
    let cartSalvo = localStorage.getItem(CHAVE_CART);
    
    // 2. SE N√ÉO EXISTIR horti2_cart, VERIFICAR chaves antigas
    if (!cartSalvo) {
        // Primeiro verificar horti_cart (migra√ß√£o do sistema antigo)
        const hortiCartAntigo = localStorage.getItem('horti_cart');
        if (hortiCartAntigo) {
            console.log('üîÑ Migrando horti_cart ‚Üí horti2_cart');
            localStorage.setItem(CHAVE_CART, hortiCartAntigo);
            cartSalvo = hortiCartAntigo;
            
            // Remover horti_cart ap√≥s migra√ß√£o
            setTimeout(() => {
                localStorage.removeItem('horti_cart');
                console.log('üóëÔ∏è horti_cart antigo removido');
            }, 1000);
        } 
        // Depois verificar cart (gen√©rico)
        else if (localStorage.getItem('cart')) {
            const cartAntigo = localStorage.getItem('cart');
            console.log('üîÑ Migrando cart ‚Üí horti2_cart');
            localStorage.setItem(CHAVE_CART, cartAntigo);
            cartSalvo = cartAntigo;
            
            // Remover cart antigo ap√≥s migra√ß√£o
            setTimeout(() => {
                localStorage.removeItem('cart');
                console.log('üóëÔ∏è cart antigo removido');
            }, 1000);
        }
        // ADICIONE ESTA PARTE PARA VERIFICAR horti2_cart TAMB√âM
        else if (localStorage.getItem('horti2_cart')) {
            const horti2_carttAntigo = localStorage.getItem('horti2_cart');
            console.log('üîÑ Migrando horti2_cart ‚Üí horti2_cart');
            localStorage.setItem(CHAVE_CART, horti2_carttAntigo);
            cartSalvo = horti2_carttAntigo;
            
            // Remover horti2_cart ap√≥s migra√ß√£o
            setTimeout(() => {
                localStorage.removeItem('horti2_cart');
                console.log('üóëÔ∏è horti2_cart antigo removido');
            }, 1000);
        }
    }
    
    // 3. REMOVER chaves de outros sistemas (sempre)
    CHAVES_BLOQUEAR.forEach(chave => {
        if (chave !== CHAVE_CART && chave !== 'cart' && chave !== 'horti_cart') {
            if (localStorage.getItem(chave)) {
                localStorage.removeItem(chave);
                console.log(`üóëÔ∏è Removido: ${chave}`);
            }
        }
    });
    
    // 4. MODIFICAR AS FUN√á√ïES DE PROTE√á√ÉO PARA PERMITIR horti2_cart
    const originalGetItem = localStorage.getItem.bind(localStorage);
    const originalSetItem = localStorage.setItem.bind(localStorage);
    
    localStorage.getItem = function(key) {
        // PERMITE acesso a horti2_cart (apenas leitura para migra√ß√£o)
        if (key === 'horti2_cart') {
            console.log(`üì• ${SISTEMA}: Acesso permitido a ${key} (apenas leitura)`);
            return originalGetItem(key);
        }
        
        if (CHAVES_BLOQUEAR.includes(key) && key !== 'cart' && key !== 'horti_cart') {
            console.warn(`üö´ ${SISTEMA}: Bloqueado acesso a ${key}`);
            return null;
        }
        
        if (key === 'cart') {
            const conteudo = originalGetItem(CHAVE_CART);
            return conteudo || '[]';
        }
        
        return originalGetItem(key);
    };
    
    localStorage.setItem = function(key, value) {
        // BLOQUEIA cria√ß√£o/atualiza√ß√£o de horti2_cart
        if (key === 'horti2_cart') {
            console.error(`üö´ ${SISTEMA}: Bloqueado cria√ß√£o/atualiza√ß√£o de ${key}`);
            console.log(`üîÄ ${SISTEMA}: Tentativa de salvar em ${key} ‚Üí redirecionando para ${CHAVE_CART}`);
            return originalSetItem(CHAVE_CART, value);
        }
        
        if (CHAVES_BLOQUEAR.includes(key) && key !== 'cart' && key !== 'horti_cart') {
            console.error(`üö´ ${SISTEMA}: Bloqueado cria√ß√£o de ${key}`);
            return;
        }
        
        if (key === 'cart') {
            console.log(`üîÄ ${SISTEMA}: cart ‚Üí ${CHAVE_CART}`, value);
            return originalSetItem(CHAVE_CART, value);
        }
        
        return originalSetItem(key, value);
    };
    
    // 6. FUN√á√ÉO saveCart GLOBAL - GARANTINDO QUE SALVA NA CHAVE CORRETA
    window.saveCart = function() {
        try {
            const dados = JSON.stringify(window.cart || []);
            localStorage.setItem(CHAVE_CART, dados); // Salva diretamente em horti2_cart
            console.log(`üíæ Carrinho salvo em ${CHAVE_CART}:`, window.cart.length, 'itens');
            
            // Atualizar contador
            if (typeof window.updateCartCount === 'function') {
                window.updateCartCount();
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå Erro ao salvar carrinho:', error);
            return false;
        }
    };
    
    // 7. VERIFICA√á√ÉO FINAL
    setTimeout(() => {
        console.log('üìã Verifica√ß√£o final:');
        
        const chaves = [];
        for (let i = 0; i < localStorage.length; i++) {
            chaves.push(localStorage.key(i));
        }
        
        const chavesCart = chaves.filter(k => k.includes('cart'));
        console.log('Chaves cart presentes:', chavesCart);
        
        const cartFinal = localStorage.getItem(CHAVE_CART);
        console.log('Carrinho salvo:', cartFinal ? JSON.parse(cartFinal).length + ' itens' : 'vazio');
        
        // DEBUG: Mostrar conte√∫do real
        console.log('Conte√∫do do carrinho:', window.cart);
    }, 2000);
})();
</script>

<style>
:root{
  --accent:#df4b10;
  --blue:#2d9cdb;
  --danger:#e74c3c;
  --card:#ffffff;
  --muted:#666;
}

body { font-family: Arial, sans-serif; margin:0; background:#f7f7f7; color:#222; }
header {
  background: linear-gradient(90deg, #f38a01, #00d170);
  color: white; padding:8px 14px; box-shadow:0 3px 8px rgba(0,0,0,0.08);
  position: sticky; top:0; z-index:1000; display:flex; gap:12px; align-items:center; justify-content:space-between;
}
#searchContainer{ display:flex; gap:10px; align-items:center; width:100%; max-width:1200px; margin:0 auto; }
#searchInput{ flex:1; max-width:360px; padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.12); }
#adminLink{ background:rgba(0,0,0,0.2); color:#fff; padding:6px 10px; border-radius:6px; text-decoration:none; font-weight:600; }
#btnOpenCart{ background:rgba(255,255,255,0.12); color:#fff; padding:6px 10px; border-radius:6px; border:0; cursor:pointer; font-weight:700; }
.page { padding:19px; max-width:1400px; margin:0 auto; }
.layout-coluna{ display:flex; flex-direction:column; gap:14px; align-items:center; }
.card{ background:var(--card); border-radius:10px; padding-top: 35px; width:103%; max-width:1390px; box-shadow:0 6px 18px rgba(0,0,0,0.04); position:relative; }
.products{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
.product{ width:180px; background:#fafafa; border:1px solid #eee; border-radius:8px; padding:8px; text-align:center; display:flex; flex-direction:column; gap:8px; }

/*------------------------------------------------------------------------------------*/

/* Ajuste de largura dos cards no celular */
@media (max-width: 600px) {
  .product {
    width: 90%;
    margin: 10px auto;
    display: block;
  }

  .product img {
    width: 90% !important;         /* Reduz para 90% para caber inteira */
    height: auto !important;       /* Altura proporcional */
    max-height: 200px !important;  /* Limita altura m√°xima */
    object-fit: contain !important; /* MOSTRA INTEIRA */
    display: block;
    margin: 0 auto;                /* Centraliza */
    padding: 5px;
   }

 /*-------------------------------------------------------------------------------------*/ 

  .product .controls input,
  .product .controls select,
  .product .controls button {
    width: 100%;         /* campos e bot√£o ocupam largura total */
    margin-top: 6px;
  }
}

.product img{ width:80%; height:105px; object-fit:cover; border-radius:6px; }
.product .meta{ flex:1; font-size:13px; color:var(--muted); }
.product .price{ font-weight:700; font-size:14px; }
.product .controls{ display:flex; gap:6px; align-items:center; justify-content:center; flex-direction:column; }
.product select, .product input[type="number"]{ width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
.btn{ border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
.btn-add{ background:var(--accent); color:#fff; width:100%; }
.cart-items{ display:flex; flex-direction:column; gap:10px; margin-top:8px; max-height:48vh; overflow:auto; padding-right:6px; }
.cart-item{ display:flex; gap:10px; align-items:center; background:#f8f8f8; padding:8px; border-radius:8px; }
.cart-item img{ width:64px; height:64px; object-fit:contain !important; border-radius:6px; }
.cart-item .info{ flex:1; font-size:14px; }
.cart-item .info small{ display:block; color:var(--muted); font-size:12px; }
.remove-btn{ background:var(--danger); color:rgb(255, 255, 255); border:0; padding:6px 8px; border-radius:6px; cursor:pointer; }
.cart-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
.total{ text-align:right; font-weight:700; font-size:18px; margin-top:8px; }
.pix-area{ text-align:center; margin-top:12px; }
.small{ color:var(--muted); font-size:13px; }
.pix-copy-actions{ display:flex; gap:8px; margin-top:8px; justify-content:center; }

.client-form { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.client-form input, .client-form textarea { padding:8px; border-radius:6px; border:1px solid #ddd; width:100%; box-sizing:border-box; }
.client-form .col { flex:1; min-width:200px; }

.catalog-block {
  position:absolute;
  inset:0;
  background: rgba(255, 255, 255, 0.95);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  border-radius:10px;
  flex-direction:column;
  gap:8px;
  text-align:center;
  z-index:50;
}
.catalog-block .msg { font-weight:700; color:var(--danger); }

/* modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:flex-start; justify-content:center; padding:40px 12px; z-index: 10000 !important; }
.modal{ background:#fff; border-radius:10px; width:100%; max-width:900px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.25); max-height:85vh; overflow:auto; z-index:10001 !important; }
.admin-row{ display:flex; align-items:center; gap:12px; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0; }
.admin-row .meta{ flex:1; }
.admin-controls{ display:flex; gap:8px; }

@media (max-width:900px){
  .product{ width:48%; }
  header{ padding:10px; flex-direction:column; align-items:stretch; gap:8px; }
  #searchContainer{ max-width:100%; }
}

.btn-add.flash {
  animation: flashAnim 0.4s ease-out;
}

@keyframes flashAnim {
  0%   { transform: scale(1); }
  30%  { transform: scale(1.15); background:#4caf50; color:#fff; }
  100% { transform: scale(1); }
}

/* Aumentar largura dos cards no celular */
@media (max-width: 600px) {
  .product {
    width: 150% !important;
  }

  .product img {
    height: 160px; /* opcional: imagem maior */
  }
}
/*  bot√£o carrinho css */
#btnOpenCart {
  display: flex;
  align-items: center;
  gap: 6px;
}

#btnOpenCart .icon-cart {
  width: 20px;
  height: 20px;
}

/* CSS do badge (bolinha com n√∫mero)*/
#btnOpenCart {
  position: relative;
}

#cartCount {
  background: red;
  color: white;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 50%;
  position: absolute;
  top: -5px;
  right: -5px;
}

/* Pre√ßo antigo riscado no centro*/
  .old-price {
    text-decoration: line-through;
    color: #888;        /* cor mais apagada */
    font-size: 13px;    /* menor */
    margin-left: 6px;   /* um espacinho do pre√ßo atual */
  }
  .product {
    width: 230px; /* Mudei de 180px para 225px */
    background: linear-gradient(90deg, #18a57b, #059742, #ec9108) !important;
    border-radius: 10px;
    padding: 20px; /* Aumentei de 8px para 12px */
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 15px; /* Aumentei de 8px para 10px */
  
}
/* IMAGEM NO CATALOGO*/
  .product-img {
    width: 60%;          /* ajuste como quiser */
    height: 170px;
    object-fit: contain !important;  /* Mude de 'cover' para 'contain' */
    border-radius: 10px;
    display: block;
    margin: 0 auto;      /* CENTRALIZA */
  }

.info-area {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 5px 3px;
}

.price-box {
  display: flex;
  align-items: center;
  gap: 6px;
}

.current-price strong {
  font-size: 20px;
  color: #fcf804;
}

.old-price {
  font-size: 14px;
  color: #05f5e1;
  text-decoration: line-through;
}

.percent {
  background: #d32f2f;
  color: #fff;
  padding: 2px 6px;
  border-radius: 5px;
  font-size: 12px;
  font-weight: bold;
}

.name {
  font-size: 16px;
  font-weight: 600;
}

.desc {
  font-size: 13px;
  color: #f8f7f7;
}

/* carrinho desativado*/
.disabled {
  background:#999 !important;
  cursor:not-allowed !important;
  opacity:0.7;
}
.btn-add.disabled {
  background: #bbb !important;
  cursor: not-allowed !important;
}

/* CSS para bot√µes PIX */
.btn-disabled {
  background: #999 !important;
  cursor: not-allowed !important;
  opacity: 0.6;
}

/* ========================= */
/* CORRE√á√ïES PARA PAINEL ADMIN NO CELULAR */
/* ========================= */

@media (max-width: 600px) {
  /* Modal do admin - ajustes para caber na tela */
  .modal {
    padding: 12px !important;
    max-height: 90vh !important;
    margin: 10px !important;
    width: calc(100% - 20px) !important;
    overflow-x: hidden !important;
  }
  
  /* Conte√∫do do admin - organizar melhor */
  #adminProductsList {
    max-height: 45vh !important;
    padding-right: 3px !important;
  }
  
  /* Linhas dos produtos no admin - layout vertical */
  .admin-row {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 8px !important;
    padding: 12px 8px !important;
  }
  
  /* Imagem do produto no admin */
  .admin-row img {
    width: 70px !important;
    height: 70px !important;
  }
  
  /* Controles do produto no admin */
  .admin-controls {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
    width: 100% !important;
    gap: 5px !important;
    margin-top: 8px !important;
  }
  
  .admin-controls button {
    flex: 1 !important;
    min-width: 70px !important;
    padding: 8px !important;
    font-size: 12px !important;
  }
  
  /* Barra de ferramentas do admin */
  .modal div[style*="display: flex; flex-wrap: wrap; gap: 8px;"] {
    flex-direction: column !important;
  }
  
  .modal div[style*="display: flex; flex-wrap: wrap; gap: 8px;"] button {
    width: 100% !important;
    min-width: unset !important;
    margin-bottom: 5px !important;
  }
  
  /* Cabe√ßalho do modal admin */
  .modal div[style*="display: flex; justify-content: space-between;"] {
    flex-direction: column !important;
    gap: 10px !important;
    align-items: flex-start !important;
  }
  
  /* Bot√£o fechar do admin */
  #adminCloseBtn {
    width: 100% !important;
    margin-top: 10px !important;
  }
  
  /* Barra de pesquisa do admin */
  .modal input[placeholder*="Pesquisar produto"] {
    font-size: 14px !important;
    padding: 10px !important;
  }
  
  /* Modal backdrop */
  .modal-backdrop {
    padding: 5px !important;
    align-items: center !important;
  }
}

/* Ajustes adicionais para telas muito pequenas */
@media (max-width: 400px) {
  .admin-controls {
    flex-direction: column !important;
  }
  
  .admin-controls button {
    width: 100% !important;
  }
  
  .modal {
    padding: 8px !important;
  }
  
  /* Bot√µes do toolbar */
  .modal button {
    font-size: 13px !important;
    padding: 10px 8px !important;
  }
}

/* Melhorar scroll no mobile */
#adminProductsList {
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
}

/* Ajustar modal de senha no mobile */
@media (max-width: 600px) {
  div[style*="background: white; padding: 25px; border-radius: 10px;"] {
    padding: 15px !important;
    width: 95% !important;
    margin: 10px !important;
  }
  
  div[style*="background: white; padding: 25px; border-radius: 10px;"] input {
    padding: 10px !important;
    font-size: 14px !important;
  }
  
  div[style*="background: white; padding: 25px; border-radius: 10px;"] button {
    padding: 10px !important;
    font-size: 13px !important;
  }
}

/* ========================= */
/* ESTILOS PARA LOADING (OTIMIZA√á√ïES) */
/* ========================= */

/* Loading animation */
.loading-indicator {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Skeleton loading */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Skeleton loading para produtos */
.product-skeleton {
  width: 180px;
  background: #f5f5f5;
  border-radius: 8px;
  padding: 8px;
  margin: 5px;
}

.product-skeleton .img-skeleton {
  width: 100%;
  height: 120px;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 6px;
}

@media (max-width: 600px) {
  .product-skeleton {
    width: 90%;
    margin: 10px auto;
  }
}

/* ========================= */
/* BOT√ÉO DE RECUPERAR CARRINHO (NOVO) */
/* ========================= */

/* Bot√£o de recuperar carrinho */
.recover-btn {
  background: #27ae60 !important;
  color: white !important;
  border: none !important;
  padding: 10px 20px !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  margin-top: 10px !important;
  font-weight: bold !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
  width: 100% !important;
  transition: all 0.3s ease !important;
}

.recover-btn:hover {
  background: #219653 !important;
  transform: scale(1.02) !important;
}

/* Container para o bot√£o de recuperar */
.recover-container {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-top: 15px;
  border: 2px dashed #27ae60;
}

/*-----------------------------------------------------------------------------------------*/

/* CSS PARA CORRE√á√ÉO PARA FOTOS NO PAINEL ADMIN - MOSTRAR IMAGEM INTEIRA */
.admin-row img {
  width: 80px !important; /* Largura fixa */
  height: 80px !important; /* Altura fixa */
  object-fit: contain !important; /* MOSTRA A IMAGEM INTEIRA (n√£o corta) */
  border-radius: 8px;
  border: 1px solid #ddd;
  background-color: #f8f8f8;
  padding: 2px;
}

/* Para imagens que s√£o muito verticais ou horizontais */
.admin-row img {
  max-width: 100%;
  max-height: 100%;
}

/* Se quiser um visual diferente, voc√™ pode tentar estas alternativas: */

/* ALTERNATIVA 1: Altura autom√°tica, largura fixa */
.admin-row img.altura-auto {
  width: 80px !important;
  height: auto !important;
  max-height: 100px !important;
  object-fit: contain !important;
}

/* ALTERNATIVA 2: Tamanho maior com scroll se necess√°rio */
.admin-row img.tamanho-maior {
  width: 120px !important;
  height: 120px !important;
  object-fit: contain !important;
}

/* ALTERNATIVA 3: Fundo diferente para destacar */
.admin-row img.com-fundo {
  background: linear-gradient(45deg, #f8f8f8, #e8e8e8) !important;
  border: 1px solid #ccc !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/*--------------------------------------------------------------------------*/

/* =========================================== */
/* CABE√áALHO FIXO DEFINITIVO - GARANTIDO 100% */
/* =========================================== */

/* REMOVER QUALQUER POSITION ANTIGO DO HEADER */
header {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  z-index: 100 !important;
  box-sizing: border-box !important;
  margin: 0 !important;
  
  /* Mantenha suas cores originais */
  background: linear-gradient(90deg, #f38a01, #00d170) !important;
  color: white !important;
  padding: 8px 14px !important;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08) !important;
  display: flex !important;
  gap: 12px !important;
  align-items: center !important;
  justify-content: space-between !important;
}

/* AJUSTE DO BODY - ESSENCIAL! */
body {
  padding-top: 120px !important;
  margin: 0 !important;
  min-height: 100vh !important;
}

/* CORRE√á√ÉO DO CONTAINER DE PESQUISA */
#searchContainer {
  max-width: 1200px !important;
  margin: 0 auto !important;
  width: 100% !important;
}

/* =============================== */
/* AJUSTES RESPONSIVOS DEFINITIVOS */
/* =============================== */

/* Para telas m√©dias */
@media (max-width: 900px) {
  header {
    padding: 10px 15px !important;
    height: auto !important;
    min-height: 70px !important;
  }
  
  body {
    padding-top: 120px !important;
  }
}

/* Para celulares */
@media (max-width: 600px) {
  header {
    padding: 8px 12px !important;
    flex-wrap: wrap !important;
    min-height: 85px !important;
    gap: 8px !important;
  }
  
  body {
    padding-top: 150px !important;
  }
  
  #searchContainer {
    flex-wrap: wrap !important;
  }
  
  #searchInput {
    order: 2 !important;
    width: 100% !important;
    max-width: 100% !important;
    margin-top: 8px !important;
  }
}

/* Para telas muito pequenas */
@media (max-width: 400px) {
  body {
    padding-top: 160px !important;
  }
  
  header {
    min-height: 95px !important;
  }
}

/* GARANTIA EXTRA: FOR√áAR VISIBILIDADE */
header {
  visibility: visible !important;
  opacity: 1 !important;
  transform: none !important;
}

/* EVITAR QUE QUALQUER OUTRO ELEMENTO ESCONDA O HEADER */
* {
  box-sizing: border-box;
}

/* FIXAR BEM NO TOPO - SEM MARGENS */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
}

/*-------------------------------------------------------------------------------------------------*/

/* =========================================== */
/* SUB-MODAIS DO ADMIN (PIX, WHATSAPP, ESTOQUE) */
/* =========================================== */

/* Sub-modais abrem acima do modal principal */
.modal .modal-backdrop {
  z-index: 10050 !important;
  background: rgba(0, 0, 0, 0.8) !important;
}

.modal .modal {
  z-index: 10051 !important;
}

/* Popups de configura√ß√£o espec√≠ficos */
div[style*="background: white; padding: 20px"],
div[style*="background: white; padding: 25px"],
div[style*="position: fixed; inset: 0"],
div[style*="position: fixed; top: 0"] {
  z-index: 99999 !important;
}

/* Garantir que bot√µes sejam clic√°veis */
.admin-controls button,
.modal button,
.btn {
  position: relative !important;
  z-index: 100 !important;
}

/* Para celular: ajuste extra */
@media (max-width: 600px) {
  .modal .modal-backdrop {
    z-index: 100000 !important;
    padding-top: 100px !important;
  }
  
  .modal .modal {
    z-index: 100001 !important;
    max-height: 70vh !important;
  }
}

/*----------------------------------------------------------------------------------------------------*/

/* =========================================== */
/* MODAL DIN√ÇMICO DE REPOSI√á√ÉO DE ESTOQUE */
/* =========================================== */

/* Para QUALQUER div com estilo inline de popup */
div[style*="position: fixed"][style*="top: 50%"][style*="left: 50%"],
div[style*="position:fixed"][style*="top:50%"][style*="left:50%"],
div[style*="transform: translate(-50%, -50%)"],
div[style*="background: white"][style*="padding:"] {
  z-index: 99999 !important;
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  background: white !important;
  padding: 25px !important;
  border-radius: 12px !important;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
  min-width: 300px !important;
  max-width: 500px !important;
}

/* Overlay escuro atr√°s */
div[style*="position: fixed"][style*="inset: 0"],
div[style*="position:fixed"][style*="inset:0"],
div[style*="background: rgba(0,0,0"] {
  z-index: 99998 !important;
  background: rgba(0, 0, 0, 0.8) !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
}

/* Corre√ß√£o Bot√µes do cat√°logo para ficar abaixo do cabe√ßalho quando rolar a pagina */
.product .controls,
.btn-add,
.product button {
  position: relative !important;
  z-index: 10 !important; /* BAIXO - abaixo do cabe√ßalho (100) */
}
/*-----------------------------------------------------------------------------------------------------*/

/* ============================================== */
/* CORRE√á√ÉO Z-INDEX - BOT√ÉO "USAR MINHA LOCALIZA√á√ÉO" */
/* ============================================== */

/* Garantir que o header tenha MAIOR prioridade */
header {
  z-index: 99999 !important; /* Aumente bastante */
}

/* Reduzir z-index do bot√£o de localiza√ß√£o */
#btnUseLocation {
  z-index: 1 !important; /* Reduza drasticamente */
  position: relative !important; /* Mantenha relative, n√£o absolute/fixed */
}

/* Se o bot√£o tiver position: absolute ou fixed, corrija: */
#btnUseLocation {
  position: relative !important; /* Mude para relative */
  z-index: 1 !important;
}

/* Garantir que nenhum elemento dentro do carrinho sobreponha o header */
#cartCard * {
  z-index: auto !important;
  position: relative !important;
}

/* Container do bot√£o tamb√©m */
.client-form .col {
  z-index: 1 !important;
  position: relative !important;
}

/*-----------------------------------------------------------------------------------------*/

/* ================================================ */
/* CORRE√á√ÉO DEFINITIVA Z-INDEX - HIERARQUIA CORRETA */
/* ================================================ */
/* ================================================ */
/* PAINEL SOBREPOSTO AO CABE√áALHO (ESTILO MODERNO) */
/* ================================================ */

/* 1. CABE√áALHO COM z-index ALTO mas n√£o m√°ximo */
header {
  z-index: 990 !important; /* Alto, mas n√£o m√°ximo */
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  background: linear-gradient(90deg, #ec9108, #f5dd09, #0bb945) !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
}

/* 2. MODAL BACKDROP - COBRE TUDO INCLUINDO CABE√áALHO */
.modal-backdrop {
  z-index: 1000 !important; /* Acima do cabe√ßalho */
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0,0,0,0.7) !important;
  display: flex !important;
  align-items: flex-start !important; /* Alinha no topo */
  justify-content: center !important;
  padding-top: 40px !important; /* Come√ßa 40px abaixo do topo (sobrep√µe cabe√ßalho) */
}

/* 3. MODAL PRINCIPAL - SOBREP√ïE PARCIALMENTE O CABE√áALHO */
.modal {
  z-index: 1001 !important;
  position: relative !important;
  margin-top: -20px !important; /* Sobe 20px para sobrepor mais */
  border-radius: 15px 15px 10px 10px !important;
  border-top: 4px solid #2ecc71 !important;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
  animation: slideDown 0.3s ease-out !important;
  max-height: 85vh !important;
  overflow-y: auto !important;
}

/* 4. ANIMA√á√ÉO DE ENTRADA */
@keyframes slideDown {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* 5. BOT√ÉO FECHAR - DESTAQUE M√ÅXIMO */
#adminCloseBtn {
  z-index: 1002 !important;
  position: relative !important;
  background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
  border: 2px solid white !important;
  box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4), 0 0 0 2px rgba(46, 204, 113, 0.2) !important;
}

/* 6. CABE√áALHO DO MODAL - TRANSPARENTE PARA MOSTRAR O CABE√áALHO ATR√ÅS */
.modal > div:first-child {
  background: rgba(255, 255, 255, 0.95) !important;
  backdrop-filter: blur(10px) !important;
  border-bottom: 1px solid rgba(0,0,0,0.1) !important;
}

/* 7. OP√á√ÉO 2: CABE√áALHO SEMI-TRANSPARENTE (se quiser ver atrav√©s) */
.modal > div:first-child {
  background: linear-gradient(to bottom, rgba(255,255,255,0.98), rgba(255,255,255,0.92)) !important;
}

/* 8. AJUSTE PARA DISPOSITIVOS M√ìVEIS */
@media (max-width: 600px) {
  .modal-backdrop {
    padding-top: 30px !important; /* Menos sobreposi√ß√£o no mobile */
  }
  
  .modal {
    margin-top: -10px !important; /* Menos sobreposi√ß√£o no mobile */
    border-radius: 10px 10px 0 0 !important; /* Estilo mobile */
    max-height: 90vh !important;
  }
}

/* 9. REMOVER CONFLITOS DE Z-INDEX */
#searchContainer,
.user-info-area,
.icon-cart {
  z-index: auto !important;
  position: relative !important;
}

/* 10. EFEITO DE VIDRO (GLASS EFFECT) - OP√áIONAL */
.modal {
  background: rgba(255, 255, 255, 0.95) !important;
  backdrop-filter: blur(20px) !important;
  -webkit-backdrop-filter: blur(20px) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
}
/*------------------------------------------------------------------------------------------*/

/* ================================================ */
/* CORRE√á√ÉO Z-INDEX MODAIS DO MODO T√âCNICO */
/* ================================================ */

/* 1. PAINEL T√âCNICO COM z-index ALTO */
#painelTecnico {
  z-index: 20000 !important; /* Muito alto */
  position: fixed !important;
}

/* 2. MODAIS DO MODO T√âCNICO (backup, senhas, etc) - MAIS ALTO AINDA */
div[style*="position: fixed"][style*="background: rgba"],
div[style*="position: fixed"][style*="z-index: 1000000"],
div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"],
div[style*="position: fixed"][style*="background: rgba(0,0,0,0.8)"],
div[style*="position: fixed"][style*="background: rgba(0,0,0,0.7)"] {
  z-index: 30000 !important; /* MAIS ALTO que o painel t√©cnico */
}

/* 3. MODAL DE BACKUP ESPECIFICAMENTE */
div[style*="BACKUP COMPLETO CRIADO"],
div[style*="BACKUP & RESTAURA√á√ÉO"],
div[style*="ALTERAR SENHA"],
div[style*="SENHAS DO SISTEMA"],
div[style*="ACESSO MODO T√âCNICO"] {
  z-index: 30001 !important ;
}

/* 4. TODOS OS MODAIS COM FUNDO ESCURO */
div[style*="background: rgba(0,0,0,0."] {
  z-index: 30000 !important;
}

/* 5. CONTE√öDO DOS MODAIS (dentro do fundo escuro) */
div[style*="background: rgba(0,0,0,0."] > div {
  z-index: 30001 !important;
  position: relative !important;
}

/* 6. CORRE√á√ÉO PARA MODAIS DE SENHA */
div[style*="background: #2c3e50"][style*="padding: 25px"] {
  z-index: 30002 !important;
}

/* 7. BOT√ïES DENTRO DOS MODAIS */
div[style*="background: rgba(0,0,0,0."] button {
  z-index: 30003 !important;
  position: relative !important;
}

/* 8. GARANTIR QUE NADA FIQUE ATR√ÅS */
#painelTecnico * {
  z-index: auto !important;
}

/* 9. RESET COMPLETO PARA MODAIS DO SISTEMA */
.modal-backdrop {
  z-index: 40000 !important; /* Modais admin MAIS ALTOS que tudo */
}

.modal {
  z-index: 40001 !important;
}

/* 10. HIERARQUIA FINAL CORRETA */
* {
  z-index: auto !important;
}

header {
  z-index: 100 !important;
}

#painelTecnico {
  z-index: 20000 !important;
}

/* Modais do t√©cnico */
div[style*="position: fixed"][style*="background: rgba"] {
  z-index: 30000 !important;
}

/* Modais do admin */
.modal-backdrop {
  z-index: 40000 !important;
}

/*-------------------------------------------------------------------------------------------*/
</style>


</head>
<body>
<!-----------------------CABELHALHO CORRIGIDO----------------------------------------------->
<header style="padding: 5px; text-align: center; position: relative;">

  <!-- LOGO + NOME -->
  <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
    
    <!-- LOGO -->
    <img src="imagens/compras_verduras.png" 
         alt="Logo" 
         style="width: 40px; height: auto; border-radius: 8px;">
    
    
    <!-- NOME DA EMPRESA -->
    <h1 style="margin: 0; font-size: 18px; font-weight: bold;">
      HORTIFRUTI CLIENTE 2
    </h1>
  </div>

  <!-- √ÅREA DO USU√ÅRIO LOGADO -->
  <div id="userInfoArea" class="user-info-area" style="display: none;">
    <span id="userEmail" class="user-email">Carregando...</span>
    <button id="btnLogout" class="btn-logout">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </div>

  <!--------------------------------------------------------------------------------------------------->
  <!-- REDES SOCIAIS -->
    <div style="display: flex; gap: 15px; margin-top: 8px;">
      <!-- Instagram -->
      <a href="https://www.instagram.com/ta_na_mao_delivery/" 
         target="_blank"
         style="
           color: #e23326;
           text-decoration: none;
           display: flex;
           align-items: center;
           gap: 5px;
           font-weight: bold;
         ">
        <i class="fab fa-instagram" style="font-size: 20px;"></i>
        <span style="font-size: 14px;">Instagram</span>
      </a>
      
      <!-- Facebook -->
      <a href="https://www.facebook.com/DeliveryTNM" 
         target="_blank"
         style="
           color: #1877f2;
           text-decoration: none;
           display: flex;
           align-items: center;
           gap: 5px;
           font-weight: bold;
         ">
        <i class="fab fa-facebook" style="font-size: 20px;"></i>
        <span style="font-size: 14px;">Facebook</span>
      </a>
    </div>
  </div>
  <!------------------------------------------------------------------------------------------------->

  <!-- CAMPO DE PESQUISA -->
  <div id="searchContainer" style="margin-top: 12px; position: relative; z-index: 10;">
    <input id="searchInput" placeholder="üîç Pesquisar produtos..." />
    <button id="adminLink" style="
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      transition: all 0.3s ease;
    ">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" 
           alt="Admin"
           style="
               width: 30px;
               height: 30px;
               filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
               transition: all 0.3s ease;
           "
           onmouseover="this.style.transform='scale(1.2) rotate(5deg)';"
           onmouseout="this.style.transform='scale(1) rotate(0deg)';">
    </button>
    <button id="btnOpenCart">
      <img 
        src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" 
        alt="Carrinho" 
        class="icon-cart"
      >
      <span id="cartCount">0</span>
    </button>
  </div>


</header>
<!----------------------------------------------------------------------------------------------------->


<main class="page">
<div class="layout-coluna">

  <!-- Produtos / cat√°logo -->
  <div class="card" id="catalogCard">
    <h2 style="text-align:center;margin:0 0 8px 0;">Produtos</h2>
    <div id="productsList" class="products"></div>

    <!-- bloco mostrado quando vendas est√£o bloqueadas -->
    <div id="catalogBlocked" class="catalog-block" style="display:none;">
      <div class="msg">‚ö†Ô∏è As vendas est√£o temporariamente bloqueadas. Volte mais tarde.</div>
      <div class="small">No painel admin voc√™ pode alterar o status para liberar as vendas.</div>
    </div>
  </div>

  <!-- Carrinho -->
  <div class="card" id="cartCard" style="display:none;">
    <h2 style="text-align:center;margin:0 0 8px 0;">Or√ßamento</h2>

    <div class="client-form">
      

      <!-- WHATSAPP DA EMPRESA: -->
      <div class="whatsapp-info" style="
          background: linear-gradient(135deg, #25D366, #128C7E);
          color: white;
          padding: 12px 15px;
          border-radius: 8px;
          margin-bottom: 15px;
          text-align: center;
          box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2);
      ">
          <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px;">
              <div style="font-size: 20px;">üì±</div>
              <div style="text-align: left;">
                  <div style="font-size: 14px; font-weight: bold;">Pedidos pelo WhatsApp</div>
                  <div style="font-size: 18px; font-weight: 900;">(11) 99999-9999</div>
              </div>
          </div>
          <div style="font-size: 12px; opacity: 0.9;">
              ‚ö° Envie a lista de produtos e endere√ßo ‚Ä¢ üí¨ Respondemos r√°pido!
          </div>
      </div>
      <div class="col"><input id="clientName" placeholder="Nome"></div>
      <div class="col"><input id="clientPhone" placeholder="Telefone"></div>
      <div class="col" style="flex-basis:100%"><textarea id="clientAddress" rows="2" placeholder="Endere√ßo"></textarea></div>
      <div class="col" style="flex-basis:100%; display:flex; gap:8px; align-items:center;">
        <input id="clientLocation" placeholder="Localiza√ß√£o (link do Maps)" style="flex:1;">
        <button class="btn" style="background:var(--blue); color:#fff;" id="btnUseLocation">üìç Usar minha localiza√ß√£o</button>
      </div>
      <div class="col" style="flex-basis:100%;">
      <input id="clientTroco" placeholder="Precisa de troco? Para quanto?">
      </div>

      <!-- ADICIONE ESTE CAMPO AQUI ‚Üì‚Üì‚Üì -->
      <div class="col" style="flex-basis:100%; margin-top: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: #f0f8ff; padding: 10px; border-radius: 8px; border: 1px solid #3498db;">
              <input type="checkbox" id="retirarLocal" style="width: 20px; height: 20px;">
              <div>
                  <div style="font-weight: bold; color: #2c3e50;">üö∂ Retirar no local</div>
                  <div style="font-size: 13px; color: #666;">Marque esta op√ß√£o para evitar taxa de entrega</div>
              </div>
          </label>
      </div>

    </div>

    <div id="cartItems" class="cart-items">
      <div class="small">Nenhum item ainda.</div>
    </div>

    <div class="total" id="cartTotal">Total: R$ 0,00</div>

    <div class="cart-actions">
      <button class="btn" style="background:#e74c3c;color:#fff" onclick="limparCarrinho()">üóëÔ∏è Limpar carrinho</button>
      <button class="btn" style="background:#25d366;color:#fff" onclick="enviarWhats()">üì≤ Enviar pelo WhatsApp</button>
      <button class="btn" style="background:var(--blue);color:#fff" onclick="continuarComprando()">‚û°Ô∏è Continuar comprando</button>
    </div>

    <!-- AVISO SOBRE CART√ÉO DE CREDITO -->
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      ">
        <h4 style="color: #0070ba; margin: 10px 0 5px 0;">
          üí≥ Aceitamos Cart√£o!
        </h4>
        <div style="font-size: 12px; font-weight: bold; opacity: 0.9;">
           Para pagamento com cart√£o, informe pelo WhatsApp!
        </div>
      </div>

    <!-- PIX op√ß√£o 2 -->
    <div class="pix-area" id="pixArea">
      <h3 style="margin:12px 0 6px 0;">Pagamento PIX</h3>
      <div class="small">Chave PIX: <b id="pixKeyDisplay">--</b></div>
      <div style="margin-top:8px;">
        <textarea id="pixPayload" readonly rows="3" style="width:100%; margin-top:6px; padding:6px; border-radius:6px; border:1px solid #ddd;"></textarea>
        <button class="btn" id="btnCopyPayload" style="margin-top:6px; background:var(--blue); color:#fff;">üìã Copiar c√≥digo PIX</button>
      </div>
    </div>

  </div>
</div>
</main>

<script>

 // FIREBASE HORTIFRUTI 2
// =========================
// FIREBASE (compat) CONFIG
// =========================
const firebaseConfig = {
  apiKey: "AIzaSyBYkn_DB7yzt_KhMd49RxfIVgIleNZjhdQ",
  authDomain: "hortifruti-cliente-2.firebaseapp.com",
  projectId: "hortifruti-cliente-2",
  storageBucket: "hortifruti-cliente-2.firebasestorage.app",
  messagingSenderId: "955241592474",
  appId: "1:955241592474:web:83d8c2668c90306cead123"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

//------------------------------------------------------------------------------------------------

// =========================
// DEBUG - VERIFICAR PROBLEMA DO CARRINHO
// =========================

function debugCarrinho() {
    console.log('üîç DEBUG CARRINHO:');
    console.log('1. localStorage keys:', Object.keys(localStorage));
    console.log('2. horti2_cart:', localStorage.getItem('horti2_cart')); // MUDOU AQUI
    console.log('3. cart:', localStorage.getItem('cart'));
    console.log('4. window.cart:', window.cart);
    console.log('5. CHAVE_CART:', window.CHAVE_CART);
    console.log('6. Tamanho do carrinho:', window.cart?.length || 0);
    
    // Verificar se h√° itens no carrinho que n√£o est√£o sendo salvos
    if (window.cart && window.cart.length > 0) {
        const saved = localStorage.getItem('bebida_cart');
        if (!saved || saved === '[]') {
            console.error('‚ùå PROBLEMA DETECTADO: Carrinho na mem√≥ria mas n√£o salvo!');
            alert('‚ö†Ô∏è Problema detectado: carrinho n√£o est√° sendo salvo. Corrigindo automaticamente...');
            
            // Corrigir automaticamente
            localStorage.setItem('bebida_cart', JSON.stringify(window.cart));
            console.log('‚úÖ Carrinho corrigido manualmente');
        }
    }
}

// Executar debug ap√≥s 3 segundos da p√°gina carregar
setTimeout(debugCarrinho, 3000);

// Tamb√©m executar quando o carrinho for atualizado
const originalAddToCart = window.addToCart;
if (originalAddToCart) {
    window.addToCart = function(...args) {
        const result = originalAddToCart.apply(this, args);
        setTimeout(debugCarrinho, 500);
        return result;
    };
}

//-------------------------------------------------------------------------------------------------

// =========================
// SISTEMA DE EXIBI√á√ÉO DO USU√ÅRIO LOGADO
// =========================

// Atualizar exibi√ß√£o do usu√°rio
function atualizarExibicaoUsuario() {
    const userInfoArea = document.getElementById('userInfoArea');
    const userEmailSpan = document.getElementById('userEmail');
    const btnLogout = document.getElementById('btnLogout');
    
    if (!userInfoArea || !userEmailSpan) {
        console.error('Elementos do usu√°rio n√£o encontrados');
        return;
    }
    
    const user = auth.currentUser;
    
    if (user && user.email) {
        // Usu√°rio logado com email
        userInfoArea.style.display = 'flex';
        userEmailSpan.textContent = user.email;
        userInfoArea.classList.remove('logged-out');
        
        // Configurar bot√£o de logout
        if (btnLogout) {
            btnLogout.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                logoutAdmin();
            };
        }
        
        console.log('‚úÖ Usu√°rio logado:', user.email);
    } else if (user && user.isAnonymous) {
        // Usu√°rio an√¥nimo (sem email)
        userInfoArea.style.display = 'flex';
        userEmailSpan.textContent = 'Visitante';
        userInfoArea.classList.add('logged-out');
        
        // Mudar bot√£o para login
        if (btnLogout) {
            btnLogout.className = 'btn-login';
            btnLogout.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            btnLogout.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                renderAdminProducts();
            };
        }
    } else {
        // N√£o logado
        userInfoArea.style.display = 'none';
        console.log('üë§ Nenhum usu√°rio logado');
    }
}

// Sobrescrever a fun√ß√£o logoutAdmin existente para atualizar a interface
const originalLogoutAdmin = window.logoutAdmin;
window.logoutAdmin = async function() {
    try {
        console.log('üîí Realizando logout...');
        await auth.signOut();
        
        // Limpar estado admin
        window.adminAutenticado = false;
        
        // Limpar timeout da sess√£o
        if (window.adminSessaoTimeout) {
            clearTimeout(window.adminSessaoTimeout);
            window.adminSessaoTimeout = null;
        }
        
        // Fechar modal se estiver aberto
        document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());
        
        // Atualizar exibi√ß√£o do usu√°rio
        atualizarExibicaoUsuario();
        
        console.log('‚úÖ Logout realizado com sucesso!');
        alert('‚úÖ Logout realizado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro no logout:', error);
        alert('‚ùå Erro ao fazer logout: ' + error.message);
    }
};

// Monitorar mudan√ßas de autentica√ß√£o
auth.onAuthStateChanged((user) => {
    console.log('üîç Estado de autentica√ß√£o alterado:', user ? 'Logado' : 'Deslogado');
    
    if (user) {
        console.log('üë§ Detalhes do usu√°rio:', {
            uid: user.uid,
            email: user.email,
            isAnonymous: user.isAnonymous
        });
    }
    
    // Atualizar exibi√ß√£o sempre que o estado mudar
    atualizarExibicaoUsuario();
    
    // Verificar permiss√µes admin se estiver logado com email
    if (user && user.email) {
        db.collection('admin_access').doc(user.uid).get()
            .then(snap => {
                if (snap.exists && snap.data().active !== false) {
                    window.adminAutenticado = true;
                    console.log('‚úÖ Permiss√µes de admin confirmadas');
                } else {
                    window.adminAutenticado = false;
                    console.log('‚ö†Ô∏è Usu√°rio sem permiss√µes de admin');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao verificar permiss√µes:', error);
            });
    }
});

// Sobrescrever a fun√ß√£o renderAdminProducts para garantir que atualize a interface
const originalRenderAdminProducts = window.renderAdminProducts;
window.renderAdminProducts = async function() {
    try {
        console.log('üîÑ Abrindo painel admin...');
        
        // Se j√° estiver autenticado, abre direto
        if (window.adminAutenticado) {
            await renderAdminProductsContent();
            iniciarTimeoutAdmin();
            return;
        }
        
        // Se n√£o estiver autenticado, usar modal de login
        const loginResult = await showLoginModal();
        
        if (loginResult.success) {
            console.log('‚úÖ Login bem-sucedido:', loginResult.user.email);
            
            // Atualizar estado
            window.adminAutenticado = true;
            
            // Atualizar exibi√ß√£o do usu√°rio
            atualizarExibicaoUsuario();
            
            // Abrir painel
            await renderAdminProductsContent();
            iniciarTimeoutAdmin();
            
        } else {
            console.log('‚ùå Login cancelado ou falhou');
            // Atualizar exibi√ß√£o mesmo no cancelamento
            atualizarExibicaoUsuario();
        }
        
    } catch (error) {
        console.error('‚ùå Erro no renderAdminProducts:', error);
        // Atualizar exibi√ß√£o mesmo no erro
        atualizarExibicaoUsuario();
    }
};

//--------------------------------------------------------------------------------------------------

// =========================
// SISTEMA DE LOGGING INTELIGENTE (PR√â-PRODU√á√ÉO)
// =========================
(function() {
    'use strict';
    
    // Definir se estamos em desenvolvimento ou produ√ß√£o
    const EM_DESENVOLVIMENTO = 
        window.location.hostname === 'localhost' ||
        window.location.hostname === '127.0.0.1' ||
        window.location.hostname.includes('teste') ||
        window.location.hostname.includes('dev');
    
    // Sistema de logging inteligente
    window.Logger = {
        // Log normal (s√≥ mostra em desenvolvimento)
        log: function(...args) {
            if (EM_DESENVOLVIMENTO) {
                console.log('%c[LOG]', 'color: #3498db; font-weight: bold;', ...args);
            }
        },
        
        // Warning (sempre mostra, mas diferente)
        warn: function(...args) {
            if (EM_DESENVOLVIMENTO) {
                console.warn('%c[WARN]', 'color: #f39c12; font-weight: bold;', ...args);
            } else {
                console.warn('[Sistema]', ...args); // Vers√£o limpa para produ√ß√£o
            }
        },
        
        // Error (sempre mostra)
        error: function(...args) {
            console.error('%c[ERRO]', 'color: #e74c3c; font-weight: bold;', ...args);
        },
        
        // Info (s√≥ desenvolvimento)
        info: function(...args) {
            if (EM_DESENVOLVIMENTO) {
                console.info('%c[INFO]', 'color: #2ecc71; font-weight: bold;', ...args);
            }
        },
        
        // Seguran√ßa (sempre loga, mesmo em produ√ß√£o)
        seguranca: function(...args) {
            console.log('%c[SEG]', 'color: #9b59b6; font-weight: bold;', ...args);
        }
    };
    
    Logger.log('Sistema de logging carregado');
    Logger.log('Modo:', EM_DESENVOLVIMENTO ? 'Desenvolvimento' : 'Produ√ß√£o');
    
})();

// =========================
// =========================
// SISTEMA DE SEGURAN√áA DEFINITIVO - VERS√ÉO FORTIFICADA
// =========================
(function() {
    'use strict';
    
    console.log('üîê Sistema de seguran√ßa fortificado carregado');
    
    // 1. IDENTIFICA√á√ÉO DO AMBIENTE
    const EM_DESENVOLVIMENTO = window.location.hostname.includes('localhost') || 
                              window.location.hostname.includes('127.0.0.1');
    
    // 2. LISTA DE FUN√á√ïES QUE DEVEM SER TOTALMENTE BLOQUEADAS
    const funcoesBloqueadas = [
        'resetarSenhasPadrao',
        'limparCacheLocal', 
        'resetarSistema',
        'forceCloseButton',
        'renderAdminProducts'  // Adicionada para exigir autentica√ß√£o
    ];
    
    // 3. BLOQUEIO DEFINITIVO DE FUN√á√ïES
    funcoesBloqueadas.forEach(nomeFuncao => {
        // Se a fun√ß√£o existe, substituir por vers√£o bloqueada
        if (typeof window[nomeFuncao] === 'function') {
            const original = window[nomeFuncao];
            
            Object.defineProperty(window, nomeFuncao, {
                value: function(...args) {
                    // Para fun√ß√µes que exigem autentica√ß√£o
                    if (nomeFuncao === 'renderAdminProducts') {
                        // Se n√£o estiver autenticado, pedir senha
                        if (!window.adminAutenticado) {
                            console.warn('üîí Acesso a fun√ß√£o admin requer autentica√ß√£o');
                            return original.apply(this, args); // Deixa a fun√ß√£o original lidar
                        }
                    }
                    
                    return original.apply(this, args);
                },
                writable: false,       // N√£o pode ser sobrescrita
                configurable: false,   // N√£o pode ser reconfigurada
                enumerable: true
            });
            
            console.log(`üîí ${nomeFuncao}: protegida`);
        }
    });
    
    // 4. PROTE√á√ÉO AVAN√áADA DE VARI√ÅVEIS SENS√çVEIS
    const protegerVariavelAvancado = (nome, valorPadrao = null) => {
        let valorInterno = valorPadrao;
        let acessosSuspeitos = 0;
        const horaProtecao = Date.now();
        
        Object.defineProperty(window, nome, {
            get: function() {
                // Retornar valor mascara para dados sens√≠veis
                if (nome.includes('Pix') || nome.includes('Phone')) {
                    // Para dados sens√≠veis, retornar apenas √∫ltimos 4 d√≠gitos
                    return valorInterno ? '***' + String(valorInterno).slice(-4) : '***';
                }
                
                // ACESSO NORMAL (via c√≥digo do sistema)
                return valorInterno;
            },
            set: function(novoValor) {
                // Validar antes de atribuir
                if (nome.includes('Pix') || nome.includes('Phone')) {
                    if (typeof novoValor !== 'string') {
                        console.error(`‚ùå ${nome}: deve ser string`);
                        return;
                    }
                    
                    // Valida√ß√µes espec√≠ficas para chaves PIX
                    if (nome.includes('Pix')) {
                        const apenasNumeros = novoValor.replace(/\D/g, '');
                        if (apenasNumeros.length < 8) {
                            console.error(`‚ùå ${nome}: chave muito curta`);
                            return;
                        }
                    }
                }
                
                valorInterno = novoValor;
                Logger.info(`${nome}: valor atualizado`);
            },
            configurable: false,  // N√ÉO pode ser removida
            enumerable: true
        });
        
        console.log(`üõ°Ô∏è ${nome}: protegida (hora: ${horaProtecao})`);
    };
    
    // 5. APLICAR PROTE√á√ÉO IMEDIATA PARA VARI√ÅVEIS CR√çTICAS
    const protegerVariaveisCriticas = () => {
        // Vari√°veis que sempre devem existir
        const variaveisCriticas = [
            { nome: 'cart', valor: [] },
            { nome: 'rawPixPhone', valor: '' },
            { nome: 'sellerPhone', valor: '' },
            { nome: 'merchantName', valor: '' },
            { nome: 'merchantCity', valor: '' },
            { nome: 'adminAutenticado', valor: false }
        ];
        
        variaveisCriticas.forEach(v => {
            // Verificar se a propriedade j√° existe e √© configur√°vel
            const descritor = Object.getOwnPropertyDescriptor(window, v.nome);
            
            // Se N√ÉO existe ou √© configur√°vel (pode ser redefinida)
            if (!descritor || descritor.configurable) {
                // Se j√° existe, pegar o valor atual
                const valorAtual = window[v.nome];
                protegerVariavelAvancado(v.nome, valorAtual !== undefined ? valorAtual : v.valor);
            } else {
                // Se j√° est√° protegida e n√£o √© configur√°vel, apenas logar
                console.log(`üõ°Ô∏è ${v.nome}: j√° protegida (n√£o configur√°vel)`);
            }
        });
        
        // Proteger tamb√©m o db (Firebase) se existir
        if (typeof db !== 'undefined') {
            const descritorDB = Object.getOwnPropertyDescriptor(window, 'db');
            if (!descritorDB || descritorDB.configurable) {
                protegerVariavelAvancado('db', db);
            }
        }
    };
    
    // Aplicar prote√ß√£o IMEDIATAMENTE
    protegerVariaveisCriticas();
    
    // 6. MONITORAMENTO DE ACESSO AO FIREBASE
    if (typeof db !== 'undefined') {
        const originalCollection = db.collection;
        
        db.collection = function(collectionName) {
            const collectionRef = originalCollection.call(this, collectionName);
            
            // Interceptar opera√ß√µes sens√≠veis
            if (['config', 'logs_seguranca', 'usuarios', 'admin'].includes(collectionName)) {
                return new Proxy(collectionRef, {
                    get: function(target, prop) {
                        // Bloquear m√©todos de escrita se n√£o for admin
                        if (['add', 'set', 'update', 'delete'].includes(prop)) {
                            return function(...args) {
                                if (!window.adminAutenticado) {
                                    console.error(`üö´ Escrita em ${collectionName}.${prop}() bloqueada`);
                                    Logger.seguranca(`Tentativa de escrita n√£o autorizada: ${collectionName}.${prop}()`, {
                                        args: args,
                                        userAgent: navigator.userAgent
                                    });
                                    
                                    throw new Error(`Permiss√£o negada para ${collectionName}.${prop}()`);
                                }
                                
                                // Se for admin, permitir
                                return target[prop].apply(target, args);
                            };
                        }
                        
                        // Para leitura, logar acesso
                        if (['get', 'onSnapshot'].includes(prop)) {
                            return function(...args) {
                                Logger.seguranca(`Leitura de ${collectionName}.${prop}()`, {
                                    args: args,
                                    usuario: window.adminAutenticado ? 'admin' : 'anonimo'
                                });
                                
                                return target[prop].apply(target, args);
                            };
                        }
                        
                        return target[prop];
                    }
                });
            }
            
            return collectionRef;
        };
        
        console.log('üîí Prote√ß√£o Firebase ativada');
    }
    
    // 8. MENSAGEM DE AVISO NO CONSOLE
    const mensagemSeguranca = `
    ‚ö†Ô∏è SISTEMA PROTEGIDO ‚ö†Ô∏è
    
    Acesso administrativo restrito.
    
    Use:
    ‚Ä¢ renderAdminProducts() - Para abrir painel (requer senha)
    ‚Ä¢ ativarModoTecnico() - Para modo t√©cnico (senha exclusiva)
    `;
    
    console.log('%c' + mensagemSeguranca, 
        'color: #e74c3c; font-weight: bold; font-size: 14px; background: #fdf2f2; padding: 10px; border: 2px solid #e74c3c;');
    
})();
//---------------------------------------------------------------------------------------------------
// =========================
// BLOQUEIO DEFINITIVO DE FUN√á√ïES ADMIN
// =========================
(function() {
    'use strict';
    
    console.log('üîí Aplicando bloqueio definitivo de fun√ß√µes admin...');
    
    // Lista de fun√ß√µes que devem ser BLOQUEADAS via console
    const funcoesCriticas = [
        'resetarSenhasPadrao',
        'limparCacheLocal',
        'forceCloseButton',
        //'renderAdminProducts'  // Requer autentica√ß√£o
    ];
    
    funcoesCriticas.forEach(nomeFuncao => {
        if (typeof window[nomeFuncao] === 'function') {
            const original = window[nomeFuncao];
            
            // Substituir por vers√£o protegida
            window[nomeFuncao] = function(...args) {
                // Se for renderAdminProducts, verificar autentica√ß√£o
                if (nomeFuncao === 'renderAdminProducts') {
                    if (!window.adminAutenticado) {
                        // Deixa a fun√ß√£o original lidar com a autentica√ß√£o
                        return original.apply(this, args);
                    }
                }
                
                // Execu√ß√£o normal (via interface ou c√≥digo autorizado)
                return original.apply(this, args);
            };
            
            // Tornar n√£o-configur√°vel
            Object.defineProperty(window, nomeFuncao, {
                writable: false,
                configurable: false
            });
            
            console.log(`‚úÖ ${nomeFuncao}: protegida`);
        }
    });
    
    console.log('üîí Bloqueio de fun√ß√µes aplicado');
})();



// =========================
// MELHORIAS PARA MOBILE - PAINEL ADMIN
// =========================

// Fun√ß√£o para melhorar a experi√™ncia mobile no painel admin
function melhorarMobileAdmin() {
  // Ajustar altura do container de produtos
  const adminContainer = document.getElementById('adminProductsList');
  if (adminContainer && window.innerWidth <= 600) {
    adminContainer.style.maxHeight = 'calc(80vh - 250px)';
  }
  
  // Ajustar bot√µes para touch
  document.querySelectorAll('.admin-controls button').forEach(btn => {
    btn.style.minHeight = '44px'; // Tamanho m√≠nimo para toque
    btn.style.touchAction = 'manipulation';
  });
}

// =========================
// OTIMIZA√á√ïES DE DESEMPENHO - CARREGAMENTO MAIS R√ÅPIDO
// =========================

// Cache para produtos (evita m√∫ltiplas requisi√ß√µes desnecess√°rias)
let produtosCache = null;
let ultimoCarregamentoCache = null;
const CACHE_TIMEOUT = 30000; // 30 segundos

// =========================
// FUN√á√ÉO GLOBAL PARA FOR√áAR ATUALIZA√á√ÉO DO CAT√ÅLOGO
// =========================
window.forcarAtualizacaoCatalogo = function() {
  console.log('üîÑ For√ßando atualiza√ß√£o do cat√°logo...');
  
  // Invalidar cache
  produtosCache = null;
  ultimoCarregamentoCache = null;
  
  // Recarregar produtos
  if (typeof carregarProdutos === 'function') {
    carregarProdutos();
  }
  
  // Se estiver no modo admin, recarregar tamb√©m
  if (document.querySelector('.modal-backdrop')) {
    if (typeof renderAdminProductsContent === 'function') {
      renderAdminProductsContent();
    }
  }
  
  return '‚úÖ Cat√°logo atualizado!';
};

// Fun√ß√£o otimizada para carregar produtos
async function carregarProdutosOtimizado() {
  console.log('üîÑ Carregando produtos (vers√£o otimizada)...');
  
  // Mostrar loading imediato
  const container = document.getElementById('productsList');
  if (container) {
    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Carregando produtos...</div>';
  }
  
  // Verificar cache v√°lido
  const agora = Date.now();
  if (produtosCache && ultimoCarregamentoCache && 
      (agora - ultimoCarregamentoCache) < CACHE_TIMEOUT) {
    console.log('‚úÖ Usando cache de produtos');
    renderizarProdutosDoCache();
    return;
  }
  
  try {
    // Fazer login autom√°tico se n√£o estiver autenticado (n√£o bloquear)
    if (!auth.currentUser) {
      auth.signInAnonymously().catch(() => {
        console.log('‚ö†Ô∏è Autentica√ß√£o em segundo plano');
      });
    }
    
    // Verificar estoque pausado e vendas liberadas em paralelo
    const [estoqueSnap, cfgSnap] = await Promise.all([
      db.collection('config').doc('estoque').get(),
      db.collection('config').doc('controle').get()
    ]);
    
    const estoquePausado = estoqueSnap.exists ? estoqueSnap.data().pausado : false;
    const vendasLiberadas = cfgSnap.exists ? cfgSnap.data().vendasLiberadas : true;
    
    if (estoquePausado) {
      container.innerHTML = `
        <div class="catalog-block" style="display:flex;">
          <h2>‚è∏Ô∏è Estoque em Manuten√ß√£o</h2>
          <p>Estamos atualizando nosso estoque. Volte em breve!</p>
        </div>
      `;
      return;
    }
    
    if (!vendasLiberadas) {
      container.innerHTML = `
        <div class="catalog-block">
          <h2>‚ö†Ô∏è Vendas temporariamente indispon√≠veis</h2>
          <p>Retornaremos em breve!</p>
        </div>
      `;
      return;
    }
    
    // Carregar produtos com limite e cache
    console.time('üî• Carregamento produtos');
    const snap = await db.collection('produtos')
      .where('active', '==', true)
      .limit(50) // Limite para performance
      .get();
    
    console.timeEnd('üî• Carregamento produtos');
    
    // Atualizar cache
    produtosCache = [];
    snap.forEach(doc => {
      const p = doc.data();
      p._id = doc.id;
      produtosCache.push(p);
    });
    ultimoCarregamentoCache = Date.now();
    
    console.log(`‚úÖ ${produtosCache.length} produtos carregados no cache`);
    
    // Renderizar produtos
    renderizarProdutosDoCache();
    
  } catch (error) {
    console.error('‚ùå Erro ao carregar produtos:', error);
    if (container) {
      container.innerHTML = `
        <div class="catalog-block">
          <h2>‚ö†Ô∏è Erro ao carregar produtos</h2>
          <p>Tente recarregar a p√°gina</p>
          <button onclick="carregarProdutosOtimizado()" style="margin-top:10px; padding:8px 16px; background:#3498db; color:white; border:none; border-radius:5px;">
            Tentar novamente
          </button>
        </div>
      `;
    }
  }
}

// Fun√ß√£o para renderizar produtos do cache (mais r√°pida)
function renderizarProdutosDoCache() {
  console.log('üé® Renderizando produtos do cache...');
  
  if (!produtosCache || produtosCache.length === 0) {
    const container = document.getElementById('productsList');
    container.innerHTML = '<div class="small">Nenhum produto dispon√≠vel no momento.</div>';
    return;
  }
  
  const container = document.getElementById('productsList');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  // Limpar container
  container.innerHTML = '';
  
  let produtosFiltrados = 0;
  
  produtosCache.forEach(p => {
    if (!p.name.toLowerCase().includes(searchTerm)) return;
    produtosFiltrados++;
    
    const priceUnit = p.priceUnit != null ? Number(p.priceUnit) : null;
    const priceKg = p.priceKg != null ? Number(p.priceKg) : null;
    const precoTexto = priceUnit ?? priceKg ?? 0;
    
    // Encontrar quantidade no carrinho
    let cartQty = 0;
    const found = cart.find(item => item.id === p._id);
    if (found) cartQty = found.qty;
    
    const oldPrice = p.oldPrice ? Number(p.oldPrice) : null;
    const percent = oldPrice ? `-${((1 - (precoTexto / oldPrice)) * 100).toFixed(0)}%` : null;
    
    const card = document.createElement('div');
    card.className = 'product';
    card.setAttribute('data-id', p._id);
    
    // Template mantendo a estrutura original
    card.innerHTML = `
      <img src="${escapeHtml(p.img || 'https://via.placeholder.com/400x300?text=Sem+imagem')}" 
           class="product-img"
           loading="lazy">
      <div class="info-area">
        <div class="price-box">
          <div class="current-price">
            <strong>${formatBRL(precoTexto)}</strong>
          </div>
          ${oldPrice ? `<div class="old-price">${formatBRL(oldPrice)}</div>` : ""}
          ${percent ? `<div class="percent">${percent}</div>` : ""}
        </div>
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="desc">${escapeHtml(p.desc || '')}</div>
      </div>
      <div class="controls">
        <select id="mode_${p._id}">
          ${priceUnit ? '<option value="unit">Unidade</option>' : ''}
          ${priceKg ? '<option value="kg">Kg</option>' : ''}
        </select>
        <input id="qty_${p._id}" type="number" value="1" min="0.1" step="0.1">
        ${
          cartEnabled
        ? `<button class="btn btn-add" id="add_${p._id}" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 12px; position: relative;">
            <span style="font-size: 18px;">üõí</span>
            ${cartQty > 0 
              ? `<span style="background: white; color: #df4b10; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 18px;">
                    ${cartQty}
                  </span>`
              : `<span>Adicione</span>`
            }
          </button>`
        : `<button class="btn btn-disabled" disabled style="padding: 8px 12px;">
            ‚è∏Ô∏è Pausado
          </button>`
      }
        ${cartQty > 0 ? `<button class="btn btn-remove" id="rem_${p._id}">üóëÔ∏è</button>` : ""}
      </div>
      <div class="cart-status">
        ${cartQty > 0 ? `<strong>Item no carrinho:</strong> <strong>${cartQty}</strong>` : ""}
      </div>
    `;
    
    container.appendChild(card);
    
    // ADICIONAR EVENT LISTENERS COMO NA FUN√á√ÉO ORIGINAL
    const sel = document.getElementById(`mode_${p._id}`);
    const addBtn = document.getElementById(`add_${p._id}`);
    const qtyInput = document.getElementById(`qty_${p._id}`);
    const remBtn = document.getElementById(`rem_${p._id}`);
    
    if (!sel || sel.options.length === 0) {
      if (addBtn) {
        addBtn.disabled = true;
        addBtn.textContent = 'Sem pre√ßo';
        addBtn.style.opacity = 0.6;
      }
    }
    
    if (addBtn && cartEnabled) {
  // Adicionar event listener para adicionar ao carrinho
  addBtn.addEventListener('click', async function() {
    if (addBtn.disabled) return;
    
    const selectedMode = sel ? sel.value : (priceUnit != null ? 'unit' : 'kg');
    const qty = Number(qtyInput ? qtyInput.value : 1) || 1;
    const unitPrice = (selectedMode === 'kg') ? priceKg : priceUnit;
    
    if (unitPrice == null) {
      alert('Pre√ßo inv√°lido.');
      return;
    }
    
    try {
      const snapData = (await db.collection('produtos').doc(p._id).get()).data();
      const stock = snapData.stock ?? 0;
      
      if (qty > stock) {
        alert(`S√≥ temos ${stock} unidades dispon√≠veis.`);
        return;
      }
      
      addToCart({
        id: p._id,
        name: p.name || 'Produto',
        img: p.img,
        mode: selectedMode,
        qty,
        unitPrice: Number(unitPrice)
      });
      
      saveCart();
      
      // Efeito visual de confirma√ß√£o
      addBtn.classList.add('flash');
      setTimeout(() => addBtn.classList.remove('flash'), 400);
      
      // Atualizar apenas este card
      atualizarCardDoProduto(p._id);
      
    } catch (error) {
      alert('Erro ao verificar estoque: ' + error.message);
    }
  });
}
    
    if (remBtn) {
      // Adicionar event listener para remover do carrinho
      remBtn.addEventListener('click', function() {
        const item = cart.find(c => c.id === p._id);
        if (!item) return;
        
        const qtdRemover = prompt(`Voc√™ tem ${item.qty} no carrinho.\nQuantos deseja remover?`);
        if (!qtdRemover) return;
        
        const n = Number(qtdRemover);
        if (isNaN(n) || n <= 0) {
          alert("Quantidade inv√°lida.");
          return;
        }
        
        if (n >= item.qty) {
          cart = cart.filter(c => c.id !== p._id);
        } else {
          item.qty -= n;
        }
        
        saveCart();
        renderizarProdutosDoCache(); // Recarregar produtos para atualizar todos
        renderCart(); // Atualizar carrinho vis√≠vel
      });
    }
  });
  
  // Feedback visual
  if (produtosFiltrados === 0 && searchTerm) {
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">Nenhum produto encontrado para "${searchTerm}"</div>`;
  }
  
  console.log(`‚úÖ ${produtosFiltrados} produtos renderizados`);
}

// Fun√ß√£o para atualizar apenas um card (mais eficiente) - VERS√ÉO 100% CORRIGIDA
// Fun√ß√£o para atualizar apenas um card (mais eficiente) - VERS√ÉO CORRIGIDA 100%
function atualizarCardDoProduto(productId) {
  console.log(`üîÑ atualizarCardDoProduto chamado para: ${productId}`);
  
  const productElement = document.querySelector(`.product[data-id="${productId}"]`);
  if (!productElement) {
    console.log(`‚ùå Elemento do produto n√£o encontrado: ${productId}`);
    return;
  }
  
  // Encontrar quantidade atual no carrinho
  let cartQty = 0;
  const found = cart.find(item => item.id === productId);
  if (found) {
    cartQty = found.qty;
    console.log(`üì¶ Quantidade encontrada no carrinho: ${cartQty}`);
  }
  
  // üî•üî•üî• PARTE 1: ATUALIZAR O BOT√ÉO "ADICIONE" - ESSENCIAL!
  const addBtn = document.getElementById(`add_${productId}`);
  if (addBtn) {
    console.log(`üéØ Bot√£o encontrado: add_${productId}`);
    
    if (cartQty > 0) {
      // Se j√° tem no carrinho, mostrar quantidade com badge
      addBtn.innerHTML = `
        <span style="font-size: 18px;">üõí</span>
        <span style="background: white; color: #df4b10; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 18px;">
          ${cartQty}
        </span>
      `;
      console.log(`‚úÖ Bot√£o atualizado para mostrar: ${cartQty}`);
    } else {
      // Se n√£o tem, mostrar "Adicione"
      addBtn.innerHTML = `
        <span style="font-size: 18px;">üõí</span>
        <span>Adicione</span>
      `;
      console.log(`‚úÖ Bot√£o resetado para "Adicione"`);
    }
  } else {
    console.log(`‚ùå Bot√£o add_${productId} N√ÉO encontrado no DOM!`);
  }
  
  // PARTE 2: Atualizar status do carrinho (texto abaixo do bot√£o)
  const cartStatus = productElement.querySelector('.cart-status');
  if (cartStatus) {
    cartStatus.innerHTML = cartQty > 0 ? 
      `J√° no carrinho: <strong>${cartQty}</strong>` : '';
  }
  
  // PARTE 3: Adicionar/remover bot√£o de remover
  const removeBtn = document.getElementById(`rem_${productId}`);
  
  if (cartQty > 0 && !removeBtn) {
    const controlsDiv = productElement.querySelector('.controls');
    if (controlsDiv) {
      const newRemoveBtn = document.createElement('button');
      newRemoveBtn.className = 'btn btn-remove';
      newRemoveBtn.id = `rem_${productId}`;
      newRemoveBtn.textContent = 'üóëÔ∏è';
      
      newRemoveBtn.addEventListener('click', function() {
        const item = cart.find(c => c.id === productId);
        if (!item) return;
        
        const qtdRemover = prompt(`Voc√™ tem ${item.qty} no carrinho.\nQuantos deseja remover?`);
        if (!qtdRemover) return;
        
        const n = Number(qtdRemover);
        if (isNaN(n) || n <= 0) {
          alert("Quantidade inv√°lida.");
          return;
        }
        
        if (n >= item.qty) {
          cart = cart.filter(c => c.id !== productId);
        } else {
          item.qty -= n;
        }
        
        saveCart();
        renderizarProdutosDoCache();
        renderCart();
      });
      
      controlsDiv.appendChild(newRemoveBtn);
    }
  } else if (cartQty === 0 && removeBtn) {
    removeBtn.remove();
  }
  
  updateCartCount();
  console.log(`‚úÖ atualizarCardDoProduto conclu√≠do para: ${productId}`);
}
// =========================
// SUBSTITUIR A FUN√á√ÉO ORIGINAL PELA OTIMIZADA
// =========================

// Salvar refer√™ncia √† fun√ß√£o original
const carregarProdutosOriginal = window.carregarProdutos;

// Substituir pela vers√£o otimizada
window.carregarProdutos = carregarProdutosOtimizado;

// =========================
// FUN√á√ÉO PARA FOR√áAR RECARGA COMPLETA
// =========================

window.recarregarProdutosCompleto = async function() {
  console.log('üîÑ For√ßando recarga completa de produtos...');
  produtosCache = null;
  ultimoCarregamentoCache = null;
  await carregarProdutosOtimizado();
};

// =========================
// FUN√á√ÉO PARA MODAL DE SENHA COM ESTRELINHAS
// =========================
function criarModalSenha() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100002 !important;  // <-- AQUI EST√Å A CORRE√á√ÉO
            font-family: Arial, sans-serif;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
            <h3 style="color: #9b59b6; margin-top: 0; margin-bottom: 15px;">
                üîí Senha de Acesso PIX
            </h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Digite a senha de administrador para configurar o PIX:
            </p>
            <input type="password" id="senhaPixInput" 
                   placeholder="Digite a senha"
                   style="width: 100%; padding: 12px; 
                          border: 2px solid #ddd; 
                          border-radius: 5px; 
                          font-size: 16px;
                          margin-bottom: 20px;"
                   autofocus>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btnCancelarSenha" 
                        style="padding: 10px 20px; 
                               background: #95a5a6; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Cancelar
                </button>
                <button id="btnConfirmarSenha" 
                        style="padding: 10px 20px; 
                               background: #9b59b6; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Confirmar
                </button>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        const senhaInput = document.getElementById('senhaPixInput');
        const btnConfirmar = document.getElementById('btnConfirmarSenha');
        const btnCancelar = document.getElementById('btnCancelarSenha');
        
        senhaInput.focus();
        
        const removerModal = () => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        };
        
        btnConfirmar.onclick = () => {
            const senha = senhaInput.value;
            removerModal();
            resolve(senha);
        };
        
        btnCancelar.onclick = () => {
            removerModal();
            resolve(null);
        };
        
        senhaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnConfirmar.click();
            }
        });
        
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                btnCancelar.click();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                btnCancelar.click();
            }
        });
    });
}

// =========================
// FUN√á√ÉO PARA MODAL DE SENHA DO WHATSAPP
// =========================
function criarModalSenhaWhatsApp() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100002 !important;  // <-- AQUI EST√Å A CORRE√á√ÉO
            font-family: Arial, sans-serif;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
            <h3 style="color: #25D366; margin-top: 0; margin-bottom: 15px;">
                üîí Senha para Configurar WhatsApp
            </h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Digite a senha para configurar o WhatsApp:
            </p>
            <input type="password" id="senhaWhatsAppInput" 
                   placeholder="Digite a senha"
                   style="width: 100%; padding: 12px; 
                          border: 2px solid #ddd; 
                          border-radius: 5px; 
                          font-size: 16px;
                          margin-bottom: 20px;"
                   autofocus>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btnCancelarSenhaWhatsApp" 
                        style="padding: 10px 20px; 
                               background: #95a5a6; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Cancelar
                </button>
                <button id="btnConfirmarSenhaWhatsApp" 
                        style="padding: 10px 20px; 
                               background: #25D366; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Confirmar
                </button>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        const senhaInput = document.getElementById('senhaWhatsAppInput');
        const btnConfirmar = document.getElementById('btnConfirmarSenhaWhatsApp');
        const btnCancelar = document.getElementById('btnCancelarSenhaWhatsApp');
        
        senhaInput.focus();
        
        const removerModal = () => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        };
        
        btnConfirmar.onclick = () => {
            const senha = senhaInput.value;
            removerModal();
            resolve(senha);
        };
        
        btnCancelar.onclick = () => {
            removerModal();
            resolve(null);
        };
        
        senhaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnConfirmar.click();
            }
        });
        
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                btnCancelar.click();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                btnCancelar.click();
            }
        });
    });
}

//-------------------------------------------------------------------------------------------------------
// =========================
// FUN√á√ÉO PARA MODAL DE SENHA DA TAXA DE ENTREGA
// =========================
function criarModalSenhaTaxaEntrega() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100002 !important;
            font-family: Arial, sans-serif;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
            <h3 style="color: #d35400; margin-top: 0; margin-bottom: 15px;">
                üîí Senha para Configurar Taxa de Entrega
            </h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Digite a senha para configurar a taxa de entrega:
            </p>
            <input type="password" id="senhaTaxaEntregaInput" 
                   placeholder="Digite a senha"
                   style="width: 100%; padding: 12px; 
                          border: 2px solid #ddd; 
                          border-radius: 5px; 
                          font-size: 16px;
                          margin-bottom: 20px;"
                   autofocus>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btnCancelarSenhaTaxa" 
                        style="padding: 10px 20px; 
                               background: #95a5a6; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Cancelar
                </button>
                <button id="btnConfirmarSenhaTaxa" 
                        style="padding: 10px 20px; 
                               background: #d35400; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;">
                    Confirmar
                </button>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        const senhaInput = document.getElementById('senhaTaxaEntregaInput');
        const btnConfirmar = document.getElementById('btnConfirmarSenhaTaxa');
        const btnCancelar = document.getElementById('btnCancelarSenhaTaxa');
        
        senhaInput.focus();
        
        const removerModal = () => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        };
        
        btnConfirmar.onclick = () => {
            const senha = senhaInput.value;
            removerModal();
            resolve(senha);
        };
        
        btnCancelar.onclick = () => {
            removerModal();
            resolve(null);
        };
        
        senhaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnConfirmar.click();
            }
        });
        
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                btnCancelar.click();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                btnCancelar.click();
            }
        });
    });
}

//-------------------------------------------------------------------------------------------------------

// =========================
// SISTEMA DE LOGS DE SEGURAN√áA
// =========================
const sistemaLogs = {
    async registrar(tipo, dados) {
        try {
            const logEntry = {
                tipo,
                dados: this._sanitizarDados(dados),
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // Salvar no Firebase
            await db.collection('logs_seguranca').add(logEntry);
            
            // Console apenas em desenvolvimento
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log(`[LOG] ${tipo}:`, logEntry);
            }
            
        } catch (error) {
            console.error('Erro ao salvar log:', error);
        }
    },
    
    _sanitizarDados(dados) {
        // Remove dados sens√≠veis
        const sanitizado = { ...dados };
        
        // Mascarar senhas
        if (sanitizado.senha) sanitizado.senha = '***MASKED***';
        if (sanitizado.password) sanitizado.password = '***MASKED***';
        
        // Mascarar chaves PIX/CPF
        if (sanitizado.chave) {
            sanitizado.chave = '***' + sanitizado.chave.toString().slice(-4);
        }
        
        if (sanitizado.cpf) {
            sanitizado.cpf = '***.***.***-**';
        }
        
        return sanitizado;
    }
};

// =========================
// FUN√á√ïES DE SEGURAN√áA
// =========================
async function hashSenha(senha) {
    // Hash simples mas mais seguro que texto claro
    const encoder = new TextEncoder();
    const data = encoder.encode(senha + 'HORTI_SALT_SECRET'); // Sal adicionado
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return 'IP n√£o dispon√≠vel';
    }
}

// =========================
// VARI√ÅVEIS GLOBAIS
// =========================
//let cart = JSON.parse(localStorage.getItem('horti_cart') || '[]');
let cartEnabled = true;
let adminAutenticado = false;
let adminSessaoTimeout = null;

//---------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA CARREGAR TAXA DE ENTREGA
// =========================
async function carregarTaxaEntrega() {
    try {
        const snap = await db.collection('config').doc('entrega').get();
        if (snap.exists) {
            taxaEntrega = snap.data().taxa || 0;
            console.log('‚úÖ Taxa de entrega carregada:', taxaEntrega);
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è Taxa de entrega n√£o configurada');
    }
}

//---------------------------------------------------------------------------------------------------------

// =========================
// VARI√ÅVEIS PARA RECUPERA√á√ÉO DO CARRINHO (NOVO)
// =========================
let lastRemovedCart = null; // √öltimo carrinho removido
let removedCartTimestamp = null; // Quando foi removido
const CART_RECOVERY_TIMEOUT = 300000; // 5 minutos para recuperar (em milissegundos)

// Em vez disso, use esta verifica√ß√£o:
if (typeof window.cart === 'undefined') {
    window.cart = []; // Fallback apenas se n√£o foi inicializado pela prote√ß√£o
}

// =========================
// VARI√ÅVEIS PIX (AGORA CONFIGUR√ÅVEIS)
// =========================
let merchantName = ''; // Ser√° sobrescrito pelo Firebase
let merchantCity = ''; // Ser√° sobrescrito pelo Firebase
let rawPixPhone = '';
let sellerPhone = '';

// =========================
// FUN√á√ïES UTILIT√ÅRIAS - VERS√ÉO CORRIGIDA
// =========================

// Esta fun√ß√£o ser√° sobrescrita pelo sistema de prote√ß√£o, mas mantemos como fallback
if (typeof window.saveCart !== 'function') {
    window.saveCart = function() {
        try {
            // Usar a chave correta definida pelo sistema de prote√ß√£o
            const chaveCart = window.CHAVE_CART || 'horti2_cart';
            
            localStorage.setItem(chaveCart, JSON.stringify(window.cart || []));
            
            // Para compatibilidade, tamb√©m salvar em 'cart' se for diferente
            if (chaveCart !== 'cart') {
                localStorage.setItem('cart', JSON.stringify(window.cart || []));
            }
            
            console.log(`üíæ Carrinho salvo em ${chaveCart}:`, window.cart.length, 'itens');
            
            // Atualizar contador
            if (typeof window.updateCartCount === 'function') {
                window.updateCartCount();
            }
            
            // Atualizar PIX quando salvar carrinho
            setTimeout(() => {
                if (typeof window.atualizarPixDisplay === 'function') {
                    window.atualizarPixDisplay();
                }
            }, 100);
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar carrinho:', error);
            
            // Tentativa alternativa
            try {
                localStorage.setItem('horti2_cart', JSON.stringify(window.cart || []));
                console.log('üîÑ Carrinho salvo via fallback');
            } catch (e) {
                console.error('‚ùå Fallback tamb√©m falhou:', e);
            }
            
            return false;
        }
    };
}

//----------------------------------------------------------------------------------------------------------------
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
  function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency', currency:'BRL'}); }
  // MODIFIQUE ESTA FUN√á√ÉO ‚Üì‚Üì‚Üì (ADICIONE + taxaEntrega)
  function calcTotal(){ 
    try {
        // Se o carrinho estiver vazio, retorna 0 (n√£o cobra taxa)
        if (!cart || cart.length === 0) {
            return 0;
        }
        
        const subtotal = cart.reduce((s,it)=> s + (Number(it.unitPrice||0) * Number(it.qty||0)), 0);
        
        // Verificar se taxaEntrega est√° definida
        if (typeof taxaEntrega === 'undefined') {
            console.warn('‚ö†Ô∏è taxaEntrega n√£o definida, usando 0');
            return subtotal;
        }
        
        // Verificar se o cliente vai retirar no local
        const retirarLocalCheckbox = document.getElementById('retirarLocal');
        const retirarLocal = retirarLocalCheckbox ? retirarLocalCheckbox.checked : false;
        
        // Se retirar no local, n√£o cobra taxa
        if (retirarLocal) {
            return subtotal;
        }
        
        return subtotal + (taxaEntrega || 0);
        
    } catch (error) {
        console.error('‚ùå Erro em calcTotal:', error);
        return 0;
    }
}
  // ADICIONE ESTA NOVA FUN√á√ÉO AQUI ‚Üì‚Üì‚Üì (DEPOIS DE calcTotal)
  function calcSubtotal(){ 
    // Se o carrinho estiver vazio, retorna 0
    if (!cart || cart.length === 0) {
        return 0;
    }
    return cart.reduce((s,it)=> s + (Number(it.unitPrice||0) * Number(it.qty||0)), 0);
}

// =========================
// FUN√á√ïES PIX
// =========================
// FUN√á√ÉO CRC16 CORRIGIDA
function calcularCRC16(str) {
  let crc = 0xFFFF;
  
  for (let i = 0; i < str.length; i++) {
    crc ^= str.charCodeAt(i) << 8;
    
    for (let j = 0; j < 8; j++) {
      if (crc & 0x8000) {
        crc = (crc << 1) ^ 0x1021;
      } else {
        crc = crc << 1;
      }
      
      crc &= 0xFFFF;
    }
  }
  
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

// FUN√á√ÉO PIX CORRIGIDA
function buildPixEMV(chavePix, nomeRecebedor, cidadeRecebedor, valor) {
  chavePix = String(chavePix || '').trim();
  nomeRecebedor = String(nomeRecebedor || '').toUpperCase().substring(0, 25);
  cidadeRecebedor = String(cidadeRecebedor || '').toUpperCase().substring(0, 15);
  
  // Valida√ß√£o: se nome ou cidade estiverem vazios, usar valores gen√©ricos
  if (!nomeRecebedor || nomeRecebedor.trim() === '') {
    nomeRecebedor = 'LOJA';
  }
  
  if (!cidadeRecebedor || cidadeRecebedor.trim() === '') {
    cidadeRecebedor = 'CIDADE';
  }
  
  let valorStr = '';
  if (valor && Number(valor) > 0) {
    valorStr = Number(valor).toFixed(2);
  }
  
  const criarCampo = (id, valor) => {
    const strValor = String(valor);
    return id.toString().padStart(2, '0') + 
           strValor.length.toString().padStart(2, '0') + 
           strValor;
  };
  
  let payload = '';
  payload += criarCampo(0, '01');
  
  const gui = 'BR.GOV.BCB.PIX';
  const guiField = criarCampo(0, gui);
  const chaveField = criarCampo(1, chavePix);
  const mai = guiField + chaveField;
  payload += '26' + mai.length.toString().padStart(2, '0') + mai;
  
  payload += criarCampo(52, '0000');
  payload += criarCampo(53, '986');
  
  if (valorStr) {
    payload += criarCampo(54, valorStr);
  }
  
  payload += criarCampo(58, 'BR');
  payload += criarCampo(59, nomeRecebedor);
  payload += criarCampo(60, cidadeRecebedor);
  
  const txid = 'HORTI' + Date.now().toString().slice(-10);
  const txidField = criarCampo(5, txid);
  const addData = txidField;
  payload += '62' + addData.length.toString().padStart(2, '0') + addData;
  
  const dadosCRC = payload + '6304';
  const crc = calcularCRC16(dadosCRC);
  
  return dadosCRC + crc;
}

// =========================
// FUN√á√ÉO PARA CARREGAR CONFIGURA√á√ÉO DO PIX COMPLETA
// =========================
async function carregarConfigPix() {
  try {
    const pixSnap = await db.collection('config').doc('pix').get();
    
    if (pixSnap.exists) {
      const data = pixSnap.data();
      
      // Se tiver chave, usa ela
      if (data.chave) {
        rawPixPhone = data.chave;
        sellerPhone = data.chave;
      }
      
      // Se tiver nome configurado, usa ele
      if (data.nomeTitular) {
        merchantName = data.nomeTitular.toUpperCase();
      } else {
        merchantName = ''; // Deixa vazio se n√£o tiver configurado
      }
      
      // Se tiver cidade configurada, usa ela
      if (data.cidadeTitular) {
        merchantCity = data.cidadeTitular.toUpperCase();
      } else {
        merchantCity = ''; // Deixa vazio se n√£o tiver configurado
      }
      
      console.log('‚úÖ Config PIX carregada:', { 
        chave: rawPixPhone, 
        nome: merchantName, 
        cidade: merchantCity 
      });
      
      return data;
    } else {
      // Se n√£o existir, cria com valores VAZIOS (para for√ßar configura√ß√£o)
      await db.collection('config').doc('pix').set({ 
        chave: '',
        nomeTitular: '',
        cidadeTitular: '',
        criadoEm: new Date().toISOString()
      });
      
      rawPixPhone = '';
      sellerPhone = '';
      merchantName = '';
      merchantCity = '';
      
      return null;
    }
  } catch (error) {
    console.error('Erro ao carregar PIX:', error);
    return null;
  }
}

// =========================
// FUN√á√ÉO ATUALIZAR DISPLAY PIX
// =========================
function atualizarPixDisplay() {
  const keyDisplay = document.getElementById('pixKeyDisplay');
  if (keyDisplay) {
    keyDisplay.textContent = rawPixPhone || 'N√£o configurada';
  }
  
  try {
    // Garantir que taxaEntrega est√° definida
    if (typeof taxaEntrega === 'undefined') {
      taxaEntrega = 0;
    }
    
    const subtotal = calcSubtotal(); // <-- Usar subtotal para verificar
    
    const pixEl = document.getElementById('pixPayload');
    
    if (pixEl) {
      if (!rawPixPhone || rawPixPhone.trim() === '') {
        pixEl.value = '‚ö†Ô∏è Configure uma chave PIX no painel Admin';
      } else if (subtotal <= 0) { // <-- Verificar subtotal, n√£o total
        // Carrinho vazio - n√£o mostrar c√≥digo PIX
        pixEl.value = 'Adicione produtos ao carrinho para gerar c√≥digo PIX';
        
        // Limpar tamb√©m o bot√£o de copiar
        const btnCopy = document.getElementById('btnCopyPayload');
        if (btnCopy) {
          btnCopy.style.display = 'none';
        }
      } else {
        // S√≥ calcular total com taxa se tiver produtos
        const total = calcTotal();
        const pixCode = buildPixEMV(rawPixPhone, merchantName, merchantCity, total);
        pixEl.value = pixCode;
        
        // Mostrar bot√£o de copiar
        const btnCopy = document.getElementById('btnCopyPayload');
        if (btnCopy) {
          btnCopy.style.display = 'block';
        }
      }
    }
  } catch (error) {
    console.error('‚ùå Erro em atualizarPixDisplay:', error);
    const pixEl = document.getElementById('pixPayload');
    if (pixEl) {
      pixEl.value = 'Erro ao calcular total. Recarregue a p√°gina.';
    }
  }
}

// =========================
// CONFIGURAR BOT√ÉO COPIAR PIX - CORRE√á√ÉO
// =========================
function configurarBotaoCopiarPix() {
  const btnCopyPayload = document.getElementById('btnCopyPayload');
  
  if (btnCopyPayload) {
    // VERIFICA√á√ÉO NOVA: Se carrinho vazio, ocultar bot√£o
    const subtotal = calcSubtotal();
    
    // SEMPRE aplicar estilos de centraliza√ß√£o
    btnCopyPayload.style.display = 'block';
    btnCopyPayload.style.margin = '10px auto';
    btnCopyPayload.style.width = '80%';
    btnCopyPayload.style.maxWidth = '300px';
    btnCopyPayload.style.textAlign = 'center';
    
    if (subtotal <= 0) {
      btnCopyPayload.style.visibility = 'hidden'; // Usar visibility em vez de display
      btnCopyPayload.style.opacity = '0';
      btnCopyPayload.style.height = '0';
      btnCopyPayload.style.padding = '0';
      btnCopyPayload.style.margin = '0';
      return;
    } else {
      // Mostrar bot√£o com anima√ß√£o
      btnCopyPayload.style.visibility = 'visible';
      btnCopyPayload.style.opacity = '1';
      btnCopyPayload.style.height = 'auto';
      btnCopyPayload.style.padding = '8px 16px';
      btnCopyPayload.style.margin = '10px auto';
    }
    
    // Remover event listeners antigos para evitar duplica√ß√£o
    const novoBotao = btnCopyPayload.cloneNode(true);
    btnCopyPayload.parentNode.replaceChild(novoBotao, btnCopyPayload);
    
    // Configurar novo event listener
    document.getElementById('btnCopyPayload').addEventListener('click', async function() {
      const pixEl = document.getElementById('pixPayload');
      
      if (!pixEl || !pixEl.value || pixEl.value.includes('Configure') || pixEl.value.includes('Adicione')) {
        alert('‚ö†Ô∏è Gere um c√≥digo PIX v√°lido antes de copiar! Adicione produtos ao carrinho.');
        return;
      }
      
      try {
        // Copiar para √°rea de transfer√™ncia
        await navigator.clipboard.writeText(pixEl.value);
        
        // Feedback visual
        const originalText = this.textContent;
        this.textContent = '‚úÖ Copiado!';
        this.style.background = '#27ae60';
        
        // Restaurar ap√≥s 2 segundos
        setTimeout(() => {
          this.textContent = originalText;
          this.style.background = '';
        }, 2000);
        
        console.log('‚úÖ C√≥digo PIX copiado:', pixEl.value.substring(0, 50) + '...');
      } catch (error) {
        console.error('‚ùå Erro ao copiar:', error);
        
        // Fallback para m√©todo antigo
        pixEl.select();
        pixEl.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // Feedback visual alternativo
        this.textContent = 'üìã Copiado (m√©todo alternativo)';
        setTimeout(() => {
          this.textContent = 'üìã Copiar c√≥digo PIX';
        }, 2000);
      }
    });
    
    console.log('‚úÖ Bot√£o copiar PIX configurado');
  }
}

// Chamar a configura√ß√£o quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(configurarBotaoCopiarPix, 1000);
});

// Tamb√©m chamar quando o carrinho for exibido
const btnOpenCart = document.getElementById('btnOpenCart');
if (btnOpenCart) {
  btnOpenCart.addEventListener('click', function() {
    setTimeout(configurarBotaoCopiarPix, 500);
  });
}

// =========================
// INICIALIZAR PIX COMPLETO
// =========================
async function inicializarPix() {
  await carregarConfigPix();
  
  // Atualizar display
  document.getElementById('pixKeyDisplay').innerText = rawPixPhone || 'N√£o configurada';
  sellerPhone = rawPixPhone;
  
  // Atualizar payload se tiver produtos
  if (cart.length > 0) {
    atualizarPixDisplay();
  }
}

//---------------------------------------------------------------------------------------------------------------

// FUN√á√ÉO PARA CARREGAR TAXA DE ENTREGA
// =========================
async function carregarTaxaEntrega() {
    try {
        const snap = await db.collection('config').doc('entrega').get();
        
        if (snap.exists) {
            const data = snap.data();
            taxaEntrega = data.taxa || 0;
            console.log('‚úÖ Taxa de entrega carregada:', taxaEntrega);
        } else {
            // Se n√£o existir, cria com valor zero
            await db.collection('config').doc('entrega').set({ 
                taxa: 0,
                criadoEm: new Date().toISOString()
            });
            taxaEntrega = 0;
            console.log('‚ÑπÔ∏è Taxa de entrega n√£o configurada, usando 0');
        }
        
        return taxaEntrega;
        
    } catch (error) {
        console.error('Erro ao carregar taxa de entrega:', error);
        return 0;
    }
}


//---------------------------------------------------------------------------------------------------------------

// =========================
// CONTROLE DO CARRINHO - VERS√ÉO CORRIGIDA
// =========================
async function atualizarStatusCarrinhoUnificado() {
  try {
    const cartCfg = await db.collection("config").doc("cart").get();
    cartEnabled = cartCfg.exists ? cartCfg.data().enabled !== false : true;

    // Atualizar apenas os bot√µes, N√ÉO esconder o cat√°logo
    const icon = document.getElementById("btnOpenCart");
    if (icon) {
      if (cartEnabled) {
        icon.style.display = "flex";
        icon.style.opacity = "1";
        icon.style.cursor = "pointer";
      } else {
        icon.style.display = "flex"; // Mant√©m vis√≠vel
        icon.style.opacity = "0.5";
        icon.style.cursor = "not-allowed";
      }
    }
    
    // REMOVER ou COMENTAR esta parte que esconde o cat√°logo:
    const catalogBlocked = document.getElementById("catalogBlocked");
    if (catalogBlocked) catalogBlocked.style.display = "none"; // SEMPRE ESCONDIDO
    
    // Apenas esvaziar carrinho se estiver desativado
    if (!cartEnabled) {
      cart = [];
      localStorage.removeItem('cart');
      if (typeof renderCart === 'function') renderCart();
      if (typeof updateCartCount === 'function') updateCartCount();
    }
    
    // Recarregar produtos para atualizar bot√µes
    if (typeof carregarProdutos === 'function') {
      carregarProdutos();
    }
    
  } catch (err) {
    console.error('Erro ao atualizar status do carrinho:', err);
  }
}

// =========================
// FUN√á√ïES DO CARRINHO
// =========================
  async function addToCart(item) {
  if (!cartEnabled) {
    alert("O carrinho est√° desativado no momento.");
    return;
  }
  
  const snapData = (await db.collection('produtos').doc(item.id).get()).data();
  const stock = snapData.stock ?? 0;

  const idx = cart.findIndex(c => c.id === item.id && c.mode === item.mode);

  if (idx >= 0) {
    const novaQtd = cart[idx].qty + item.qty;

    if (novaQtd > stock) {
      alert(`Estoque insuficiente! Voc√™ j√° tem ${cart[idx].qty} no carrinho e s√≥ existem ${stock} unidades.`);
      return;
    }

    cart[idx].qty = novaQtd;
  } else {
    if (item.qty > stock) {
      alert(`S√≥ temos ${stock} unidades dispon√≠veis em estoque.`);
      return;
    }
    cart.push(item);
  }

  // üî•üî•üî• PRIMEIRO: Salvar o carrinho
  saveCart();
  
  // üî•üî•üî• SEGUNDO: Atualizar contador global
  updateCartCount();
  
  // üî•üî•üî• TERCEIRO: Atualizar o card ESPEC√çFICO (COM ATRASO PARA GARANTIR)
  setTimeout(() => {
    if (typeof atualizarCardDoProduto === 'function') {
      console.log(`üéØ Chamando atualizarCardDoProduto para: ${item.id}`);
      atualizarCardDoProduto(item.id);
    }
  }, 50); // Pequeno atraso para garantir que o DOM est√° pronto
  
  // üî•üî•üî• QUARTO: Atualizar o carrinho vis√≠vel (se estiver aberto)
  if (typeof renderCart === 'function') {
    renderCart();
  }
  
  // üî•üî•üî• QUINTO: Atualizar PIX
  if (typeof atualizarPixDisplay === 'function') {
    setTimeout(() => {
      atualizarPixDisplay();
    }, 100);
  }
  
  // üî•üî•üî• SEXTO: Feedback visual no bot√£o
  setTimeout(() => {
    const addBtn = document.getElementById(`add_${item.id}`);
    if (addBtn) {
      addBtn.classList.add('flash');
      setTimeout(() => addBtn.classList.remove('flash'), 400);
    }
  }, 100);
}
function updateCartCount() {
  try {
    const count = cart.reduce((total, item) => total + (item.qty || 0), 0);
    const badge = document.getElementById('cartCount');
    
    if (!badge) {
      console.warn(' Elemento cartCount n√£o encontrado');
      return;
    }
    
    badge.textContent = count;
    
    if (count > 0) {
      badge.style.display = "inline-flex";
      badge.style.backgroundColor = "red";
      badge.style.color = "white";
    } else {
      badge.style.display = "none";
    }
    
    console.log(' Contador atualizado:', count, 'itens');
  } catch (error) {
    console.error(' Erro ao atualizar contador do carrinho:', error);
  }
}

function renderCart() {
  // Esconder bot√£o de recupera√ß√£o se o carrinho tiver itens
  if (cart.length > 0) {
    const recoverContainer = document.getElementById('recoverCartContainer');
    if (recoverContainer) {
      recoverContainer.style.display = 'none';
    }
  } else {
    const recoverContainer = document.getElementById('recoverCartContainer');
    if (recoverContainer) {
      recoverContainer.style.display = 'block';
    }
  }
  
  const container = document.getElementById('cartItems');
  container.innerHTML = '';

  if (cart.length === 0) {
    container.innerHTML = '<div class="small">Nenhum item ainda.</div>';
  } else {
    cart.forEach(it => {
      const div = document.createElement('div');
      div.className = 'cart-item';

      div.innerHTML = `
        <img src="${escapeHtml(it.img)}" style="width:110px; height:80px; object-fit:cover;">
        <div class="info">
          <strong>${escapeHtml(it.name)}</strong>
          <small>${it.mode}</small>
          <small>Qtd: ${it.qty}</small>
          <small>Pre√ßo unit: ${formatBRL(it.unitPrice)}</small>
          <small>Total: ${formatBRL(it.unitPrice * it.qty)}</small>
        </div>
        <button class="remove-btn">Remover</button>
      `;

      div.querySelector('.remove-btn').addEventListener('click', () => {
        const qtd = prompt(`Voc√™ adicionou ${it.qty} unidades.\nQuantas deseja remover?`);
        if (!qtd) return;

        const n = Number(qtd);
        if (isNaN(n) || n <= 0) {
          alert("Quantidade inv√°lida.");
          return;
        }

        if (n >= it.qty) {
          cart = cart.filter(c => c !== it);
        } else {
          it.qty -= n;
        }

        saveCart();
        renderCart();
      });

      container.appendChild(div);
    });
  }

  updateCartCount();
  
  // Calcular totais
  const subtotal = calcSubtotal();
  const total = calcTotal();
  
  // Criar se√ß√£o de resumo de valores - S√ì SE TIVER PRODUTOS
  if (cart.length > 0) {
    const resumoDiv = document.createElement('div');
    resumoDiv.style.cssText = `
        margin-top: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        border-left: 5px solid #3498db;
    `;
    
    resumoDiv.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold; color: #2c3e50; border-bottom: 1px dashed #ddd; padding-bottom: 8px;">
            üìä RESUMO DO PEDIDO
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
            <span style="color: #555;">Subtotal dos produtos:</span>
            <span style="font-weight: 500;">${formatBRL(subtotal)}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
            <span style="color: #555;">Taxa de entrega:</span>
            <span style="font-weight: 500; color: ${taxaEntrega > 0 ? '#d35400' : '#27ae60'}">
                ${taxaEntrega > 0 ? formatBRL(taxaEntrega) : 'Gr√°tis'}
            </span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 2px solid #ddd; font-size: 18px;">
            <strong style="color: #2c3e50;">TOTAL A PAGAR:</strong>
            <strong style="color: #27ae60; font-size: 20px;">${formatBRL(total)}</strong>
        </div>
        
        ${taxaEntrega > 0 ? `
        <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d; text-align: center;">
            <i>Taxa de entrega aplicada a todos os pedidos</i>
        </div>
        ` : ''}
    `;
    
    // Adicionar ao container
    container.appendChild(resumoDiv);
    
    // Atualizar tamb√©m o elemento cartTotal (no topo do carrinho)
    document.getElementById('cartTotal').innerHTML = `
        <span style="color: #2c3e50;">Total:</span>
        <span style="color: #27ae60; font-weight: bold; font-size: 20px;">${formatBRL(total)}</span>
    `;
  } else {
    // Carrinho vazio
    document.getElementById('cartTotal').innerHTML = `
        <span style="color: #2c3e50;">Total:</span>
        <span style="color: #27ae60; font-weight: bold; font-size: 20px;">${formatBRL(0)}</span>
    `;
  }
  
  atualizarPixDisplay();
}

//----------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA ATUALIZAR TODOS OS BOT√ïES DO CARRINHO
// =========================
function atualizarTodosOsBotoesCarrinho() {
  console.log('üîÑ Atualizando TODOS os bot√µes do carrinho...');
  
  // 1. Resetar TODOS os bot√µes "Adicione"
  document.querySelectorAll('.btn-add').forEach(btn => {
    btn.innerHTML = `
      <span style="font-size: 18px;">üõí</span>
      <span>Adicione</span>
    `;
  });
  
  // 2. Remover TODOS os bot√µes "üóëÔ∏è Remover"
  document.querySelectorAll('.btn-remove').forEach(btn => {
    btn.remove();
  });
  
  // 3. Limpar TODOS os textos "J√° no carrinho"
  document.querySelectorAll('.cart-status').forEach(span => {
    span.innerHTML = '';
  });
  
  // 4. Para cada item que ainda existe no carrinho (se houver), atualizar
  cart.forEach(item => {
    const btn = document.getElementById(`add_${item.id}`);
    if (btn && item.qty > 0) {
      btn.innerHTML = `
        <span style="font-size: 18px;">üõí</span>
        <span style="background: white; color: #df4b10; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 18px;">
          ${item.qty}
        </span>
      `;
    }
  });
  
  console.log(`‚úÖ ${document.querySelectorAll('.btn-add').length} bot√µes atualizados`);
}

//----------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO LIMPAR CARRINHO COMPLETAMENTE (VERS√ÉO CORRIGIDA)
// =========================
function limparCarrinho() { 
  if (cart.length === 0) {
    alert('O carrinho j√° est√° vazio!');
    return;
  }
  
  if (confirm('Deseja limpar TODO o carrinho?\n\nTodos os itens ser√£o removidos.')) { 
    // Salvar o carrinho atual para poss√≠vel recupera√ß√£o
    lastRemovedCart = [...cart]; // Cria uma c√≥pia do carrinho
    removedCartTimestamp = Date.now(); // Marca o tempo da remo√ß√£o
    
    // Limpar o carrinho atual
    cart = []; 
    saveCart(); 
    renderCart(); 
    
    // üî•üî•üî• PARTE CR√çTICA: ATUALIZAR TODOS OS BOT√ïES DO CAT√ÅLOGO
    console.log('üîÑ Atualizando bot√µes do cat√°logo ap√≥s limpar carrinho...');
    
    // M√©todo 1: Usar fun√ß√£o de atualiza√ß√£o se existir
    if (typeof atualizarTodosOsBotoesCarrinho === 'function') {
      atualizarTodosOsBotoesCarrinho();
    }
    // M√©todo 2: Atualizar via fun√ß√£o existente
    else if (typeof atualizarCardDoProduto === 'function') {
      // Para cada produto que estava no carrinho antigo
      lastRemovedCart.forEach(item => {
        setTimeout(() => {
          atualizarCardDoProduto(item.id);
        }, 100);
      });
    }
    // M√©todo 3: For√ßar recarregamento completo
    else if (typeof renderizarProdutosDoCache === 'function') {
      setTimeout(() => {
        renderizarProdutosDoCache();
      }, 300);
    }
    // M√©todo 4: Atualizar manualmente todos os bot√µes
    else {
      setTimeout(() => {
        document.querySelectorAll('.btn-add').forEach(btn => {
          btn.innerHTML = `
            <span style="font-size: 18px;">üõí</span>
            <span>Adicione</span>
          `;
        });
        
        // Remover todos os bot√µes de remover
        document.querySelectorAll('.btn-remove').forEach(btn => {
          btn.remove();
        });
        
        console.log('‚úÖ Todos os bot√µes resetados manualmente');
      }, 200);
    }
    
    // Mostrar bot√£o de recupera√ß√£o
    showRecoverButton();
    
    // Remover automaticamente ap√≥s 5 minutos
    setTimeout(() => {
      if (lastRemovedCart && Date.now() - removedCartTimestamp > CART_RECOVERY_TIMEOUT) {
        lastRemovedCart = null;
        removedCartTimestamp = null;
        hideRecoverButton();
      }
    }, CART_RECOVERY_TIMEOUT);
    
    alert('‚úÖ Carrinho limpo com sucesso!\n\nOs itens podem ser recuperados em at√© 5 minutos.');
  } 
}

// =========================
// MOSTRAR BOT√ÉO DE RECUPERAR CARRINHO (NOVO)
// =========================
function showRecoverButton() {
  // Verificar se j√° existe o bot√£o
  const existingRecoverContainer = document.getElementById('recoverCartContainer');
  if (existingRecoverContainer) {
    existingRecoverContainer.remove();
  }
  
  if (!lastRemovedCart || lastRemovedCart.length === 0) return;
  
  const recoverContainer = document.createElement('div');
  recoverContainer.id = 'recoverCartContainer';
  recoverContainer.className = 'recover-container';
  
  const itemCount = lastRemovedCart.reduce((total, item) => total + (item.qty || 0), 0);
  const totalValue = lastRemovedCart.reduce((total, item) => total + (item.unitPrice * (item.qty || 0)), 0);
  
  recoverContainer.innerHTML = `
    <div style="margin-bottom: 10px;">
      <strong>üóëÔ∏è Carrinho removido!</strong><br>
      <small style="color: #666;">
        ${itemCount} itens ‚Ä¢ ${formatBRL(totalValue)} ‚Ä¢ 
        <span id="recoverTimer">Voc√™ tem 5 minutos para recuperar</span>
      </small>
    </div>
    <button class="recover-btn" id="recoverCartBtn">
      <i class="fas fa-history"></i> Recuperar Carrinho
    </button>
    <button class="btn" onclick="dismissRecoverButton()" 
            style="margin-top: 8px; background: #95a5a6; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px;">
      Descartar
    </button>
  `;
  
  // Adicionar ao final da √°rea do carrinho
  const cartCard = document.getElementById('cartCard');
  if (cartCard) {
    cartCard.appendChild(recoverContainer);
  }
  
  // Iniciar contador regressivo
  startRecoveryTimer();
  
  // Adicionar evento ao bot√£o de recuperar
  setTimeout(() => {
    const recoverBtn = document.getElementById('recoverCartBtn');
    if (recoverBtn) {
      recoverBtn.addEventListener('click', recoverLastCart);
    }
  }, 100);
}

// =========================
// ESCONDER BOT√ÉO DE RECUPERAR (NOVO)
// =========================
function hideRecoverButton() {
  const recoverContainer = document.getElementById('recoverCartContainer');
  if (recoverContainer) {
    recoverContainer.remove();
  }
}

// =========================
// DESCARTAR BOT√ÉO DE RECUPERA√á√ÉO (NOVO)
// =========================
function dismissRecoverButton() {
  if (confirm('Deseja descartar o carrinho removido? Esta a√ß√£o n√£o poder√° ser desfeita.')) {
    lastRemovedCart = null;
    removedCartTimestamp = null;
    hideRecoverButton();
  }
}

// =========================
// RECUPERAR √öLTIMO CARRINHO (NOVO)
// =========================
// =========================
// RECUPERAR √öLTIMO CARRINHO (NOVO) - VERS√ÉO CORRIGIDA
// =========================
function recoverLastCart() {
  if (!lastRemovedCart || lastRemovedCart.length === 0) {
    alert('Nenhum carrinho dispon√≠vel para recupera√ß√£o.');
    return;
  }
  
  // Verificar se o tempo de recupera√ß√£o expirou
  if (Date.now() - removedCartTimestamp > CART_RECOVERY_TIMEOUT) {
    alert('O tempo para recupera√ß√£o expirou (5 minutos). O carrinho foi descartado.');
    lastRemovedCart = null;
    removedCartTimestamp = null;
    hideRecoverButton();
    return;
  }
  
  // Restaurar o carrinho
  cart = [...lastRemovedCart]; // Restaura uma c√≥pia do carrinho salvo
  
  // Salvar no localStorage
  saveCart();
  
  // Atualizar a exibi√ß√£o do carrinho
  renderCart();
  
  // üî•üî•üî• ATUALIZAR TODOS OS BOT√ïES DO CAT√ÅLOGO
  console.log('üîÑ Atualizando cat√°logo ap√≥s recuperar carrinho...');
  
  if (typeof atualizarTodosOsBotoesCarrinho === 'function') {
    atualizarTodosOsBotoesCarrinho();
  } else if (typeof renderizarProdutosDoCache === 'function') {
    setTimeout(() => {
      renderizarProdutosDoCache();
    }, 300);
  }
  
  // Esconder o bot√£o de recupera√ß√£o
  lastRemovedCart = null;
  removedCartTimestamp = null;
  hideRecoverButton();
  
  // Mostrar confirma√ß√£o
  const itemCount = cart.reduce((total, item) => total + (item.qty || 0), 0);
  alert(`‚úÖ Carrinho recuperado com sucesso!\n\n${itemCount} itens foram restaurados.`);
}

// =========================
// INICIAR CONTADOR PARA RECUPERA√á√ÉO (NOVO)
// =========================
function startRecoveryTimer() {
  if (!removedCartTimestamp) return;
  
  const endTime = removedCartTimestamp + CART_RECOVERY_TIMEOUT;
  
  const updateTimer = () => {
    const now = Date.now();
    const timeLeft = endTime - now;
    
    if (timeLeft <= 0) {
      // Tempo expirado
      const timerElement = document.getElementById('recoverTimer');
      if (timerElement) {
        timerElement.textContent = 'Tempo esgotado!';
        timerElement.style.color = '#e74c3c';
      }
      
      // Remover dados
      lastRemovedCart = null;
      removedCartTimestamp = null;
      
      // Esconder bot√£o ap√≥s 2 segundos
      setTimeout(() => {
        hideRecoverButton();
      }, 2000);
      
      return;
    }
    
    const minutes = Math.floor(timeLeft / 60000);
    const seconds = Math.floor((timeLeft % 60000) / 1000);
    
    const timerElement = document.getElementById('recoverTimer');
    if (timerElement) {
      timerElement.textContent = `Recuperar em: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Mudar cor quando faltar 1 minuto
      if (timeLeft < 60000) {
        timerElement.style.color = '#e74c3c';
        timerElement.style.fontWeight = 'bold';
      }
    }
    
    // Continuar atualizando
    setTimeout(updateTimer, 1000);
  };
  
  // Iniciar contador
  updateTimer();
}

// =========================
// VERIFICAR SE LOCALIZA√á√ÉO EST√Å BLOQUEADA NO NAVEGADOR
// =========================
async function verificarPermissaoLocalizacao() {
  console.log(' Verificando permiss√£o de localiza√ß√£o...');
  
  // Verificar se o navegador suporta geolocation
  if (!navigator.geolocation) {
    console.log(' Navegador n√£o suporta geolocaliza√ß√£o');
    return { 
      permitido: false, 
      mensagem: 'Seu navegador n√£o suporta geolocaliza√ß√£o. Use um navegador moderno.' 
    };
  }
  
  try {
    // Verificar permiss√£o usando a API de Permissions
    if (navigator.permissions && navigator.permissions.query) {
      const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
      console.log('Status da permiss√£o:', permissionStatus.state);
      
      if (permissionStatus.state === 'denied') {
        return { 
          permitido: false, 
          mensagem: '‚ùå LOCALIZA√á√ÉO BLOQUEADA!\n\n' +
                   'O envio de pedidos est√° bloqueado porque:\n\n' +
                   '1. Seu navegador bloqueou o acesso √† localiza√ß√£o\n' +
                   '2. Clique no √≠cone üîí ao lado da URL\n' +
                   '3. Selecione "Permitir" em "Localiza√ß√£o"\n' +
                   '4. Recarregue a p√°gina e tente novamente'
        };
      }
      
      if (permissionStatus.state === 'prompt') {
        console.log(' Permiss√£o ainda n√£o solicitada');
        // Vamos testar tentando obter a localiza√ß√£o
      }
    }
    
    // Se a API de Permissions n√£o estiver dispon√≠vel, tentar obter localiza√ß√£o
    return new Promise((resolve) => {
      // Timeout r√°pido para detectar bloqueio
      const timeoutId = setTimeout(() => {
        console.log(' Timeout - localiza√ß√£o provavelmente bloqueada');
        resolve({ 
          permitido: false, 
          mensagem: '‚ùå ACESSO √Ä LOCALIZA√á√ÉO NEGADO!\n\n' +
                   'Para enviar pedidos, voc√™ precisa:\n\n' +
                   '1. Clicar no √≠cone de cadeado (üîí) na barra de endere√ßo\n' +
                   '2. Em "Localiza√ß√£o", selecionar "Permitir"\n' +
                   '3. Recarregar esta p√°gina (F5)\n' +
                   '4. Tentar enviar o pedido novamente'
        });
      }, 1000);
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // Sucesso - localiza√ß√£o permitida
          clearTimeout(timeoutId);
          console.log('‚úÖ Localiza√ß√£o permitida');
          resolve({ 
            permitido: true, 
            mensagem: 'Localiza√ß√£o permitida',
            coords: position.coords 
          });
        },
        (error) => {
          // Erro - localiza√ß√£o bloqueada ou negada
          clearTimeout(timeoutId);
          console.log(' Erro na localiza√ß√£o:', error.code, error.message);
          
          let mensagem = '';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              mensagem = '‚ùå PERMISS√ÉO DE LOCALIZA√á√ÉO NEGADA!\n\n' +
                        'Para enviar pedidos pelo WhatsApp:\n\n' +
                        'üì± NO CELULAR:\n' +
                        '‚Ä¢ Toque no √≠cone üîí ao lado da URL\n' +
                        '‚Ä¢ Toque em "Configura√ß√µes do site"\n' +
                        '‚Ä¢ Em "Localiza√ß√£o", selecione "Permitir"\n\n' +
                        'üíª NO COMPUTADOR:\n' +
                        '‚Ä¢ Clique no √≠cone de cadeado (üîí)\n' +
                        '‚Ä¢ Em "Localiza√ß√£o", mude para "Permitir"\n' +
                        '‚Ä¢ Recarregue a p√°gina (F5)';
              break;
              
            case error.POSITION_UNAVAILABLE:
              mensagem = 'üìç LOCALIZA√á√ÉO INDISPON√çVEL\n\n' +
                        'Ative o GPS do seu dispositivo e tente novamente.';
              break;
              
            case error.TIMEOUT:
              mensagem = '‚è∞ TEMPO ESGOTADO\n\n' +
                        'A localiza√ß√£o est√° demorando muito. Verifique se o GPS est√° ativado.';
              break;
              
            default:
              mensagem = '‚ö†Ô∏è ERRO NA LOCALIZA√á√ÉO\n\n' +
                        'N√£o foi poss√≠vel acessar sua localiza√ß√£o. Verifique as permiss√µes.';
          }
          
          resolve({ permitido: false, mensagem: mensagem });
        },
        {
          enableHighAccuracy: false,
          timeout: 3000, // 3 segundos m√°ximo
          maximumAge: 0
        }
      );
    });
    
  } catch (error) {
    console.error('Erro ao verificar permiss√£o:', error);
    return { 
      permitido: false, 
      mensagem: '‚ùå ERRO AO VERIFICAR LOCALIZA√á√ÉO\n\n' +
               'Recarregue a p√°gina e tente novamente.'
    };
  }
}
// =========================
// FUN√á√ÉO ENVIAR WHATSAPP - CORRIGIDA PARA ABRIR APP NATIVO
// =========================
async function enviarWhats() {
  console.log(' Iniciando envio para WhatsApp...');

   // ‚úÖ NOVO: VERIFICAR SE LOCALIZA√á√ÉO EST√Å BLOQUEADA
  console.log('üìç Verificando permiss√µes de localiza√ß√£o...');
  const permissaoLocalizacao = await verificarPermissaoLocalizacao();
  
  if (!permissaoLocalizacao.permitido) {
    // Mostrar mensagem detalhada de como desbloquear
    const tentarMesmoAssim = confirm(
      permissaoLocalizacao.mensagem + 
      '\n\n‚ö†Ô∏è SEM LOCALIZA√á√ÉO, O PEDIDO PODE N√ÉO SER ENVIADO!\n\n' +
      'Deseja tentar enviar mesmo assim?'
    );
    
    if (!tentarMesmoAssim) {
      console.log(' Envio cancelado: localiza√ß√£o bloqueada');
      return;
    }
    
    console.log(' Usu√°rio decidiu continuar mesmo com localiza√ß√£o bloqueada');
  } else {
    console.log('Localiza√ß√£o permitida, continuando...');
  }
  
  // Verifica√ß√£o do carrinho vazio (c√≥digo original)
  if (cart.length === 0) {
    alert('‚ùå Carrinho vazio! Adicione produtos antes de enviar.');
    return;
  }
  
  
  // üõë BLOQUEAR BOT√ÉO para evitar cliques duplos
  const btnWhats = document.querySelector('button[onclick="enviarWhats()"]');
  const originalText = btnWhats.textContent;
  btnWhats.textContent = '‚è≥ Preparando...';
  btnWhats.disabled = true;

  try {
    // ‚úÖ 1¬∫ PASSO: VERIFICAR SE O ESTOQUE EST√Å PAUSADO
    const estoqueSnap = await db.collection('config').doc('estoque').get();
    const estoquePausado = estoqueSnap.exists ? estoqueSnap.data().pausado : false;
    
    if (estoquePausado) {
      alert('‚è∏Ô∏è Estoque em manuten√ß√£o. Tente novamente mais tarde.');
      btnWhats.textContent = originalText;
      btnWhats.disabled = false;
      return;
    }

    // ‚úÖ 2¬∫ PASSO: VERIFICAR ESTOQUE DOS PRODUTOS (APENAS VERIFICA√á√ÉO)
    for (const item of cart) {
      const produtoRef = db.collection('produtos').doc(item.id);
      const snap = await produtoRef.get();
      
      if (!snap.exists) {
        alert(`‚ùå Produto "${item.name}" n√£o encontrado!`);
        btnWhats.textContent = originalText;
        btnWhats.disabled = false;
        return;
      }
      
      const produtoData = snap.data();
      const stockAtual = produtoData.stock || 0;
      
      if (item.qty > stockAtual) {
        alert(`‚ùå Estoque insuficiente:\n\n"${item.name}"\n‚Ä¢ Pedido: ${item.qty}\n‚Ä¢ Dispon√≠vel: ${stockAtual}`);
        btnWhats.textContent = originalText;
        btnWhats.disabled = false;
        return;
      }
    }

    // ‚úÖ 3¬∫ PASSO: BUSCAR N√öMERO DO WHATSAPP
    let numeroWhatsApp = '';
    try {
      const whatsSnap = await db.collection('config').doc('whatsapp').get();
      if (whatsSnap.exists && whatsSnap.data().numero) {
        numeroWhatsApp = whatsSnap.data().numero.replace(/\D/g, '');
        console.log('‚úÖ Usando n√∫mero do Firebase:', numeroWhatsApp);
      }
    } catch (error) {
      console.log('N√∫mero n√£o configurado');
    }

    // Verificar se tem n√∫mero configurado
    if (!numeroWhatsApp || numeroWhatsApp.trim() === '') {
      alert('‚ùå N√∫mero do WhatsApp n√£o configurado!\n\nConfigure no painel admin primeiro.');
      btnWhats.textContent = originalText;
      btnWhats.disabled = false;
      return;
    }

    // ‚úÖ VALIDAR TROCO ANTES DE CONTINUAR
    if (!validarTrocoCompleto()) {
      btnWhats.textContent = originalText;
      btnWhats.disabled = false;
      return;
    }

    // ‚úÖ 4¬∫ PASSO: MONTAR MENSAGEM
    const name = document.getElementById('clientName')?.value.trim() || 'N√£o informado';
    const phone = document.getElementById('clientPhone')?.value.trim() || 'N√£o informado';
    const address = document.getElementById('clientAddress')?.value.trim() || 'N√£o informado';
    const locationLink = document.getElementById('clientLocation')?.value.trim() || 'N√£o informado';
    let troco = document.getElementById('clientTroco')?.value.trim() || 'N√£o precisa de troco';

    let msg = '*üõí NOVO PEDIDO - DELIVERY HORTIFRUTI* üõí\n\n';
    msg += `*Cliente:* ${name}\n`;
    msg += `*Telefone:* ${phone}\n`;
    msg += `*Endere√ßo:* ${address}\n`;
    msg += `*Troco:* ${troco}\n\n`;
    
    if (locationLink && locationLink !== 'N√£o informado') {
      msg += `*Localiza√ß√£o:* ${locationLink}\n\n`;
    }
    
    msg += '*PRODUTOS:*\n';
    
// LISTAR TODOS OS PRODUTOS COM PRE√áOS E QUANTIDADES
cart.forEach((item, index) => {
    const totalItem = Number(item.unitPrice || 0) * Number(item.qty || 0);
    
    msg += `${index + 1}. ${item.name}\n`;
    msg += `   ‚Ä¢ Quantidade: ${item.qty} ${item.mode}\n`;
    msg += `   ‚Ä¢ Pre√ßo unit√°rio: ${formatBRL(item.unitPrice)}\n`;
    msg += `   ‚Ä¢ Subtotal: ${formatBRL(totalItem)}\n\n`;
});

    // Calcular subtotal e total com taxa
    const subtotalPedido = calcSubtotal();
    const totalFinal = calcTotal();

    msg += '*RESUMO DE VALORES:*\n';
    msg += `Subtotal: ${formatBRL(subtotalPedido)}\n`;

    // Verificar se retirar no local est√° marcado
    const retirarLocalCheckbox = document.getElementById('retirarLocal');
    const retirarLocal = retirarLocalCheckbox ? retirarLocalCheckbox.checked : false;

    if (taxaEntrega > 0 && !retirarLocal) {
        msg += `Taxa de entrega: ${formatBRL(taxaEntrega)}\n`;
    } else if (retirarLocal) {
        msg += `Taxa de entrega: üéâ Gr√°tis (Retirada no local)\n`;
    } else {
        msg += `Taxa de entrega: üéâ Gr√°tis!\n`;
    }

    msg += `*TOTAL FINAL: ${formatBRL(totalFinal)}*\n\n`;
    msg += `_üíñAgradecemos pela sua prefer√™ncia_\n`;
    msg += `_üõíseu pedido j√° est√° sendo providenciado_\n`;
    msg += `*Chave PIX:* ${rawPixPhone || 'N√£o configurada'}\n`;
    msg += `*Data:* ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`;


    // ‚úÖ 5¬∫ PASSO: CRIAR URL DO WHATSAPP
    const mensagemCodificada = encodeURIComponent(msg);
    const urlAPI = `https://api.whatsapp.com/send?phone=${numeroWhatsApp}&text=${mensagemCodificada}`;
    
    console.log(' URL WhatsApp gerada:', urlAPI);

    // ‚úÖ 6¬∫ PASSO: CONFIRMA√á√ÉO FINAL DO USU√ÅRIO (AGORA NO LUGAR CERTO!)
    const confirmacao = confirm(
      `üì± ENVIAR PEDIDO PARA WHATSAPP?\n\n` +
      `N√∫mero: ${numeroWhatsApp}\n` +
      `Subtotal: ${formatBRL(subtotalPedido)}\n` +
      `Taxa de entrega: ${formatBRL(taxaEntrega)}\n` +
      `Total final: ${formatBRL(totalFinal)}\n` +
      `Cliente: ${name}\n\n` +
      `Clique em OK para abrir o WhatsApp e enviar.\n` +
      `Clique em CANCELAR para voltar ao carrinho.`
    );
    
    // üî¥üî¥üî¥ AQUI EST√Å A CORRE√á√ÉO CR√çTICA:
    // S√ì REDUZIR ESTOQUE E LIMPAR CARRINHO SE O USU√ÅRIO CONFIRMAR
    
    if (confirmacao) {
      console.log(' Usu√°rio confirmou - processando pedido...');
      
      // ‚úÖ 7¬∫ PASSO: RESERVAR ESTOQUE (APENAS SE CONFIRMAR)
      for (const item of cart) {
        const produtoRef = db.collection('produtos').doc(item.id);
        const snap = await produtoRef.get();
        const produtoData = snap.data();
        const stockAtual = produtoData.stock || 0;
        
        await produtoRef.update({
          stock: stockAtual - item.qty,
          atualizadoEm: new Date().toISOString()
        });
      }

      // ‚úÖ 8¬∫ PASSO: LIMPAR CARRINHO (APENAS SE CONFIRMAR)
      cart = [];
      // N√£o permitir recupera√ß√£o ap√≥s envio
      lastRemovedCart = null;
      removedCartTimestamp = null;
      hideRecoverButton();
      saveCart();
      renderCart();
      carregarProdutos();

      // ‚úÖ 9¬∫ PASSO: ABRIR WHATSAPP
      console.log(' Abrindo WhatsApp...');
      try {
        window.open(urlAPI, '_blank', 'noopener,noreferrer');
      } catch (error) {
        console.log('Erro ao abrir WhatsApp Web:', error);
        window.location.href = urlAPI;
      }

      // ‚úÖ 10¬∫ PASSO: FEEDBACK DE SUCESSO
      setTimeout(() => {
        alert('‚úÖ Pedido enviado com sucesso!\n\n' +
              '‚Ä¢ Carrinho limpo\n' +
              '‚Ä¢ Estoque atualizado\n' +
              '‚Ä¢ WhatsApp aberto para envio\n\n' +
              'Agradecemos pelo pedido! üõí');
      }, 500);
      
    } else {
      // ‚ö†Ô∏è USU√ÅRIO CANCELOU - N√ÉO FAZER NADA COM ESTOQUE/CARRINHO
      console.log(' Usu√°rio cancelou o envio pelo WhatsApp');
      alert('‚ö†Ô∏è Envio cancelado.\n\nO carrinho permanece intacto.\n\nContinue comprando!');
      
      // Apenas reativa o bot√£o, mant√©m tudo como estava
      btnWhats.textContent = originalText;
      btnWhats.disabled = false;
    }

  } catch (error) {
    console.error('‚ùå Erro:', error);
    alert('‚ùå Erro ao processar pedido. Tente novamente.\n\nErro: ' + error.message);
  } finally {
    // ‚úÖ SEMPRE: Reativar bot√£o (com timeout de seguran√ßa)
    setTimeout(() => {
      if (btnWhats.disabled) {
        btnWhats.textContent = originalText;
        btnWhats.disabled = false;
      }
    }, 2000);
  }
}

//-----------------------------------------------------------------------------------------------

// =========================
// VALIDA√á√ÉO DO TROCO - VERS√ÉO CORRIGIDA DEFINITIVA
// =========================
function validarTrocoCompleto() {
  console.log('üîç [TROCO] Iniciando valida√ß√£o...');
  
  try {
    // Verificar se o campo existe
    const trocoInput = document.getElementById('clientTroco');
    
    if (!trocoInput) {
      console.error('‚ùå [TROCO] Campo n√£o encontrado');
      return true; // Permite continuar
    }
    
    const valorTrocoOriginal = trocoInput.value.trim();
    const totalCarrinho = calcTotal();
    
    console.log('üí∞ [TROCO] Dados:', {
      valor: valorTrocoOriginal,
      total: totalCarrinho,
      carrinhoItens: window.cart?.length || 0
    });
    
    // Se o carrinho est√° vazio, n√£o precisa validar troco
    if (totalCarrinho <= 0 || !window.cart || window.cart.length === 0) {
      console.log('‚úÖ [TROCO] Carrinho vazio - sem valida√ß√£o');
      return true;
    }
    
    // 1. VERIFICAR SE N√ÉO PRECISA DE TROCO - VERS√ÉO MELHORADA
    const valorLower = valorTrocoOriginal.toLowerCase();
    
    // Lista de palavras que indicam "sem troco" - APENAS TEXTOS, N√ÉO N√öMEROS
    const palavrasSemTroco = [
      'n√£o', 'nao', 'sem', 'zero',
      'n√£o precisa', 'nao precisa', 'sem troco',
      'n√£o quero', 'nao quero', 'n√£o preciso', 'nao preciso',
      'troco nao', 'troco n√£o', 'dispenso troco'
    ];
    
    // Verificar se √© EXATAMENTE "0" ou varia√ß√µes de zero
    const valorNumericoLimpo = valorTrocoOriginal.replace(/[^\d,\.]/g, '');
    const ehZero = ['0', '0.00', '0,00', '00', '00.00', '00,00'].some(zero => 
      valorNumericoLimpo === zero
    );
    
    // Verificar se cont√©m palavras de "sem troco" (apenas se n√£o for um n√∫mero)
    const contemPalavraSemTroco = palavrasSemTroco.some(palavra => {
      // Se for um n√∫mero (cont√©m d√≠gitos), ignorar esta verifica√ß√£o
      if (/\d/.test(valorLower)) return false;
      // S√≥ considerar se a palavra aparece como palavra completa
      const regex = new RegExp(`\\b${palavra}\\b`, 'i');
      return regex.test(valorTrocoOriginal);
    });
    
    if (ehZero || contemPalavraSemTroco) {
      console.log('‚úÖ [TROCO] Cliente n√£o precisa de troco');
      return true;
    }
    
    // Se estiver vazio
    if (!valorTrocoOriginal || /^\s*$/.test(valorTrocoOriginal)) {
      console.log('‚úÖ [TROCO] Campo vazio - sem troco');
      return true;
    }
    
    // 2. EXTRAIR N√öMERO DO TEXTO
    const match = valorTrocoOriginal.match(/(\d+[\.,]?\d*)/);
    if (!match) {
      console.log('‚úÖ [TROCO] Texto sem n√∫mero - sem troco');
      return true; // N√£o tem n√∫meros, pode ser texto livre
    }
    
    // Converter para n√∫mero
    const valorStr = match[0].replace(',', '.');
    const valorNumerico = parseFloat(valorStr);
    
    if (isNaN(valorNumerico) || valorNumerico <= 0) {
      console.log('‚úÖ [TROCO] N√£o √© n√∫mero v√°lido');
      return true;
    }
    
    console.log('üìä [TROCO] Compara√ß√£o:', {
      troco: valorNumerico,
      total: totalCarrinho,
      suficiente: valorNumerico >= totalCarrinho
    });
    
    // 3. VERIFICAR SE TROCO √â SUFICIENTE
    if (valorNumerico >= totalCarrinho) {
      console.log(`‚úÖ [TROCO] Troco suficiente: ${valorNumerico} >= ${totalCarrinho}`);
      return true;
    }
    
    // ‚ö†Ô∏è TROCO INSUFICIENTE - CORRE√á√ÉO NECESS√ÅRIA
    console.log(`‚ùå [TROCO] Troco insuficiente: ${valorNumerico} < ${totalCarrinho}`);
    
    // Usar alerta simples primeiro para teste
    const corrigir = confirm(
      `‚ùå TROCO INSUFICIENTE!\n\n` +
      `Voc√™ pediu troco para: R$ ${valorNumerico.toFixed(2)}\n` +
      `Total do pedido: R$ ${totalCarrinho.toFixed(2)}\n\n` +
      `O troco deve ser MAIOR ou IGUAL ao total.\n\n` +
      `Clique em OK para corrigir ou CANCELAR para voltar.`
    );
    
    if (!corrigir) {
      console.log('‚ùå [TROCO] Usu√°rio cancelou a corre√ß√£o');
      alert('‚ö†Ô∏è Volte ao carrinho para ajustar o troco.');
      trocoInput.focus();
      trocoInput.select();
      return false;
    }
    
    // Sistema de tentativas
    let tentativas = 3;
    let valorCorrente = valorNumerico;
    
    while (tentativas > 0) {
      const sugerido = totalCarrinho * 1.2; // 20% a mais
      
      const novoValorTexto = prompt(
        `üí∞ CORRIGIR VALOR DO TROCO\n\n` +
        `Total do pedido: R$ ${totalCarrinho.toFixed(2)}\n` +
        `Troco atual: R$ ${valorCorrente.toFixed(2)} (INSUFICIENTE)\n` +
        `Sugest√£o: R$ ${sugerido.toFixed(2)}\n` +
        `M√≠nimo: R$ ${totalCarrinho.toFixed(2)}\n\n` +
        `Tentativas restantes: ${tentativas}`,
        sugerido.toFixed(2)
      );
      
      if (novoValorTexto === null) {
        console.log('‚ùå [TROCO] Usu√°rio cancelou o prompt');
        return false;
      }
      
      // Converter novo valor
      const novoValorLimpo = novoValorTexto.replace(/[^\d,\.]/g, '').replace(',', '.');
      const novoValor = parseFloat(novoValorLimpo);
      
      if (isNaN(novoValor) || novoValor <= 0) {
        alert('‚ùå Valor inv√°lido! Digite um n√∫mero v√°lido.');
        tentativas--;
        continue;
      }
      
      if (novoValor >= totalCarrinho) {
        // ‚úÖ VALOR CORRETO
        trocoInput.value = `R$ ${novoValor.toFixed(2)}`;
        console.log('‚úÖ [TROCO] Troco corrigido para:', novoValor);
        
        alert(`‚úÖ TROCO CORRIGIDO!\n\nNovo valor: R$ ${novoValor.toFixed(2)}`);
        return true;
      }
      
      // ‚ùå Valor ainda insuficiente
      valorCorrente = novoValor;
      tentativas--;
      
      if (tentativas > 0) {
        const continuar = confirm(
          `‚ùå VALOR AINDA INSUFICIENTE!\n\n` +
          `Novo valor: R$ ${novoValor.toFixed(2)}\n` +
          `Total necess√°rio: R$ ${totalCarrinho.toFixed(2)}\n\n` +
          `Tentativas restantes: ${tentativas}\n\n` +
          `Deseja tentar novamente?`
        );
        
        if (!continuar) {
          console.log('‚ùå [TROCO] Usu√°rio desistiu das tentativas');
          return false;
        }
      }
    }
    
    // ESGOTOU TENTATIVAS
    alert(
      `‚ùå TENTATIVAS ESGOTADAS!\n\n` +
      `Voc√™ usou todas as 3 tentativas.\n\n` +
      `Digite "n√£o precisa" se n√£o quiser troco,\n` +
      `ou ajuste manualmente o valor.`
    );
    
    trocoInput.focus();
    trocoInput.select();
    return false;
    
  } catch (error) {
    console.error('‚ùå [TROCO] Erro na valida√ß√£o:', error);
    return true; // Em caso de erro, permite continuar
  }
}

//-------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO CONTINUAR COMPRANDO - CORRIGIDA
// =========================
function continuarComprando() {
  console.log(' Voltando para cat√°logo...');
  document.getElementById('cartCard').style.display = 'none';
  document.getElementById('catalogCard').style.display = 'block';
}

// =========================
// FUN√á√ÉO PARA INICIAR TIMEOUT DA SESS√ÉO (30 minutos)
// =========================
function iniciarTimeoutAdmin() {
  if (adminSessaoTimeout) {
    clearTimeout(adminSessaoTimeout);
  }
  
  adminSessaoTimeout = setTimeout(() => {
    adminAutenticado = false;
    alert('‚è∞ Sess√£o do admin expirada! Fa√ßa login novamente.');
  }, 5 * 60 * 1000); // 30 minutos
}

// =========================
// FUN√á√ÉO PARA VALIDA√á√ÉO INICIAL (APENAS UMA VEZ) - VERS√ÉO CORRIGIDA
// =========================
function askAdminPassword(callback) {
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.inset = '0';
  modal.style.background = 'rgba(0,0,0,0.7)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = 3000;

  const box = document.createElement('div');
  box.style.background = '#fff';
  box.style.padding = '25px';
  box.style.borderRadius = '12px';
  box.style.textAlign = 'center';
  box.style.width = '90%';
  box.style.maxWidth = '400px';
  
  // Usar template string corretamente
  box.innerHTML = `
    <h2 style="margin: 0 0 15px 0; color: #2c3e50;">üîê Acesso Administrativo</h2>
    <p style="color: #7f8c8d; margin-bottom: 20px;">
      Digite a senha para acessar o painel de controle
    </p>
    
    <input type="password" 
           id="adminPwdInput" 
           placeholder="Digite a senha de administrador"
           style="
             padding: 12px;
             width: 100%;
             border-radius: 8px;
             border: 2px solid #3498db;
             font-size: 16px;
             box-sizing: border-box;
             margin-bottom: 15px;
           "
           autocomplete="current-password">
    
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button id="adminCancelBtn" 
        style="
          background: #e74c3c;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          flex: 1;
        ">
        Cancelar
      </button>
      
      <button id="adminPwdBtn" 
        style="
          background: #27ae60;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          flex: 1;
        ">
        Entrar
      </button>
    </div>
    
    <div style="margin-top: 15px; color: #95a5a6; font-size: 12px;">
      ‚è∞ Sess√£o v√°lida por 30 minutos
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);

  // Focar no input
  const adminPwdInput = document.getElementById('adminPwdInput');
  if (adminPwdInput) {
    adminPwdInput.focus();
  }

  // Enter para submeter
  if (adminPwdInput) {
    adminPwdInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const adminPwdBtn = document.getElementById('adminPwdBtn');
        if (adminPwdBtn) adminPwdBtn.click();
      }
    });
  }

  // Bot√£o Cancelar
  const adminCancelBtn = document.getElementById('adminCancelBtn');
  if (adminCancelBtn) {
    adminCancelBtn.addEventListener('click', () => {
      modal.remove();
    });
  }

  // Bot√£o Entrar
  const adminPwdBtn = document.getElementById('adminPwdBtn');
  if (adminPwdBtn) {
    adminPwdBtn.addEventListener('click', async () => {
      const senhaDigitada = adminPwdInput ? adminPwdInput.value : '';
      
      if (!senhaDigitada.trim()) {
        alert('Digite a senha para continuar!');
        return;
      }
      
      // üîí CORRE√á√ÉO: Hash da senha digitada
      const senhaHash = await hashSenha(senhaDigitada);
      modal.remove();
      callback(senhaHash); // Envia o hash, n√£o a senha em texto claro
    });
  }
}


// =========================
// FUN√á√ÉO PARA VERIFICAR SENHA DO ADMINISTRADOR
// =========================
async function verificarSenhaAdmin(senhaHash) {
  try {
    const adminSnap = await db.collection('config').doc('admin').get();
    
    if (!adminSnap.exists) {
      // Se n√£o existir configura√ß√£o, solicitar ao usu√°rio
      const novaSenha = prompt(
        'üîê PRIMEIRO ACESSO - CONFIGURAR SENHA ADMIN\n\n' +
        'Este √© o primeiro acesso ao sistema.\n' +
        'Digite uma senha para o administrador:'
      );
      
      if (!novaSenha || novaSenha.trim() === '') {
        alert('‚ùå Senha √© obrigat√≥ria para primeiro acesso!');
        return false;
      }
      
      if (novaSenha.length < 4) {
        alert('‚ùå A senha deve ter pelo menos 4 caracteres!');
        return false;
      }
      
      const novaSenhaHash = await hashSenha(novaSenha);
      
      await db.collection('config').doc('admin').set({
        senha: novaSenhaHash,
        criadoEm: new Date().toISOString(),
        primeiroAcesso: true,
        criadoPor: 'sistema'
      });
      
      // Log da cria√ß√£o
      await sistemaLogs.registrar('admin_criado', {
        motivo: 'primeiro_acesso',
        ip: await getUserIP()
      });
      
      alert('‚úÖ Senha admin configurada com sucesso!\n\nGuarde esta senha em local seguro.');
      return senhaHash === novaSenhaHash;
    }
    
    const dadosAdmin = adminSnap.data();
    return senhaHash === dadosAdmin.senha;
    
  } catch (error) {
    console.error('Erro ao verificar senha admin:', error);
    return false;
  }
}

// =========================
// FUN√á√ÉO PARA VERIFICAR SENHA DO WHATSAPP (NOVA)
// =========================
async function verificarSenhaWhatsApp(senhaDigitada) {
  try {
    const whatsappSenhaSnap = await db.collection('config').doc('whatsapp_senha').get();
    
    if (!whatsappSenhaSnap.exists) {
      // Se n√£o existir, solicitar ao usu√°rio
      const novaSenhaWhatsApp = prompt(
        'üì± PRIMEIRA CONFIGURA√á√ÉO WHATSAPP\n\n' +
        'Digite uma senha para configurar o WhatsApp:\n' +
        '(Esta senha ser√° usada apenas para acessar configura√ß√µes do WhatsApp)'
      );
      
      if (!novaSenhaWhatsApp || novaSenhaWhatsApp.trim() === '') {
        alert('‚ùå Senha do WhatsApp √© obrigat√≥ria!');
        return false;
      }
      
      if (novaSenhaWhatsApp.length < 4) {
        alert('‚ùå A senha do WhatsApp deve ter pelo menos 4 caracteres!');
        return false;
      }
      
      const novaSenhaHash = await hashSenha(novaSenhaWhatsApp);
      
      await db.collection('config').doc('whatsapp_senha').set({
        hash: novaSenhaHash,
        criadoEm: new Date().toISOString(),
        primeiroAcesso: true
      });
      
      alert('‚úÖ Senha do WhatsApp configurada!\n\nGuarde esta senha em local seguro.');
      
      const senhaHashDigitada = await hashSenha(senhaDigitada);
      return senhaHashDigitada === novaSenhaHash;
    }
    
    const dadosWhatsAppSenha = whatsappSenhaSnap.data();
    const senhaHashDigitada = await hashSenha(senhaDigitada);
    return senhaHashDigitada === dadosWhatsAppSenha.hash;
    
  } catch (error) {
    console.error('Erro ao verificar senha WhatsApp:', error);
    return false;
  }
}

// =========================
// FUN√á√ÉO PARA VERIFICAR SENHA DO T√âCNICO (EXCLUSIVA) - NOVA
// =========================
async function verificarSenhaTecnico(senhaHash) {
  try {
    const tecnicoSnap = await db.collection('config').doc('tecnico_senha').get();
    
    if (!tecnicoSnap.exists) {
      // Se n√£o existir configura√ß√£o, criar com senha padr√£o
      const senhaPadrao = "tecnico123"; // Senha padr√£o inicial
      const senhaPadraoHash = await hashSenha(senhaPadrao);
      
      await db.collection('config').doc('tecnico_senha').set({
        senha: senhaPadraoHash,
        criadoEm: new Date().toISOString(),
        primeiroAcesso: true,
        tipo: "modo_tecnico",
        obs: "Altere esta senha ap√≥s o primeiro acesso"
      });
      
      // Log da cria√ß√£o
      await sistemaLogs.registrar('senha_tecnico_criada', {
        motivo: 'primeiro_acesso',
        senha_padrao: true,
        ip: await getUserIP()
      });
      
      console.log(' Senha do t√©cnico criada com padr√£o:', senhaPadrao);
      
      // Mostrar alerta com a senha padr√£o
      alert(
        'üîß PRIMEIRO ACESSO MODO T√âCNICO!\n\n' +
        'Senha padr√£o: ' + senhaPadrao + '\n\n' +
        '‚ö†Ô∏è RECOMENDA-SE ALTERAR AP√ìS O PRIMEIRO ACESSO!\n\n' +
        'Acesse o modo t√©cnico e use a op√ß√£o "Alterar Senha T√©cnico"'
      );
      
      return senhaHash === senhaPadraoHash;
    }
    
    const dadosTecnico = tecnicoSnap.data();
    return senhaHash === dadosTecnico.senha;
    
  } catch (error) {
    console.error('Erro ao verificar senha t√©cnico:', error);
    return false;
  }
}

// =========================
// FUN√á√ÉO PARA VERIFICAR SENHA DO PIX
// =========================
async function verificarSenhaPix(senhaDigitada) {
  try {
    const pixSenhaSnap = await db.collection('config').doc('pix_senha').get();
    
    if (!pixSenhaSnap.exists) {
      // Se n√£o existir, solicitar ao usu√°rio
      const novaSenhaPix = prompt(
        'üí∞ PRIMEIRA CONFIGURA√á√ÉO PIX\n\n' +
        'Digite uma senha para configurar o PIX:\n' +
        '(Esta senha ser√° usada apenas para acessar configura√ß√µes do PIX)'
      );
      
      if (!novaSenhaPix || novaSenhaPix.trim() === '') {
        alert('‚ùå Senha do PIX √© obrigat√≥ria!');
        return false;
      }
      
      if (novaSenhaPix.length < 6) {
        alert('‚ùå A senha do PIX deve ter pelo menos 6 caracteres!');
        return false;
      }
      
      const novaSenhaHash = await hashSenha(novaSenhaPix);
      
      await db.collection('config').doc('pix_senha').set({
        hash: novaSenhaHash,
        criadoEm: new Date().toISOString(),
        primeiroAcesso: true
      });
      
      alert('‚úÖ Senha do PIX configurada!\n\nGuarde esta senha em local seguro.');
      
      const senhaHashDigitada = await hashSenha(senhaDigitada);
      return senhaHashDigitada === novaSenhaHash;
    }
    
    const dadosPixSenha = pixSenhaSnap.data();
    const senhaHashDigitada = await hashSenha(senhaDigitada);
    return senhaHashDigitada === dadosPixSenha.hash;
    
  } catch (error) {
    console.error('Erro ao verificar senha PIX:', error);
    return false;
  }
}

//-------------------------------------------------------------------------------------------------------
// =========================
// FUN√á√ÉO PARA VERIFICAR SENHA DA TAXA DE ENTREGA
// =========================
async function verificarSenhaTaxaEntrega(senhaDigitada) {
    try {
        const taxaSenhaSnap = await db.collection('config').doc('taxa_entrega_senha').get();
        
        if (!taxaSenhaSnap.exists) {
            // Se n√£o existir, solicitar ao usu√°rio
            const novaSenhaTaxa = prompt(
                'üöö PRIMEIRA CONFIGURA√á√ÉO TAXA DE ENTREGA\n\n' +
                'Digite uma senha para configurar a taxa de entrega:\n' +
                '(Esta senha ser√° usada apenas para taxas de entrega)'
            );
            
            if (!novaSenhaTaxa || novaSenhaTaxa.trim() === '') {
                alert('‚ùå Senha da taxa de entrega √© obrigat√≥ria!');
                return false;
            }
            
            if (novaSenhaTaxa.length < 4) {
                alert('‚ùå A senha deve ter pelo menos 4 caracteres!');
                return false;
            }
            
            const novaSenhaHash = await hashSenha(novaSenhaTaxa);
            
            await db.collection('config').doc('taxa_entrega_senha').set({
                hash: novaSenhaHash,
                criadoEm: new Date().toISOString(),
                primeiroAcesso: true
            });
            
            alert('‚úÖ Senha da taxa de entrega configurada!\n\nGuarde esta senha em local seguro.');
            
            const senhaHashDigitada = await hashSenha(senhaDigitada);
            return senhaHashDigitada === novaSenhaHash;
        }
        
        const dadosTaxaSenha = taxaSenhaSnap.data();
        const senhaHashDigitada = await hashSenha(senhaDigitada);
        return senhaHashDigitada === dadosTaxaSenha.hash;
        
    } catch (error) {
        console.error('Erro ao verificar senha taxa entrega:', error);
        return false;
    }
}

//-------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA RESETAR SENHAS PADR√ÉO (MODIFICADA)
// =========================
window.resetarSenhasPadrao = async function() {
  console.log(' Resetando senhas...');
  
  if (!confirm('‚ö†Ô∏è RESETAR SENHAS?\n\n' +
              'Isso ir√°:\n' +
              '‚Ä¢ Solicitar nova senha para admin\n' +
              '‚Ä¢ Solicitar nova senha para PIX\n' +
              '‚Ä¢ Solicitar nova senha para WhatsApp\n' +
              '‚Ä¢ Solicitar nova senha para t√©cnico\n\n' +
              '‚Ä¢ Solicitar nova senha para taxa de entrega\n\n' + // <-- ADICIONE ESTA LINHA
              '‚ö†Ô∏è Use apenas se esquecer as senhas!\n\n' +
              'Continuar?')) {
    return;
  }
  
  try {
    // Solicitar nova senha admin
    const novaSenhaAdmin = prompt(
      'üîë NOVA SENHA ADMIN\n\n' +
      'Digite a nova senha para administrador:'
    );
    
    if (!novaSenhaAdmin || novaSenhaAdmin.length < 4) {
      alert('‚ùå Senha admin inv√°lida! M√≠nimo 4 caracteres.');
      return;
    }
    
    // Solicitar nova senha PIX
    const novaSenhaPix = prompt(
      'üí∞ NOVA SENHA PIX\n\n' +
      'Digite a nova senha para o PIX:'
    );
    
    if (!novaSenhaPix || novaSenhaPix.length < 6) {
      alert('‚ùå Senha PIX inv√°lida! M√≠nimo 6 caracteres.');
      return;
    }
    
    // Solicitar nova senha WhatsApp
    const novaSenhaWhatsApp = prompt(
      'üì± NOVA SENHA WHATSAPP\n\n' +
      'Digite a nova senha para o WhatsApp:'
    );
    
    if (!novaSenhaWhatsApp || novaSenhaWhatsApp.length < 4) {
      alert('‚ùå Senha WhatsApp inv√°lida! M√≠nimo 4 caracteres.');
      return;
    }
    
    // Solicitar nova senha T√âCNICO
    const novaSenhaTecnico = prompt(
      'üîß NOVA SENHA MODO T√âCNICO\n\n' +
      'Digite a nova senha para o modo t√©cnico:'
    );
    
    if (!novaSenhaTecnico || novaSenhaTecnico.length < 4) {
      alert('‚ùå Senha t√©cnico inv√°lida! M√≠nimo 4 caracteres.');
      return;
    }
    
    // Calcular hashes
    const senhaAdminHash = await hashSenha(novaSenhaAdmin);
    const senhaPixHash = await hashSenha(novaSenhaPix);
    const senhaWhatsAppHash = await hashSenha(novaSenhaWhatsApp);
    const senhaTecnicoHash = await hashSenha(novaSenhaTecnico);
    
    // Atualizar no Firebase
    await db.collection('config').doc('admin').set({
      senha: senhaAdminHash,
      resetadoEm: new Date().toISOString(),
      motivo: 'reset_manual'
    }, { merge: true });
    
    await db.collection('config').doc('pix_senha').set({
      hash: senhaPixHash,
      resetadoEm: new Date().toISOString(),
      motivo: 'reset_manual'
    }, { merge: true });
    
    await db.collection('config').doc('whatsapp_senha').set({
      hash: senhaWhatsAppHash,
      resetadoEm: new Date().toISOString(),
      motivo: 'reset_manual'
    }, { merge: true });
    
    await db.collection('config').doc('tecnico_senha').set({
      senha: senhaTecnicoHash,
      resetadoEm: new Date().toISOString(),
      motivo: 'reset_manual'
    }, { merge: true });
    
    // Log
    await sistemaLogs.registrar('senhas_resetadas', {
      tipo: 'manual',
      por: auth.currentUser?.uid,
      ip: await getUserIP()
    });
    
    alert(
      `‚úÖ SENHAS REDEFINIDAS!\n\n` +
      `üîë ADMINISTRADOR:\n` +
      `‚Ä¢ Nova senha: ${novaSenhaAdmin}\n\n` +
      `üí∞ PIX:\n` +
      `‚Ä¢ Nova senha: ${novaSenhaPix}\n\n` +
      `üì± WHATSAPP:\n` +
      `‚Ä¢ Nova senha: ${novaSenhaWhatsApp}\n\n` +
      `üîß T√âCNICO:\n` +
      `‚Ä¢ Nova senha: ${novaSenhaTecnico}\n\n` +
      `‚ö†Ô∏è Anote estas senhas em local seguro!`
    );
    
    console.log(' Senhas redefinidas');
    
  } catch (error) {
    console.error(' Erro ao resetar senhas:', error);
    alert('‚ùå Erro: ' + error.message);
  }
};

// =========================
// REMOVER QUALQUER REFER√äNCIA A SENHAS FIXAS
// =========================

// Substitua TODAS as ocorr√™ncias de senhas hardcoded:

// 1. Na fun√ß√£o inicializarSenhasSeguras (se existir):
async function inicializarSenhasSeguras() {
  // REMOVA qualquer cria√ß√£o autom√°tica de senhas
  console.log(' Sistema requer configura√ß√£o manual de senhas no primeiro acesso');
}

//-------------------------------------------------------------------------------------------------------

// =========================
// MODAL DE LOGIN FIREBASE
// =========================

function showLoginModal() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: Arial, sans-serif;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 20px;">
                üîê Login Administrativo
            </h3>
            
            <div id="loginError" style="
                display: none;
                background: #fee;
                color: #c0392b;
                padding: 10px;
                border-radius: 6px;
                margin-bottom: 15px;
                font-size: 14px;
            ">
                Credenciais inv√°lidas. Tente novamente.
            </div>
            
            <input type="email" id="adminEmail" 
                   placeholder="Email do administrador"
                   style="
                       width: 100%;
                       padding: 12px;
                       margin-bottom: 15px;
                       border: 2px solid #ddd;
                       border-radius: 6px;
                       font-size: 16px;
                       box-sizing: border-box;
                   "
                   autocomplete="email">
            
            <input type="password" id="adminPassword" 
                   placeholder="Senha"
                   style="
                       width: 100%;
                       padding: 12px;
                       margin-bottom: 25px;
                       border: 2px solid #ddd;
                       border-radius: 6px;
                       font-size: 16px;
                       box-sizing: border-box;
                   "
                   autocomplete="current-password">
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btnCancelLogin" 
                        style="
                            padding: 12px 25px;
                            background: #95a5a6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            flex: 1;
                        ">
                    Cancelar
                </button>
                <button id="btnSubmitLogin" 
                        style="
                            padding: 12px 25px;
                            background: #2ecc71;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                    <span id="loginBtnText">Entrar</span>
                    <div id="loginLoading" style="display: none; width: 18px; height: 18px; border: 2px solid white; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </button>
            </div>
            
            <div style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">
                ‚ö†Ô∏è Apenas administradores autorizados
            </div>
            
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        const emailInput = document.getElementById('adminEmail');
        const passwordInput = document.getElementById('adminPassword');
        const submitBtn = document.getElementById('btnSubmitLogin');
        const cancelBtn = document.getElementById('btnCancelLogin');
        const loginError = document.getElementById('loginError');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginLoading = document.getElementById('loginLoading');
        
        // Focar no email
        emailInput.focus();
        
        const removeModal = () => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        };
        
        // Fun√ß√£o para realizar login
        const performLogin = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginError.textContent = 'Preencha todos os campos!';
                loginError.style.display = 'block';
                return;
            }
            
            // Mostrar loading
            loginBtnText.style.display = 'none';
            loginLoading.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                // Fazer login no Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Verificar se o usu√°rio tem acesso ao Firestore (escrever na collection 'admin_access')
                const adminAccessRef = db.collection('admin_access').doc(user.uid);
                const adminAccessSnap = await adminAccessRef.get();
                
                if (adminAccessSnap.exists) {
                    const adminData = adminAccessSnap.data();
                    
                    // Verificar se est√° ativo
                    if (adminData.active !== false) {
                        // Log de acesso bem-sucedido
                        await sistemaLogs.registrar('login_firebase_sucesso', {
                            email: email,
                            uid: user.uid,
                            ip: await getUserIP()
                        });
                        
                        removeModal();
                        resolve({
                            success: true,
                            user: user,
                            adminData: adminData
                        });
                    } else {
                        throw new Error('Conta desativada');
                    }
                } else {
                    throw new Error('Acesso n√£o autorizado');
                }
                
            } catch (error) {
                // Log de erro
                await sistemaLogs.registrar('login_firebase_falha', {
                    email: email,
                    error: error.message,
                    ip: await getUserIP()
                });
                
                // Mostrar erro
                loginError.textContent = 'Credenciais inv√°lidas ou acesso n√£o autorizado';
                loginError.style.display = 'block';
                
                // Restaurar bot√£o
                loginBtnText.style.display = 'block';
                loginLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        };
        
        // Event Listeners
        submitBtn.addEventListener('click', performLogin);
        
        cancelBtn.addEventListener('click', () => {
            removeModal();
            resolve({ success: false, cancelled: true });
        });
        
        // Enter para enviar
        const handleEnter = (e) => {
            if (e.key === 'Enter') {
                performLogin();
            }
        };
        
        emailInput.addEventListener('keypress', handleEnter);
        passwordInput.addEventListener('keypress', handleEnter);
        
        // Fechar com ESC
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cancelBtn.click();
            }
        });
        
        // Fechar ao clicar fora
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                cancelBtn.click();
            }
        });
    });
}

// =========================
// ADMIN PANEL - FUN√á√ÉO PRINCIPAL COM FIREBASE
// =========================
async function renderAdminProducts() {
    console.log('üîÑ Abrindo painel admin (com Firebase Auth)...');
    
    // Verificar se j√° est√° autenticado
    if (auth.currentUser) {
        // Verificar se ainda tem permiss√£o
        const adminAccessRef = db.collection('admin_access').doc(auth.currentUser.uid);
        const adminAccessSnap = await adminAccessRef.get();
        
        if (adminAccessSnap.exists && adminAccessSnap.data().active !== false) {
            // J√° autenticado e com permiss√£o
            console.log('‚úÖ Usu√°rio j√° autenticado:', auth.currentUser.email);
            await renderAdminProductsContent();
            iniciarTimeoutAdmin();
            return;
        }
    }
    
    // Se n√£o est√° autenticado, mostrar modal de login
    const loginResult = await showLoginModal();
    
    if (loginResult.success) {
        console.log('‚úÖ Login bem-sucedido:', loginResult.user.email);
        window.adminAutenticado = true;
        await renderAdminProductsContent();
        iniciarTimeoutAdmin();
    } else {
        console.log('‚ùå Login cancelado ou falhou');
    }
}

//--------------------------------------------------------------------------------------------------------

// =========================
// ADMIN PANEL - FUN√á√ÉO PRINCIPAL CORRIGIDA
// =========================
async function renderAdminProducts() {
  // Se j√° est√° autenticado, abre direto
  if (adminAutenticado) {
    await renderAdminProductsContent();
    iniciarTimeoutAdmin();
    return;
  }
  
  // Se n√£o est√° autenticado, pede senha
  askAdminPassword(async (senhaHashDigitada) => {
    try {
      const senhaValida = await verificarSenhaAdmin(senhaHashDigitada);
      
      if (!senhaValida) { 
        // üìù LOG DE TENTATIVA FALHA
        await sistemaLogs.registrar('login_admin_falha', {
          motivo: 'senha_incorreta',
          ip: await getUserIP()
        });
        
        alert('Senha incorreta!'); 
        return; 
      }
      
      adminAutenticado = true;
      
      // üìù LOG DE ACESSO BEM-SUCEDIDO
      await sistemaLogs.registrar('login_admin_sucesso', {
        userId: auth.currentUser?.uid,
        adminId: 'admin_sistema'
      });
      
      await renderAdminProductsContent();
      iniciarTimeoutAdmin();
      
    } catch (error) {
      alert('Erro ao verificar senha: ' + error.message);
    }
  });
}

//-------------------------------------------------------------------------------------------------------

// =========================
// ADMIN PANEL - FUN√á√ÉO PRINCIPAL COM FIREBASE
// =========================
async function renderAdminProducts() {
    console.log('üîÑ Abrindo painel admin (com Firebase Auth)...');
    
    // Verificar se j√° est√° autenticado
    if (auth.currentUser) {
        // Verificar se ainda tem permiss√£o
        const adminAccessRef = db.collection('admin_access').doc(auth.currentUser.uid);
        const adminAccessSnap = await adminAccessRef.get();
        
        if (adminAccessSnap.exists && adminAccessSnap.data().active !== false) {
            // J√° autenticado e com permiss√£o
            console.log('‚úÖ Usu√°rio j√° autenticado:', auth.currentUser.email);
            await renderAdminProductsContent();
            iniciarTimeoutAdmin();
            return;
        }
    }
    
    // Se n√£o est√° autenticado, mostrar modal de login
    const loginResult = await showLoginModal();
    
    if (loginResult.success) {
        console.log('‚úÖ Login bem-sucedido:', loginResult.user.email);
        window.adminAutenticado = true;
        await renderAdminProductsContent();
        iniciarTimeoutAdmin();
    } else {
        console.log('‚ùå Login cancelado ou falhou');
    }
}

//-------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PRINCIPAL DO PAINEL ADMIN - VERS√ÉO CORRIGIDA DEFINITIVA
// =========================
async function renderAdminProductsContent() {
  const snap = await db.collection('produtos').get();

  const modalDiv = document.createElement('div');
  modalDiv.className = 'modal-backdrop';
  
  const modalContent = document.createElement('div');
  modalContent.className = 'modal';
  
  // CABE√áALHO DO PAINEL - BOT√ÉO J√Å CONFIGURADO ANTES DE ADICIONAR AO DOM
  const header = document.createElement('div');
  header.style.cssText = `
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #eee;
`;

// BOT√ÉO FECHAR CRIADO COM EVENTO DIRETO (SOLU√á√ÉO DEFINITIVA)
    const closeBtn = document.createElement('button');
    closeBtn.id = 'adminCloseBtn';
    closeBtn.textContent = '‚úÖ Fechar Painel';
    closeBtn.style.cssText = `
      background: #2ecc71 !important;
      color: white !important;
      border: none !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      font-weight: bold !important;
      font-size: 15px !important;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.7) !important;
      position: relative !important;
      z-index: 9999 !important;
      min-width: 140px !important;
      text-align: center !important;
    `;

// EVENTO DIRETO NO BOT√ÉO (ANTES de adicionar ao DOM) COM INVALIDA√á√ÉO DE CACHE
closeBtn.onclick = function(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
  }
  
  console.log(' Bot√£o Fechar clicado - Fechando painel...');
  
  // Remover modal DIRETAMENTE
  const modal = document.querySelector('.modal-backdrop');
  if (modal) {
    modal.remove();
  }
  
  // Limpar timeout da sess√£o
  if (adminSessaoTimeout) {
    clearTimeout(adminSessaoTimeout);
    adminSessaoTimeout = null;
  }
  
  // üî• INVALIDAR O CACHE FOR√áANDO RECARGA
  produtosCache = null;
  ultimoCarregamentoCache = null;
  
  // Recarregar produtos
  if (typeof carregarProdutos === 'function') {
    setTimeout(() => {
      carregarProdutos();
    }, 300);
  }
  
  return false;
};

header.innerHTML = `
  <h2 style="margin: 0; color: #2c3e50;">üìä Painel Administrativo</h2>
  <div style="display: flex; gap: 10px; align-items: center;">
    <span style="font-size: 12px; color: #27ae60; background: #eafaf1; padding: 4px 8px; border-radius: 4px;">
      ‚úÖ Autenticado
    </span>
  </div>
`;

// Adicionar o bot√£o ao header
header.querySelector('div').appendChild(closeBtn);
  
  modalContent.appendChild(header);

  // BARRA DE PESQUISA
  const searchBar = document.createElement('input');
  searchBar.placeholder = "üîç Pesquisar produto por nome ou descri√ß√£o...";
  searchBar.style.cssText = `
    padding: 12px;
    margin-bottom: 15px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
  `;
  
  modalContent.appendChild(searchBar);

  // CONT√äINER DOS PRODUTOS
  const container = document.createElement('div');
  container.id = 'adminProductsList';
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.gap = '12px';
  container.style.maxHeight = '50vh';
  container.style.overflowY = 'auto';
  container.style.paddingRight = '5px';
  
  modalContent.appendChild(container);

  // BARRA DE FERRAMENTAS (BOT√ïES DE A√á√ÉO)
  const toolbar = document.createElement('div');
  toolbar.style.cssText = `
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  `;
  
  // BOT√ÉO CADASTRAR PRODUTO
  const addBtn = document.createElement('button');
  addBtn.className = 'btn';
  addBtn.style.cssText = 'background: #27ae60; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  addBtn.innerHTML = '<i class="fa-solid fa-plus" style="margin-right:6px;"></i> Cadastrar Novo Produto';
  addBtn.addEventListener('click', async () => {
    const name = prompt('Nome do produto:');
    if (!name) {
      alert('Nome do produto √© obrigat√≥rio!');
      return;
    }
    
    const desc = prompt('Descri√ß√£o:');
    const priceUnit = prompt('Pre√ßo por unidade (deixe vazio se n√£o aplicar):');
    const priceKg = prompt('Pre√ßo por kg (deixe vazio se n√£o aplicar):');
    const oldPrice = prompt('Pre√ßo antigo (para promo√ß√£o, deixe vazio se n√£o aplicar):');
    const img = prompt('URL da imagem:');
    const stock = prompt('Quantidade em estoque:');
    
    try {
      await db.collection('produtos').add({
        name,
        desc: desc || '',
        priceUnit: priceUnit ? Number(priceUnit) : null,
        priceKg: priceKg ? Number(priceKg) : null,
        oldPrice: oldPrice ? Number(oldPrice) : null,
        img: img || 'https://via.placeholder.com/400x300?text=Sem+imagem',
        stock: stock ? Number(stock) : 0,
        active: true,
        criadoEm: new Date().toISOString()
      });
      
      alert('‚úÖ Produto cadastrado com sucesso!');
      // Recarregar a lista sem fechar o painel
      renderAdminProductsContent();
      
    } catch (error) {
      alert('‚ùå Erro ao cadastrar produto: ' + error.message);
    }
  });
  
  toolbar.appendChild(addBtn);

  // BOT√ÉO REPOSI√á√ÉO DE ESTOQUE
  const estoqueRapidoBtn = document.createElement('button');
  estoqueRapidoBtn.className = 'btn';
  estoqueRapidoBtn.style.cssText = 'background: #16a085; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  estoqueRapidoBtn.innerHTML = 'üì¶ Reposi√ß√£o R√°pida de Estoque';
  estoqueRapidoBtn.addEventListener('click', async () => {
    if (typeof reporEstoqueManual === 'function') {
      await reporEstoqueManual();
    } else {
      alert('Fun√ß√£o n√£o carregada. Use o console: reporEstoqueManual()');
    }
  });
  
  toolbar.appendChild(estoqueRapidoBtn);

//----------------------------------------------------------------------------------------------------
  // BOT√ÉO CONFIGURAR TAXA DE ENTREGA (COM SENHA)
  const taxaEntregaBtn = document.createElement('button');
  taxaEntregaBtn.className = 'btn';
  taxaEntregaBtn.style.cssText = 'background: #d35400; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  taxaEntregaBtn.innerHTML = 'üöö Configurar Taxa de Entrega';
  
  taxaEntregaBtn.addEventListener('click', async () => {
      try {
          // üîí PEDIR SENHA DA TAXA DE ENTREGA
          const senhaTaxaEntrega = await criarModalSenhaTaxaEntrega();
          
          if (senhaTaxaEntrega === null) {
              console.log('Configura√ß√£o de taxa cancelada pelo usu√°rio');
              return;
          }
          
          if (!senhaTaxaEntrega || senhaTaxaEntrega.trim() === '') {
              alert('‚ùå Senha √© obrigat√≥ria!');
              return;
          }
          
          // Verificar senha da taxa de entrega
          const senhaValida = await verificarSenhaTaxaEntrega(senhaTaxaEntrega);
          
          if (!senhaValida) {
              await sistemaLogs.registrar('config_taxa_falha', {
                  motivo: 'senha_incorreta',
                  ip: await getUserIP()
              });
              alert('‚ùå Senha da taxa de entrega incorreta!');
              return;
          }
          
          // LOG DE ACESSO
          console.log(' Acesso autorizado para configurar taxa de entrega');
          
          // Buscar taxa atual
          const taxaAtualSnap = await db.collection('config').doc('entrega').get();
          let taxaAtual = 0;
          if (taxaAtualSnap.exists) {
              taxaAtual = taxaAtualSnap.data().taxa || 0;
          }
          
          const novaTaxaTexto = prompt(
              `üí∞ CONFIGURAR TAXA DE ENTREGA\n\n` +
              `Taxa atual: R$ ${taxaAtual.toFixed(2)}\n\n` +
              `Digite o novo valor (ex: 5.00):\n` +
              `‚Ä¢ Use 0 para entrega gratuita\n` +
              `‚Ä¢ Use ponto para decimais (5.00)\n` +
              `‚Ä¢ M√≠nimo: R$ 0,00`,
              taxaAtual.toFixed(2)
          );
          
          if (novaTaxaTexto === null) {
              console.log(' Configura√ß√£o de taxa cancelada');
              return;
          }
          
          const novaTaxa = parseFloat(novaTaxaTexto.replace(',', '.'));
          
          if (isNaN(novaTaxa) || novaTaxa < 0) {
              alert('‚ùå Valor inv√°lido! Digite um n√∫mero positivo (ex: 5.00)');
              return;
          }
          
          // Confirmar
          const confirmar = confirm(
              `‚ö†Ô∏è CONFIRMAR ALTERA√á√ÉO?\n\n` +
              `Taxa de entrega ser√° alterada para:\n` +
              `R$ ${novaTaxa.toFixed(2)}\n\n` +
              `‚úÖ Confirmar configura√ß√£o?`
          );
          
          if (!confirmar) {
              alert('‚ùå Altera√ß√£o cancelada');
              return;
          }
          
          // Salvar no Firebase
          await db.collection('config').doc('entrega').set({
              taxa: novaTaxa,
              atualizadoEm: new Date().toISOString(),
              atualizadoPor: auth.currentUser?.uid || 'admin'
          }, { merge: true });
          
          // Atualizar vari√°vel global
          taxaEntrega = novaTaxa;
          
          // Atualizar carrinho se estiver vis√≠vel
          if (typeof renderCart === 'function') {
              renderCart();
          }
          
          // Log do sistema
          if (typeof sistemaLogs !== 'undefined' && sistemaLogs.registrar) {
              await sistemaLogs.registrar('taxa_entrega_alterada', {
                  valorAnterior: taxaAtual,
                  valorNovo: novaTaxa,
                  adminId: auth.currentUser?.uid
              });
          }
          
          alert(`‚úÖ TAXA DE ENTREGA CONFIGURADA!\n\n` +
                `Novo valor: R$ ${novaTaxa.toFixed(2)}\n\n` +
                `O valor ser√° aplicado em todos os pedidos.`);
          
          console.log(' Taxa de entrega atualizada:', novaTaxa);
          
      } catch (error) {
          console.error(' Erro ao configurar taxa:', error);
          alert('‚ùå Erro ao configurar taxa: ' + error.message);
      }
  });
  
  toolbar.appendChild(taxaEntregaBtn);

//----------------------------------------------------------------------------------------------------

 // BOT√ÉO CONFIGURAR PIX (COM VALIDA√á√ÉO DA CHAVE COM 3 TENTATIVAS)
const pixConfigBtn = document.createElement('button');
pixConfigBtn.className = 'btn';
pixConfigBtn.style.cssText = 'background: #9b59b6; color: #fff; margin: 0; flex: 1; min-width: 200px;';
pixConfigBtn.textContent = 'üí∞ Configurar PIX Completo';

pixConfigBtn.addEventListener('click', async () => {
    // üîí USANDO MODAL COM ESTRELINHAS PARA SENHA
    const senhaPix = await criarModalSenha();
    
    if (senhaPix === null) {
        console.log('Configura√ß√£o de PIX cancelada pelo usu√°rio');
        return;
    }
    
    if (!senhaPix || senhaPix.trim() === '') {
        alert('‚ùå Senha √© obrigat√≥ria!');
        return;
    }
    
    // Verificar senha do PIX usando fun√ß√£o segura
    const senhaValida = await verificarSenhaPix(senhaPix);
    
    if (!senhaValida) {
        await sistemaLogs.registrar('config_pix_falha', {
            motivo: 'senha_incorreta',
            ip: await getUserIP()
        });
        alert('‚ùå Senha do PIX incorreta!');
        return;
    }
    
    // LOG DE ACESSO
    console.log(' Acesso autorizado para configurar PIX');
    
    try {
        const pixAtual = await db.collection('config').doc('pix').get();
        const dadosAtuais = pixAtual.exists ? pixAtual.data() : {};
        


        // DEBUG: Teste r√°pido
        console.log(' SISTEMA DE CORRE√á√ÉO PIX CARREGADO');
        console.log(' Testando corre√ß√£o 5586176915 ‚Üí +5581986176915');

        // Adicione esta fun√ß√£o de teste
        function testarCorrecaoPIX() {
            console.log('üéØ TESTE 1 - 5586176915:', validarChavePIX('5586176915'));
            console.log('üéØ TESTE 2 - 5581986176915:', validarChavePIX('5581986176915'));
            console.log('üéØ TESTE 3 - +5581986176915:', validarChavePIX('+5581986176915'));
            console.log('üéØ TESTE 4 - 86176915:', validarChavePIX('86176915'));
        }

// Execute o teste quando a p√°gina carregar
setTimeout(testarCorrecaoPIX, 2000);
       
    // üîß FUN√á√ÉO PARA VALIDAR CHAVE PIX COM MENSAGEM CLARA E 3 TENTATIVAS
    function validarChavePIX(chave) {
        chave = chave.trim();
        
        // Se estiver vazio
        if (!chave) {
            return {
                valido: false,
                chaveFormatada: '',
                mensagem: '‚ùå A chave PIX n√£o pode estar vazia!'
            };
        }
    
    // Detectar tipo de chave
    const tipo = detectarTipoChaveAuto(chave);
    
    // Valida√ß√µes espec√≠ficas por tipo
    switch (tipo) {
       case 'celular':
    // Remover todos n√£o-num√©ricos
    let apenasNumeros = chave.replace(/\D/g, '');
    
    console.log(' Validando CELULAR:', {
        original: chave,
        apenasNumeros: apenasNumeros,
        digitos: apenasNumeros.length
    });
    
    // üî•üî•üî• REGRA PRINCIPAL: QUALQUER n√∫mero que comece com 55
    // Formato: 55XXXXXXXXXX ‚Üí +55819 + (√∫ltimos 8 d√≠gitos)
    if (apenasNumeros.startsWith('55')) {
        console.log(' N√∫mero come√ßando com 55 detectado - Aplicando corre√ß√£o');
        
        // 1. Pegar os √öLTIMOS 8 d√≠gitos do n√∫mero
        let ultimos8Digitos;
        
        if (apenasNumeros.length >= 8) {
            // Se tem 8 ou mais d√≠gitos: pegar os √∫ltimos 8
            ultimos8Digitos = apenasNumeros.substring(apenasNumeros.length - 8);
        } else {
            // Se tem menos de 8 d√≠gitos: completar com zeros
            ultimos8Digitos = apenasNumeros.padStart(8, '0');
        }
        
        // 2. Formatar como +55819 + √∫ltimos 8 d√≠gitos
        const chaveFormatada = `+55819${ultimos8Digitos}`;
        
        console.log(' Corre√ß√£o aplicada:', {
            entrada: apenasNumeros,
            digitosEntrada: apenasNumeros.length,
            ultimos8: ultimos8Digitos,
            resultado: chaveFormatada
        });
        
        // 3. Retornar resultado
        return {
            valido: true,
            chaveFormatada: chaveFormatada,
            mensagem: `‚úÖ Celular corrigido automaticamente!\n\n` +
                    `Voc√™ digitou: ${chave}\n` +
                    `Foi corrigido para: ${chaveFormatada}\n\n` +
                    `üì± Regra aplicada:\n` +
                    `‚Ä¢ Pegar os √∫ltimos 8 d√≠gitos: ${ultimos8Digitos}\n` +
                    `‚Ä¢ Adicionar +55819 na frente\n` +
                    `‚Ä¢ Resultado: +55819${ultimos8Digitos}`
        };
    }
    
        // üî• FORMATO J√Å CORRETO: +55 seguido de 11 d√≠gitos (total 13 d√≠gitos)
        if (apenasNumeros.length === 13 && apenasNumeros.startsWith('55')) {
            const chaveFormatada = '+' + apenasNumeros;
            
            return {
                valido: true,
                chaveFormatada: chaveFormatada,
                mensagem: `‚úÖ Celular v√°lido!\n\n` +
                        `Chave: ${chaveFormatada}`
            };
        }
    
        // üî• SE N√ÉO COME√áAR COM 55 E N√ÉO ESTIVER NO FORMATO CORRETO
        return {
            valido: false,
            chaveFormatada: '',
            mensagem: `‚ùå Formato n√£o reconhecido!\n\n` +
                    `Voc√™ digitou: ${chave}\n` +
                    `D√≠gitos: ${apenasNumeros.length}\n\n` +
                    `‚úÖ Digite n√∫meros no formato:\n` +
                    `‚Ä¢ 5586176915 ‚Üí ser√° corrigido para +5581986176915\n` +
                    `‚Ä¢ 5588437890 ‚Üí ser√° corrigido para +5581988437890\n` +
                    `‚Ä¢ 5512345678 ‚Üí ser√° corrigido para +5581912345678\n\n` +
                    `üìù Padr√£o: 55 seguido de mais d√≠gitos\n` +
                    `O sistema pegar√° os √∫ltimos 8 d√≠gitos e adicionar√° +55819`
        }; 
    
        // CONFIGURAR CHAVE PIX CNPJ   
            case 'cnpj':
            console.log(' Validando CNPJ:', chave);
    
        // 1. Limpar todos n√£o-n√∫meros
            const cnpjNumeros = chave.replace(/\D/g, '');
            const quantidadeDigitos = cnpjNumeros.length;
            
            console.log(' CNPJ analisado:', {
              original: chave,
              numeros: cnpjNumeros,
              digitos: quantidadeDigitos
        });
    
        // 2. VALIDA√á√ÉO PRINCIPAL: DEVE TER EXATAMENTE 14 D√çGITOS
        if (quantidadeDigitos !== 14) {
            let mensagemErro = '';
            
            if (quantidadeDigitos === 15) {
                mensagemErro = `‚ùå CNPJ COM 15 D√çGITOS DETECTADO!\n\n` +
                              `Voc√™ digitou: ${chave}\n` +
                              `Total: 15 d√≠gitos (‚ùå DEVE SER 14)\n\n` +
                              `Provavelmente voc√™ digitou um d√≠gito a mais.\n` +
                              `Verifique o CNPJ: ${cnpjNumeros}\n\n` +
                              `Exemplo correto: 12.345.678/0001-95`;
            } 
            else if (quantidadeDigitos === 13) {
                mensagemErro = `‚ùå CNPJ COM 13 D√çGITOS DETECTADO!\n\n` +
                              `Voc√™ digitou: ${chave}\n` +
                              `Total: 13 d√≠gitos (‚ùå FALTA 1 D√çGITO)\n\n` +
                              `O CNPJ deve ter 14 d√≠gitos.\n` +
                              `Verifique se n√£o esqueceu um n√∫mero.\n\n` +
                              `Exemplo correto: 12.345.678/0001-95`;
            }
            else if (quantidadeDigitos > 14) {
                mensagemErro = `‚ùå CNPJ COM MUITOS D√çGITOS!\n\n` +
                              `Voc√™ digitou: ${chave}\n` +
                              `Total: ${quantidadeDigitos} d√≠gitos (‚ùå DEVE SER 14)\n\n` +
                              `Voc√™ digitou ${quantidadeDigitos - 14} d√≠gitos a mais.\n` +
                              `Exemplo correto: 12.345.678/0001-95`;
            }
            else if (quantidadeDigitos < 14) {
                mensagemErro = `‚ùå CNPJ COM POUCOS D√çGITOS!\n\n` +
                              `Voc√™ digitou: ${chave}\n` +
                              `Total: ${quantidadeDigitos} d√≠gitos (‚ùå DEVE SER 14)\n\n` +
                              `Faltam ${14 - quantidadeDigitos} d√≠gitos.\n` +
                              `Exemplo correto: 12.345.678/0001-95`;
            }
        
            return {
                valido: false,
                chaveFormatada: '',
                mensagem: mensagemErro
            };
        }
    
        // 3. Se tem exatos 14 d√≠gitos, formatar
        const cnpjFormatado = cnpjNumeros.replace(
            /(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,
            '$1.$2.$3/$4-$5'
        );
        
        console.log(' CNPJ v√°lido (14 d√≠gitos):', cnpjFormatado);
        
        return {
            valido: true,
            chaveFormatada: cnpjNumeros, // Salvar apenas n√∫meros (sem formata√ß√£o)
            mensagem: `‚úÖ CNPJ v√°lido! (14 d√≠gitos)\n\n` +
                    `Formatado: ${cnpjFormatado}\n` +
                    `Ser√° salvo como: ${cnpjNumeros}`
        };
            
        // CONFIGURA√á√ÉO CHAVE PIX E-MAIL
          case 'email':
          const email = String(chave || '').trim().toLowerCase();
          
          // Regex b√°sico
          const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
          
          if (!emailRegex.test(email)) {
              return {
                  valido: false,
                  chaveFormatada: '',
                  mensagem: `‚ùå Formato de email inv√°lido!`
              };
          }
          
          // Extrair extens√£o
          const partes = email.split('@')[1].split('.');
          const extensaoPrincipal = partes[partes.length - 1];
          const extensaoCompleta = partes.slice(-2).join('.'); // Para pegar "com.br"
          
          // EXTENS√ïES PERMITIDAS NO BRASIL (PIX)
          const extensoesPermitidas = [
              'com', 'com.br', 'br', 'net', 'org', 'org.br',
              'gov.br', 'edu.br', 'info', 'biz', 'me', 'io'
          ];
          
          // Verificar se extens√£o √© permitida
          const extensaoValida = extensoesPermitidas.includes(extensaoCompleta) || 
                                extensoesPermitidas.includes(extensaoPrincipal);
          
          if (extensaoValida) {
              return {
                  valido: true,
                  chaveFormatada: email,
                  mensagem: `‚úÖ Email v√°lido para PIX!\n\n` +
                          `Email: ${email}\n` +
                          `Dom√≠nio: .${extensaoCompleta || extensaoPrincipal}`
              };
          } else {
              return {
                  valido: false,
                  chaveFormatada: '',
                  mensagem: `‚ùå Extens√£o n√£o permitida para PIX!\n\n` +
                          `Extens√£o: .${extensaoPrincipal}\n\n` +
                          `Extens√µes permitidas no Brasil:\n` +
                          `‚Ä¢ .com (ex: gmail.com)\n` +
                          `‚Ä¢ .com.br (ex: empresa.com.br)\n` +
                          `‚Ä¢ .br\n` +
                          `‚Ä¢ .net, .org, .info, .biz\n` +
                          `‚Ä¢ .gov.br, .edu.br`
              };
          }
            
        case 'chave_aleatoria':
            // Chave aleat√≥ria: m√≠nimo 10 caracteres, m√°ximo 77
            if (chave.length >= 10 && chave.length <= 77) {
                return {
                    valido: true,
                    chaveFormatada: chave,
                    mensagem: '‚úÖ Chave aleat√≥ria v√°lida!'
                };
            } else {
                return {
                    valido: false,
                    chaveFormatada: '',
                    mensagem: `‚ùå Chave aleat√≥ria inv√°lida!\n\n` +
                             `M√≠nimo: 10 caracteres\n` +
                             `M√°ximo: 77 caracteres\n` +
                             `Atual: ${chave.length} caracteres`
                };
            }
            
        default:
            // Outro tipo - valida√ß√£o gen√©rica
            if (chave.length >= 8 && chave.length <= 77) {
                return {
                    valido: true,
                    chaveFormatada: chave,
                    mensagem: `‚úÖ Chave do tipo "${tipo}" aceita!`
                };
            } else {
                return {
                    valido: false,
                    chaveFormatada: '',
                    mensagem: `‚ùå Chave inv√°lida!\n\n` +
                             `Comprimento deve ser entre 8 e 77 caracteres\n` +
                             `Atual: ${chave.length} caracteres`
                };
            }
    }
}

// üîß FUN√á√ÉO PARA DETECTAR TIPO DE CHAVE MELHORADO
    function detectarTipoChaveAuto(chave) {
    chave = chave.trim().toLowerCase();
    
    console.log(' detectarTipoChaveAuto chamada com:', chave);
    
    // 1. Email (prioridade m√°xima)
        if (chave.includes('@')) {
            return 'email';
        }
    
    // 2. Remover todos n√£o-num√©ricos para an√°lise
    const apenasNumeros = chave.replace(/\D/g, '');
    
    console.log(' Apenas n√∫meros:', apenasNumeros, '(', apenasNumeros.length, 'd√≠gitos)');
    
    // üî•üî•üî• CORRE√á√ÉO CR√çTICA: DETECTAR TODOS OS N√öMEROS DE 10 D√çGITOS COME√áANDO COM 55 COMO CELULAR
        if (apenasNumeros.length === 10 && apenasNumeros.startsWith('55')) {
            console.log(' N√∫mero de 10 d√≠gitos come√ßando com 55 detectado como CELULAR');
            return 'celular';
        }
    
    // 3. CPF (11 d√≠gitos)
        if (apenasNumeros.length === 11) {
            const primeiroDigito = parseInt(apenasNumeros.charAt(0));
            
        // Se come√ßar com 0-7, √© CPF
        if (primeiroDigito >= 0 && primeiroDigito <= 7) {
            console.log(' Detectado como CPF (11 d√≠gitos, come√ßa com 0-7)');
            return 'cpf';
        }
        
        // Se come√ßar com 8 ou 9, √© celular
        if (primeiroDigito === 8 || primeiroDigito === 9) {
            console.log(' Detectado como CELULAR (11 d√≠gitos, come√ßa com 8 ou 9)');
            return 'celular';
        }
        
        console.log(' Detectado como CPF (padr√£o)');
        return 'cpf';
    }
    
        // 4. Celular com c√≥digo do pa√≠s (12-13 d√≠gitos)
          if (chave.startsWith('+55') || (apenasNumeros.startsWith('55') && (apenasNumeros.length === 12 || apenasNumeros.length === 13))) {
              console.log(' Detectado como CELULAR (come√ßa com +55 ou 55, 12-13 d√≠gitos)');
              return 'celular';
          }
    
        // 5. Celular (8-11 d√≠gitos) - verificar padr√µes de celular brasileiro
            if (apenasNumeros.length >= 8 && apenasNumeros.length <= 11) {
                const primeiroDigito = parseInt(apenasNumeros.charAt(0));
                
        // Se come√ßar com 8 ou 9, √© celular
            if (primeiroDigito === 8 || primeiroDigito === 9) {
                console.log(' Detectado como CELULAR (8-11 d√≠gitos, come√ßa com 8 ou 9)');
                return 'celular';
              }
                
        // Se tiver DDD v√°lido (11-99) e segundo d√≠gito for 9
            if (apenasNumeros.length >= 10) {
                    const ddd = parseInt(apenasNumeros.substring(0, 2));
                if (ddd >= 11 && ddd <= 99) {
                    const segundoDigito = parseInt(apenasNumeros.charAt(2));
                      if (segundoDigito === 9) {
                        console.log(' Detectado como CELULAR (com DDD e d√≠gito 9)');
                          return 'celular';
                      }
                        console.log(' Detectado como TELEFONE FIXO (com DDD)');
                        return 'telefone';
                    }
                }
                
                console.log(' Detectado como CELULAR (padr√£o para 8-11 d√≠gitos)');
                return 'celular';
            }
            
        // 6. N√∫meros longos (13-14 d√≠gitos)
           if (apenasNumeros.length === 14) {
                return 'cnpj'; // CNPJ correto
          }

        // 4.5 N√∫meros longos que podem ser CNPJ com erro de digita√ß√£o
          if (apenasNumeros.length >= 12 && apenasNumeros.length <= 20 && /^\d+$/.test(chave)) {
              console.warn(` N√∫mero com ${apenasNumeros.length} d√≠gitos - tratando como CNPJ com poss√≠vel erro`);
              return 'cnpj';
          }
    
        // 7. CNPJ (14 d√≠gitos exatos)
          if (apenasNumeros.length === 14) {
              console.log(' Detectado como CNPJ (14 d√≠gitos exatos)');
              return 'cnpj';
          }
          
        // 8. Chave aleat√≥ria (UUID-like)
          if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(chave)) {
              console.log(' Detectado como CHAVE ALEAT√ìRIA (UUID)');
              return 'chave_aleatoria';
          }
    
        // 9. Outras chaves aleat√≥rias (com caracteres especiais)
          if (/[a-z]/i.test(chave) && /[0-9]/.test(chave)) {
              console.log(' Detectado como CHAVE ALEAT√ìRIA (texto + n√∫meros)');
              return 'chave_aleatoria';
          }
          
        // 10. Se tiver apenas n√∫meros mas n√£o se encaixa nos padr√µes acima
          if (/^\d+$/.test(chave) && chave.length >= 5 && chave.length <= 77) {
              console.log(' Detectado como TELEFONE (gen√©rico)');
              return 'telefone';
          }
          
        // 11. Default
          console.log(' Detectado como OUTRO');
          return 'outro';
      }

        // üîß FUN√á√ÉO PARA PROMPT COM VALIDA√á√ÉO E 3 TENTATIVAS (APENAS PARA CHAVE PIX)
        function promptComValidacaoChavePIX(mensagem, valorPadrao) {
            let tentativas = 0;
            const maxTentativas = 3;
            
            while (tentativas < maxTentativas) {
                const entrada = prompt(
                    `${mensagem}\n\n` +
                    `Tentativa ${tentativas + 1} de ${maxTentativas}`,
                    valorPadrao
                );
                
                if (entrada === null) {
                    return null; // Usu√°rio cancelou
                }
                
                const resultadoValidacao = validarChavePIX(entrada);
                
                if (resultadoValidacao.valido) {
                    // Se precisou corrigir, mostrar mensagem
                    if (resultadoValidacao.mensagem.includes('corrigido') || 
                        resultadoValidacao.mensagem.includes('Formatado') ||
                        resultadoValidacao.mensagem.includes('v√°lido')) {
                        
                        const confirmar = confirm(
                            `${resultadoValidacao.mensagem}\n\n` +
                            `Deseja usar: ${resultadoValidacao.chaveFormatada || entrada}?`
                        );
                        
                        if (confirmar) {
                            return resultadoValidacao.chaveFormatada || entrada;
                        } else {
                            tentativas++;
                            continue;
                        }
                    }
                    
                    return resultadoValidacao.chaveFormatada || entrada;
                } else {
                    // Mostrar erro espec√≠fico
                    alert(resultadoValidacao.mensagem);
                    tentativas++;
                    
                    if (tentativas >= maxTentativas) {
                        alert(`‚ùå N√∫mero m√°ximo de tentativas (${maxTentativas}) atingido!\n\n` +
                              `Chave PIX n√£o configurada.\n` +
                              `Opera√ß√£o cancelada.`);
                        return null;
                    }
                }
            }
            
            return null;
        }
        
        // üì± CAMPO DA CHAVE PIX COM VALIDA√á√ÉO FORTE E 3 TENTATIVAS
        let novaChave = null;
        
        // Usar prompt com valida√ß√£o e 3 tentativas
        novaChave = promptComValidacaoChavePIX(
            '‚úÖ SENHA V√ÅLIDA!\n\n' +
            'üí≥ DIGITE A CHAVE PIX:\n\n' +
            'üìã FORMATOS ACEITOS:\n' +
            '1. üì± CELULAR: 86176915 (sistema adiciona +5581)\n' +
            '2. üì± CELULAR: 8186176915 (com DDD)\n' +
            '3. üì± CELULAR: +558186176915 (completo)\n' +
            '4. üÜî CPF: 12345678909 ou 123.456.789-09\n' +
            '5. üìß EMAIL: email@exemplo.com\n' +
            '6. üè¢ CNPJ: 12345678000195 ou 12.345.678/0001-95\n' +
            '7. üîë CHAVE ALEAT√ìRIA: qualquer texto (10-77 caracteres)\n\n' +
            '‚ÑπÔ∏è O sistema detectar√° e corrigir√° automaticamente!',
            dadosAtuais.chave || ''
        );

        if (novaChave === null) {
            console.log('Configura√ß√£o de PIX cancelada pelo usu√°rio');
            return; // Usu√°rio cancelou ou excedeu tentativas
        }
        
        if (!novaChave || novaChave.trim() === '') {
            alert('‚ùå Chave PIX √© obrigat√≥ria!');
            return;
        }
        
        // üîç DETECTAR AUTOMATICAMENTE O TIPO DE CHAVE
        const tipoChave = detectarTipoChaveAuto(novaChave);
        
        // üìã RESUMO PARA CONFIRMA√á√ÉO
        const resumo = `
        üìä RESUMO DA CONFIGURA√á√ÉO PIX:
        
        üîë Chave: ${novaChave}
        üì± TIPO: ${tipoChave.toUpperCase()}
        
        ‚ö†Ô∏è VERIFIQUE SE EST√Å CORRETO:
        ${tipoChave === 'celular' ? '‚Ä¢ Formato: +55DDDXXXXXXXX ‚úì' : ''}
        ${tipoChave === 'cpf' ? '‚Ä¢ 11 d√≠gitos ‚úì' : ''}
        ${tipoChave === 'email' ? '‚Ä¢ Formato email@exemplo.com ‚úì' : ''}
        ${tipoChave === 'cnpj' ? '‚Ä¢ 14 d√≠gitos ‚úì' : ''}
        ${tipoChave === 'chave_aleatoria' ? '‚Ä¢ Chave aleat√≥ria ‚úì' : ''}
        
        üìù Esta chave ser√° usada para receber pagamentos!
        `;
        
        const confirmar = confirm(resumo + '\n\n‚úÖ Confirmar e salvar?');
        
        if (!confirmar) {
            alert('‚ùå Configura√ß√£o cancelada pelo usu√°rio');
            return;
        }
        
        const nomeTitular = prompt(
            'üë§ NOME DO TITULAR DA CONTA\n\n' +
            'Digite o NOME COMPLETO do titular da chave PIX:\n\n' +
            'Nome atual: ' + (dadosAtuais.nomeTitular || '(n√£o configurado)'),
            dadosAtuais.nomeTitular || ''
        );
        
        if (!nomeTitular || nomeTitular.trim() === '') {
            alert('‚ùå Nome do titular √© obrigat√≥rio!');
            return;
        }
        
        const cidadeTitular = prompt(
            'üèôÔ∏è CIDADE DO TITULAR\n\n' +
            'Digite a CIDADE do titular da conta:\n\n' +
            'Cidade atual: ' + (dadosAtuais.cidadeTitular || '(n√£o configurada)'),
            dadosAtuais.cidadeTitular || ''
        );
        
        if (!cidadeTitular || cidadeTitular.trim() === '') {
            alert('‚ùå Cidade √© obrigat√≥ria!');
            return;
        }
        
        // üîß **CORRE√á√ÉO: Dados completos para o Firebase**
        const dadosCompletosPix = {
            chave: novaChave.trim(),
            nomeTitular: nomeTitular.trim(),
            cidadeTitular: cidadeTitular.trim(),
            tipo: tipoChave,
            
            // **CAMPOS ADICIONAIS CR√çTICOS:**
            isPixEnabled: true,
            lastUpdated: new Date().toISOString(),
            updatedBy: auth.currentUser?.uid,
            
            // Campos para compatibilidade com sistema de pagamento
            rawPixPhone: novaChave.trim(),
            sellerPhone: novaChave.trim(),
            merchantName: nomeTitular.trim().toUpperCase(),
            merchantCity: cidadeTitular.trim().toUpperCase(),
            
            // Informa√ß√µes adicionais para debug
            formatoCorreto: tipoChave === 'celular' ? 'com_prefixo_internacional' : 'ok',
            digitos: novaChave.replace(/\D/g, '').length
        };
        
        
        await db.collection('config').doc('pix').set(dadosCompletosPix, { merge: true });

        // üîß **CORRE√á√ÉO: Atualizar vari√°veis globais E sincronizar**
        rawPixPhone = novaChave.trim();
        sellerPhone = novaChave.trim();
        merchantName = nomeTitular.trim().toUpperCase();
        merchantCity = cidadeTitular.trim().toUpperCase();

        console.log(' PIX salvo no Firebase, atualizando interface...', {
            chave: rawPixPhone,
            nome: merchantName,
            cidade: merchantCity
        });

        // üî•üî•üî• **CORRE√á√ÉO CR√çTICA: ATUALIZAR CARRINHO VIS√çVEL IMEDIATAMENTE** üî•üî•üî•
        // Esta parte faz a m√°gica de atualizar sem precisar de F5
        setTimeout(() => {
            console.log(' Atualizando PIX no carrinho vis√≠vel...');
            
            // 1. ATUALIZAR DISPLAY DA CHAVE PIX (texto verde)
            const pixKeyDisplay = document.getElementById('pixKeyDisplay');
            if (pixKeyDisplay) {
                pixKeyDisplay.textContent = rawPixPhone || 'N√£o configurada';
                console.log(' pixKeyDisplay atualizado:', pixKeyDisplay.textContent);
            }
            
            // 2. ATUALIZAR C√ìDIGO PIX (textarea) se tiver produtos
            const pixPayload = document.getElementById('pixPayload');
            if (pixPayload) {
                // Calcular total atual do carrinho
                let totalCarrinho = 0;
                if (window.cart && Array.isArray(window.cart)) {
                    totalCarrinho = window.cart.reduce((total, item) => {
                        return total + (Number(item.unitPrice || 0) * Number(item.qty || 0));
                    }, 0);
                }
                
                if (!rawPixPhone || rawPixPhone.trim() === '') {
                    pixPayload.value = '‚ö†Ô∏è Configure uma chave PIX no painel Admin';
                } else if (totalCarrinho <= 0) {
                    pixPayload.value = 'Adicione produtos ao carrinho para gerar c√≥digo PIX';
                } else {
                    const pixCode = buildPixEMV(rawPixPhone, merchantName, merchantCity, totalCarrinho);
                    pixPayload.value = pixCode;
                    console.log(' C√≥digo PIX gerado para R$', totalCarrinho.toFixed(2));
                }
            }
            
            // 3. RECONFIGURAR BOT√ÉO DE COPIAR (evitar problemas de evento)
            setTimeout(() => {
                const btnCopy = document.getElementById('btnCopyPayload');
                if (btnCopy) {
                    // Clonar bot√£o para limpar eventos antigos
                    const newBtn = btnCopy.cloneNode(true);
                    btnCopy.parentNode.replaceChild(newBtn, btnCopy);
                    
                    // Adicionar novo evento
                    document.getElementById('btnCopyPayload').addEventListener('click', async function() {
                        const payload = document.getElementById('pixPayload');
                        if (!payload || !payload.value || 
                            payload.value.includes('Configure') || 
                            payload.value.includes('Adicione')) {
                            alert('‚ö†Ô∏è Gere um c√≥digo PIX v√°lido primeiro! Adicione produtos ao carrinho.');
                            return;
                        }
                        
                        try {
                            await navigator.clipboard.writeText(payload.value);
                            this.textContent = '‚úÖ Copiado!';
                            this.style.background = '#27ae60';
                            setTimeout(() => {
                                this.textContent = 'üìã Copiar c√≥digo PIX';
                                this.style.background = '';
                            }, 2000);
                        } catch (err) {
                            payload.select();
                            document.execCommand('copy');
                            this.textContent = 'üìã Copiado (alternativo)';
                            setTimeout(() => {
                                this.textContent = 'üìã Copiar c√≥digo PIX';
                            }, 2000);
                        }
                    });
                    console.log(' Bot√£o copiar reconfigurado');
                }
            }, 100);
            
            // 4. VERIFICAR SE O CARRINHO EST√Å ABERTO E ATUALIZAR TUDO
            const cartCard = document.getElementById('cartCard');
            if (cartCard && cartCard.style.display !== 'none') {
                console.log(' Carrinho vis√≠vel - atualizando interface completa...');
                
                // Chamar fun√ß√µes existentes
                if (typeof atualizarPixDisplay === 'function') {
                    atualizarPixDisplay();
                }
                
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
                
                if (typeof renderCart === 'function') {
                    renderCart();
                }
            }
        }, 300); // Pequeno delay para garantir que o Firebase processou

        // üîß **CORRE√á√ÉO: Manter evento para outros listeners**
        document.dispatchEvent(new CustomEvent('pixConfigUpdated', {
            detail: dadosCompletosPix
        }));


        // LOG DA CONFIGURA√á√ÉO
        await db.collection('logs').add({
            tipo: 'config_pix_atualizado',
            adminId: auth.currentUser?.uid,
            dados: {
                chaveNova: '***' + novaChave.slice(-4),
                tipoChave: tipoChave,
                digitos: novaChave.replace(/\D/g, '').length,
                temPrefixo: novaChave.startsWith('+55') ? 'sim' : 'n√£o',
                isPixEnabled: true
            },
            timestamp: new Date().toISOString(),
            ip: await getUserIP()
        });
        
        await sistemaLogs.registrar('config_pix_sucesso', {
            chaveMascarada: '***' + novaChave.slice(-4),
            tipoChave: tipoChave,
            adminId: auth.currentUser?.uid,
            isPixEnabled: true
        });
        
        // üéâ MENSAGEM DE SUCESSO DETALHADA
        alert(
            `‚úÖ PIX CONFIGURADO COM SUCESSO!\n\n` +
            `üîë Chave: ${novaChave}\n` +
            `üì± Tipo: ${tipoChave.toUpperCase()}\n` +
            `üë§ Titular: ${nomeTitular}\n` +
            `üèôÔ∏è Cidade: ${cidadeTitular}\n\n` +
            `üí° Dica: Para testar, fa√ßa uma compra e gere um QR Code PIX.\n` +
            `O sistema j√° est√° pronto para receber pagamentos!`
        );
        
    } catch (error) {
        await sistemaLogs.registrar('config_pix_erro', {
            erro: error.message,
            adminId: auth.currentUser?.uid
        });
        alert('‚ùå Erro ao configurar PIX: ' + error.message);
    }
});

toolbar.appendChild(pixConfigBtn);
  // üîß **CORRE√á√ÉO ADICIONAL: Adicionar fun√ß√£o para determinar tipo de chave**
  function determinarTipoChave(chave) {
      // Remove caracteres n√£o num√©ricos
      const apenasNumeros = chave.replace(/\D/g, '');
      
      if (apenasNumeros.length === 11) return 'cpf';
      if (apenasNumeros.length === 14) return 'cnpj';
      if (/^(\d{10,11})$/.test(apenasNumeros)) return 'telefone';
      if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(chave)) return 'email';
      return 'aleatoria';
  }

  // BOT√ÉO CONFIGURAR WHATSAPP (COM SENHA SEPARADA)
  const configWhatsBtn = document.createElement('button');
  configWhatsBtn.className = 'btn';
  configWhatsBtn.style.cssText = 'background: #25D366; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  configWhatsBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Configurar WhatsApp';
  
  configWhatsBtn.addEventListener('click', async () => {
    try {
        // üîí PEDIR SENHA DO WHATSAPP (SEPARADA)
        const senhaWhatsApp = await criarModalSenhaWhatsApp();
        
        if (senhaWhatsApp === null) {
            console.log('Configura√ß√£o de WhatsApp cancelada pelo usu√°rio');
            return;
        }
        
        if (!senhaWhatsApp || senhaWhatsApp.trim() === '') {
            alert('‚ùå Senha √© obrigat√≥ria!');
            return;
        }
        
        // Verificar senha do WhatsApp usando fun√ß√£o espec√≠fica
        const senhaValida = await verificarSenhaWhatsApp(senhaWhatsApp);
        
        if (!senhaValida) {
            await sistemaLogs.registrar('config_whatsapp_falha', {
                motivo: 'senha_incorreta',
                ip: await getUserIP()
            });
            alert('‚ùå Senha do WhatsApp incorreta!');
            return;
        }
        
        // LOG DE ACESSO
        console.log(' Acesso autorizado para configurar WhatsApp');
        
        let numeroAtual = '';
        try {
            const whatsSnap = await db.collection('config').doc('whatsapp').get();
            if (whatsSnap.exists && whatsSnap.data().numero) {
                numeroAtual = whatsSnap.data().numero;
            }
        } catch (e) {
            console.log('N√∫mero n√£o configurado');
        }
        
        // üîß FUN√á√ÉO PARA VALIDAR N√öMERO DO WHATSAPP
        function validarNumeroWhatsApp(numero) {
            numero = String(numero || '').trim();
            
            if (!numero || numero === '') {
                return {
                    valido: false,
                    mensagem: '‚ùå O n√∫mero n√£o pode estar vazio!'
                };
            }
            
            const numeroLimpo = numero.replace(/\D/g, '');
            const digitos = numeroLimpo.length;
            
            // Valida√ß√µes
            if (digitos < 10) {
                return {
                    valido: false,
                    mensagem: `‚ùå N√∫mero muito curto!\n\n` +
                             `Digitado: ${numero} (${digitos} d√≠gitos)\n` +
                             `M√≠nimo: 10 d√≠gitos\n` +
                             `Exemplo: 5581986176915`
                };
            }
            
            if (digitos > 15) {
                return {
                    valido: false,
                    mensagem: `‚ùå N√∫mero muito longo!\n\n` +
                             `Digitado: ${numero} (${digitos} d√≠gitos)\n` +
                             `M√°ximo: 15 d√≠gitos\n` +
                             `Verifique se n√£o digitou caracteres extras`
                };
            }
            
            if (!/^\d+$/.test(numeroLimpo)) {
                return {
                    valido: false,
                    mensagem: `‚ùå N√∫mero cont√©m caracteres inv√°lidos!\n\n` +
                             `Apenas d√≠gitos s√£o permitidos\n` +
                             `Remova letras, espa√ßos ou s√≠mbolos`
                };
            }
            
            // Valida√ß√£o do formato (DDD + n√∫mero)
            if (!/^55\d{10,13}$/.test(numeroLimpo)) {
                return {
                    valido: false,
                    mensagem: `‚ö†Ô∏è Formato incomum detectado!\n\n` +
                             `N√∫mero: ${numeroLimpo}\n` +
                             `Formato recomendado: 55DDDXXXXXXXX\n` +
                             `Exemplo: 5581986176915\n\n` +
                             `Deseja usar mesmo assim?`
                };
            }
            
            return {
                valido: true,
                numeroFormatado: numeroLimpo,
                mensagem: `‚úÖ N√∫mero v√°lido!\n\n` +
                         `N√∫mero: ${numeroLimpo}\n` +
                         `D√≠gitos: ${digitos}`
            };
        }
        
        // üîÑ SISTEMA DE 3 TENTATIVAS
        let tentativas = 0;
        const maxTentativas = 3;
        let numeroValidado = null;
        let cancelado = false;
        
        while (tentativas < maxTentativas && !numeroValidado && !cancelado) {
            const mensagemTentativa = `üì± CONFIGURAR WHATSAPP\n\n` +
                `Digite o n√∫mero para receber pedidos:\n` +
                `Exemplo: 5581986176915\n\n` +
                `‚ö†Ô∏è REQUISITOS:\n` +
                `‚Ä¢ M√≠nimo 10 d√≠gitos\n` +
                `‚Ä¢ Apenas n√∫meros\n` +
                `‚Ä¢ Recomendado come√ßar com 55\n\n` +
                `Tentativa ${tentativas + 1} de ${maxTentativas}\n` +
                `N√∫mero atual: ${numeroAtual || 'N√£o configurado'}`;
            
            const novoNumero = prompt(mensagemTentativa, numeroAtual);
            
            if (novoNumero === null) {
                // Usu√°rio cancelou
                cancelado = true;
                console.log('Configura√ß√£o de WhatsApp cancelada pelo usu√°rio');
                continue;
            }
            
            if (!novoNumero || novoNumero.trim() === '') {
                alert('‚ùå O n√∫mero n√£o pode estar vazio!');
                tentativas++;
                continue;
            }
            
            const validacao = validarNumeroWhatsApp(novoNumero);
            
            if (validacao.valido) {
                // Se for formato incomum, pedir confirma√ß√£o
                if (validacao.mensagem.includes('Formato incomum')) {
                    const confirmar = confirm(validacao.mensagem);
                    if (!confirmar) {
                        tentativas++;
                        continue;
                    }
                }
                
                numeroValidado = validacao.numeroFormatado;
                
                // Mostrar confirma√ß√£o final
                const confirmarNumero = confirm(
                    `üì± CONFIRMAR N√öMERO DO WHATSAPP\n\n` +
                    `N√∫mero: ${numeroValidado}\n` +
                    `Este n√∫mero receber√° todos os pedidos do sistema.\n\n` +
                    `‚úÖ Confirmar configura√ß√£o?`
                );
                
                if (!confirmarNumero) {
                    numeroValidado = null;
                    tentativas++;
                    continue;
                }
                
            } else {
                // Mostrar erro
                alert(validacao.mensagem);
                tentativas++;
                
                // Se for a √∫ltima tentativa, mostrar mensagem final
                if (tentativas >= maxTentativas) {
                    alert(`‚ùå N√∫mero m√°ximo de tentativas atingido!\n\n` +
                          `Configura√ß√£o do WhatsApp cancelada.\n` +
                          `Tente novamente mais tarde.`);
                    return;
                }
            }
        }
        
        if (cancelado) {
            console.log('Configura√ß√£o de WhatsApp cancelada');
            return;
        }
        
        if (!numeroValidado) {
            alert('‚ùå Nenhum n√∫mero v√°lido foi inserido.');
            return;
        }
        
        // üìù SALVAR NO FIREBASE
        await db.collection('config').doc('whatsapp').set({ 
            numero: numeroValidado,
            atualizadoEm: new Date().toISOString(),
            atualizadoPor: auth.currentUser?.uid
        }, { merge: true });
        
        // üìù LOG DO SISTEMA
        await sistemaLogs.registrar('config_whatsapp', {
            numeroMascarado: '***' + numeroValidado.slice(-4),
            digitos: numeroValidado.length,
            adminId: auth.currentUser?.uid,
            tentativasUsadas: tentativas
        });
        
        // üéâ MENSAGEM DE SUCESSO
        alert(`‚úÖ WHATSAPP CONFIGURADO COM SUCESSO!\n\n` +
              `üì± N√∫mero: ${numeroValidado}\n` +
              `üî¢ D√≠gitos: ${numeroValidado.length}\n` +
              `‚è±Ô∏è Tentativas: ${tentativas}\n\n` +
              `Todos os pedidos ser√£o enviados para este n√∫mero!`);
        
        console.log('‚úÖ WhatsApp configurado:', numeroValidado);
        
    } catch (error) {
        console.error(' Erro ao configurar WhatsApp:', error);
        alert('‚ùå Erro: ' + error.message);
    }
});
  
  toolbar.appendChild(configWhatsBtn);

  // BOT√ÉO ATIVAR/DESATIVAR CARRINHO
  const cartBtn = document.createElement('button');
  cartBtn.className = 'btn';
  cartBtn.style.cssText = 'background: #8e44ad; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  
  async function atualizarTextoBotaoCarrinho() {
    try {
      const cartCfg = await db.collection("config").doc("cart").get();
      const statusAtual = cartCfg.exists ? cartCfg.data().enabled !== false : true;
      cartBtn.textContent = statusAtual ? "üõë Desativar Carrinho" : "üü¢ Ativar Carrinho";
    } catch (error) {
      console.error("Erro ao carregar status do carrinho:", error);
    }
  }
  
  await atualizarTextoBotaoCarrinho();
  
  cartBtn.addEventListener("click", async () => {
    try {
      const cartCfg = await db.collection("config").doc("cart").get();
      const statusAtual = cartCfg.exists ? cartCfg.data().enabled !== false : true;
      const novoStatus = !statusAtual;
      
      await db.collection("config").doc("cart").set({ 
        enabled: novoStatus,
        atualizadoEm: new Date().toISOString() 
      }, { merge: true });
      
      // Atualizar vari√°vel global
      cartEnabled = novoStatus;
      
      // Limpar carrinho se desativando
      if (!novoStatus) {
        cart = [];
        localStorage.removeItem("cart");
        
        try {
          const snapshot = await db.collection("cart").get();
          if (!snapshot.empty) {
            const batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
          }
        } catch (firestoreError) {
          console.log("Firestore cart j√° est√° vazio");
        }
      }
      
      cartBtn.textContent = novoStatus ? "üõë Desativar Carrinho" : "üü¢ Ativar Carrinho";
      
      // üìù LOG DE ALTERA√á√ÉO DE STATUS
      await sistemaLogs.registrar('carrinho_status', {
        status: novoStatus ? 'ativado' : 'desativado',
        adminId: auth.currentUser?.uid,
        motivo: 'acao_administrativa'
      });
      
      const mensagem = novoStatus 
        ? "‚úÖ Carrinho ATIVADO!\n\nOs clientes podem adicionar produtos ao carrinho normalmente." 
        : "‚è∏Ô∏è Carrinho DESATIVADO!\n\n‚Ä¢ Bot√µes de compra desabilitados\n‚Ä¢ Carrinho atual foi esvaziado";
      
      alert(mensagem);
      
      // Atualizar interface sem fechar o painel
      if (typeof carregarProdutos === "function") carregarProdutos();
      if (typeof renderCart === "function") renderCart();
      if (typeof updateCartCount === "function") updateCartCount();
      
    } catch (error) {
      await sistemaLogs.registrar('carrinho_erro', {
        erro: error.message,
        adminId: auth.currentUser?.uid
      });
      alert("‚ùå Erro ao alterar status do carrinho: " + error.message);
    }
  });
  
  toolbar.appendChild(cartBtn);

  // BOT√ÉO PAUSAR ESTOQUE
  const estoqueBtn = document.createElement('button');
  estoqueBtn.className = 'btn';
  estoqueBtn.style.cssText = 'background: #f39c12; color: #fff; margin: 0; flex: 1; min-width: 200px;';
  
  async function atualizarTextoBotaoEstoque() {
    try {
      const estoqueStatus = await db.collection('config').doc('estoque').get();
      const estoquePausado = estoqueStatus.exists ? estoqueStatus.data().pausado : false;
      estoqueBtn.textContent = estoquePausado ? 'üü¢ Reativar Estoque' : 'üü° Pausar Estoque';
    } catch (error) {
      console.error("Erro ao carregar status do estoque:", error);
    }
  }
  
  await atualizarTextoBotaoEstoque();
  
  estoqueBtn.addEventListener('click', async () => {
    try {
      const estoqueStatus = await db.collection('config').doc('estoque').get();
      const estoquePausado = estoqueStatus.exists ? estoqueStatus.data().pausado : false;
      const novoStatus = !estoquePausado;
      
      await db.collection('config').doc('estoque').set({ pausado: novoStatus }, { merge: true });
      
      if (novoStatus) {
        cart = [];
        saveCart();
        if (typeof renderCart === 'function') renderCart();
        if (typeof updateCartCount === 'function') updateCartCount();
        
        // üìù LOG DE PAUSA DE ESTOQUE
        await sistemaLogs.registrar('estoque_status', {
          status: 'pausado',
          adminId: auth.currentUser?.uid
        });
        
        alert('‚è∏Ô∏è Estoque pausado!\n\n‚Ä¢ Cat√°logo bloqueado\n‚Ä¢ Carrinho esvaziado\n‚Ä¢ Pedidos suspensos');
      } else {
        // üìù LOG DE REATIVA√á√ÉO DE ESTOQUE
        await sistemaLogs.registrar('estoque_status', {
          status: 'reativado',
          adminId: auth.currentUser?.uid
        });
        
        alert('‚ñ∂Ô∏è Estoque reativado!\n\nSistema voltou ao normal.');
      }
      
      estoqueBtn.textContent = novoStatus ? 'üü¢ Reativar Estoque' : 'üü° Pausar Estoque';
      
      // Atualizar cat√°logo
      if (typeof carregarProdutos === 'function') {
        carregarProdutos();
      }
      
    } catch (error) {
      await sistemaLogs.registrar('estoque_erro', {
        erro: error.message,
        adminId: auth.currentUser?.uid
      });
      alert('‚ùå Erro ao alterar status do estoque: ' + error.message);
    }
  });
  
  toolbar.appendChild(estoqueBtn);

  
  // Adicionar toolbar antes da lista
  modalContent.insertBefore(toolbar, container);

  // LISTAR PRODUTOS (SEM VALIDA√á√ïES REPETIDAS)
  let productRows = [];
  
  snap.forEach(doc => {
    const p = doc.data();
    p._id = doc.id;

    const row = document.createElement('div');
    row.className = 'admin-row';
    row.style.cssText = `
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    `;
    
    row.innerHTML = `
      <img src="${p.img}" 
           style="
             width: 80px;
             height: 80px;
             object-fit: contain;
             border-radius: 8px;
             border: 1px solid #ccc;
             background-color: #f8f8f8;
           ">
      <div class="meta" style="flex: 1;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <strong style="font-size: 16px;">${escapeHtml(p.name)}</strong>
          <span style="
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: ${p.active ? '#27ae60' : '#e74c3c'};
            color: white;
          ">
            ${p.active ? 'ATIVO' : 'INATIVO'}
          </span>
        </div>
        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
          ${escapeHtml(p.desc || 'Sem descri√ß√£o')}
        </div>
        <div style="font-size: 12px; color: #888;">
          Estoque: <strong>${p.stock || 0}</strong> | 
          Pre√ßo unidade: <strong>${p.priceUnit ? 'R$ ' + p.priceUnit : 'N/A'}</strong> | 
          Pre√ßo kg: <strong>${p.priceKg ? 'R$ ' + p.priceKg : 'N/A'}</strong>
        </div>
      </div>
      <div class="admin-controls" style="display: flex; gap: 8px; flex-shrink: 0;">
        <button class="btn" id="btnEdit_${p._id}" 
          style="
            background: #3498db;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
          ‚úèÔ∏è Editar
        </button>
        <button class="btn" id="btnToggle_${p._id}"
          style="
            background: ${p.active ? '#e74c3c' : '#27ae60'};
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
          ${p.active ? 'üî¥ Desativar' : 'üü¢ Ativar'}
        </button>
        <button class="btn" id="btnDelete_${p._id}"
          style="
            background: #34495e;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
          üóëÔ∏è Remover
        </button>
      </div>
    `;
    
    container.appendChild(row);
    productRows.push({ row, data: p });

    // EDITAR PRODUTO (SEM VALIDA√á√ÉO DE SENHA)
    row.querySelector(`#btnEdit_${p._id}`).addEventListener('click', async () => {
      const snapRef = db.collection('produtos').doc(p._id);
      const snapData = (await snapRef.get()).data();
      
      const newName = prompt('Nome do produto:', snapData.name);
      if (newName === null) return; // Usu√°rio cancelou
      
      const newDesc = prompt('Descri√ß√£o:', snapData.desc || '');
      const newPriceUnit = prompt('Pre√ßo por unidade (deixe vazio se n√£o aplicar):', snapData.priceUnit || '');
      const newPriceKg = prompt('Pre√ßo por kg (deixe vazio se n√£o aplicar):', snapData.priceKg || '');
      const newOldPrice = prompt('Pre√ßo antigo (para promo√ß√£o):', snapData.oldPrice || '');
      const newImg = prompt('URL da imagem:', snapData.img || '');
      const newStock = prompt('Quantidade em estoque:', snapData.stock ?? '');
      
      try {
        await snapRef.update({
          name: newName || snapData.name,
          desc: newDesc,
          priceUnit: newPriceUnit === '' ? null : Number(newPriceUnit),
          priceKg: newPriceKg === '' ? null : Number(newPriceKg),
          oldPrice: newOldPrice === '' ? null : Number(newOldPrice),
          img: newImg || snapData.img,
          stock: newStock === '' ? 0 : Number(newStock),
          atualizadoEm: new Date().toISOString()
        });
        
        // üìù LOG DE EDI√á√ÉO DE PRODUTO
        await sistemaLogs.registrar('produto_editado', {
          produtoId: p._id,
          produtoNome: newName,
          estoqueAnterior: snapData.stock || 0,
          estoqueNovo: newStock === '' ? 0 : Number(newStock),
          adminId: auth.currentUser?.uid
        });
        
        alert('‚úÖ Produto atualizado com sucesso!');
        // Recarregar apenas esta linha
        renderAdminProductsContent();
        
      } catch (error) {
        alert('‚ùå Erro ao atualizar produto: ' + error.message);
      }
    });

    // ATIVAR/DESATIVAR PRODUTO (SEM VALIDA√á√ÉO) COM INVALIDA√á√ÉO DE CACHE
    row.querySelector(`#btnToggle_${p._id}`).addEventListener('click', async () => {
      const snapRef = db.collection('produtos').doc(p._id);
      const snapData = (await snapRef.get()).data();
      const newActive = !snapData.active;
      
      await snapRef.update({ 
        active: newActive,
        atualizadoEm: new Date().toISOString()
      });
      
      // üìù LOG DE ALTERA√á√ÉO DE STATUS DO PRODUTO
      await sistemaLogs.registrar('produto_status', {
        produtoId: p._id,
        produtoNome: snapData.name,
        status: newActive ? 'ativado' : 'desativado',
        adminId: auth.currentUser?.uid
      });
      
      alert(`‚úÖ Produto ${newActive ? 'ativado' : 'desativado'} com sucesso!`);
      
      // üî• INVALIDAR CACHE IMEDIATAMENTE
      produtosCache = null;
      ultimoCarregamentoCache = null;
      
      // Recarregar a lista do admin
      renderAdminProductsContent();
    });

    // REMOVER PRODUTO (SEM VALIDA√á√ÉO)
    row.querySelector(`#btnDelete_${p._id}`).addEventListener('click', async () => {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nTem certeza que deseja EXCLUIR permanentemente este produto?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) return;
      
      await db.collection('produtos').doc(p._id).delete();
      
      // üìù LOG DE EXCLUS√ÉO DE PRODUTO
      await sistemaLogs.registrar('produto_excluido', {
        produtoId: p._id,
        produtoNome: p.name,
        adminId: auth.currentUser?.uid
      });
      
      alert('‚úÖ Produto removido com sucesso!');
      
      // üî• INVALIDAR CACHE
      produtosCache = null;
      ultimoCarregamentoCache = null;
      
      renderAdminProductsContent();
    });
  });

  // FILTRAR PRODUTOS NA PESQUISA
  searchBar.addEventListener("input", () => {
    const text = searchBar.value.toLowerCase();
    productRows.forEach(prod => {
      const name = prod.data.name.toLowerCase();
      const desc = (prod.data.desc || "").toLowerCase();
      prod.row.style.display = name.includes(text) || desc.includes(text) ? "flex" : "none";
    });
  });

  // =========================
  // ADICIONAR MODAL AO DOM (O BOT√ÉO J√Å EST√Å CONFIGURADO)
  // =========================
  
  // Primeiro adicionamos o modal ao DOM
  modalDiv.appendChild(modalContent);
  document.body.appendChild(modalDiv);
  
  // FECHAR MODAL AO CLICAR FORA
  modalDiv.addEventListener('click', (e) => {
    if (e.target === modalDiv) {
      // Mesmo comportamento do bot√£o fechar
      modalDiv.remove();
      if (adminSessaoTimeout) {
        clearTimeout(adminSessaoTimeout);
        adminSessaoTimeout = null;
      }
      
      // üî• INVALIDAR CACHE
      produtosCache = null;
      ultimoCarregamentoCache = null;
      
      if (typeof carregarProdutos === 'function') {
        setTimeout(() => {
          carregarProdutos();
        }, 300);
      }
    }
  });

  // Aplicar melhorias para mobile
  setTimeout(() => {
    melhorarMobileAdmin();
    
    // Observar mudan√ßas no DOM para aplicar ajustes
    const observer = new MutationObserver(() => {
      melhorarMobileAdmin();
    });
    
    // Observar o container do admin
    const adminContainer = document.getElementById('adminProductsList');
    if (adminContainer) {
      observer.observe(adminContainer, {
        childList: true,
        subtree: true
      });
    }
    
    // Ajustar quando a orienta√ß√£o mudar
    window.addEventListener('resize', melhorarMobileAdmin);
    window.addEventListener('orientationchange', melhorarMobileAdmin);
  }, 300);
}

//--------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA CRIAR ADMIN NO FIREBASE
// =========================

window.criarAdminFirebase = async function(email, password, nome) {
    try {
        console.log('üëë Criando administrador no Firebase...');
        
        // Criar usu√°rio no Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Salvar no Firestore
        await db.collection('admin_access').doc(user.uid).set({
            email: email,
            nome: nome || 'Administrador',
            active: true,
            nivel: 'admin',
            criadoEm: new Date().toISOString(),
            criadoPor: auth.currentUser?.uid || 'sistema'
        });
        
        console.log('‚úÖ Administrador criado:', user.uid);
        alert(`‚úÖ Administrador criado com sucesso!\n\nEmail: ${email}\nSenha: ${password}\n\nAnote estas credenciais!`);
        return user.uid;
        
    } catch (error) {
        console.error('‚ùå Erro ao criar admin:', error);
        alert('‚ùå Erro ao criar admin: ' + error.message);
        throw error;
    }
};

// =========================
// FUN√á√ÉO DE LOGOUT
// =========================

window.logoutAdmin = async function() {
    try {
        await auth.signOut();
        window.adminAutenticado = false;
        
        // Limpar timeout da sess√£o
        if (window.adminSessaoTimeout) {
            clearTimeout(window.adminSessaoTimeout);
            window.adminSessaoTimeout = null;
        }
        
        // Fechar modal se estiver aberto
        document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());
        
        console.log('‚úÖ Logout realizado');
        alert('‚úÖ Logout realizado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro no logout:', error);
    }
};

// =========================
// FUN√á√ÉO PARA VERIFICAR PERMISS√ïES
// =========================

async function verificarPermissoesAdmin() {
    try {
        const user = auth.currentUser;
        if (!user) return false;
        
        const adminSnap = await db.collection('admin_access').doc(user.uid).get();
        return adminSnap.exists && adminSnap.data().active !== false;
        
    } catch (error) {
        console.error('Erro ao verificar permiss√µes:', error);
        return false;
    }
}

// =========================
// LISTENER PARA AUTENTICA√á√ÉO
// =========================

// Monitorar estado de autentica√ß√£o
auth.onAuthStateChanged((user) => {
    if (user) {
        console.log('üë§ Usu√°rio autenticado:', user.email);
        
        // Verificar se tem permiss√µes de admin
        db.collection('admin_access').doc(user.uid).get()
            .then(snap => {
                if (snap.exists && snap.data().active !== false) {
                    window.adminAutenticado = true;
                } else {
                    window.adminAutenticado = false;
                }
            });
    } else {
        console.log('üë§ Usu√°rio n√£o autenticado');
        window.adminAutenticado = false;
    }
});



//--------------------------------------------------------------------------------------------------------

// =========================
// CONFIGURAR EVENTOS
// =========================
document.getElementById('adminLink').addEventListener('click', e=>{ 
  e.preventDefault(); 
  renderAdminProducts(); 
});

//BOT√ÉO ABRIR CARRINHO
document.getElementById('btnOpenCart').addEventListener('click', e=>{ 
  if (!cartEnabled) {
    alert("‚è∏Ô∏è Carrinho est√° desativado no momento. Ative-o no painel admin para comprar.");
    return;
  }
  document.getElementById('cartCard').style.display='block'; 
  document.getElementById('catalogCard').style.display='none'; 
  renderCart(); 
  
  // üî•üî•üî• **ADICIONE ESTA PARTE AQUI** üî•üî•üî•
  setTimeout(() => {
    console.log(' Verificando PIX ao abrir carrinho...');
    
    // Atualizar display da chave PIX
    const pixDisplay = document.getElementById('pixKeyDisplay');
    if (pixDisplay && rawPixPhone) {
        pixDisplay.textContent = rawPixPhone;
        console.log(' PIX atualizado no display:', rawPixPhone);
    }
    
    // Se tiver produtos, gerar c√≥digo PIX
    if (window.cart && window.cart.length > 0) {
        const total = window.cart.reduce((sum, item) => 
            sum + (item.unitPrice * item.qty), 0);
        
        if (total > 0 && rawPixPhone) {
            const pixEl = document.getElementById('pixPayload');
            if (pixEl) {
                const pixCode = buildPixEMV(rawPixPhone, merchantName, merchantCity, total);
                pixEl.value = pixCode;
                console.log(' C√≥digo PIX gerado para total:', total);
            }
        }
    }
    
    // Reconfigurar bot√£o copiar
    if (typeof configurarBotaoCopiarPix === 'function') {
        setTimeout(() => {
            configurarBotaoCopiarPix();
        }, 100);
    }
  }, 200);
  // üî•üî•üî• **FIM DA PARTE ADICIONADA** üî•üî•üî•
});

document.getElementById('btnUseLocation')?.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const link = `https://www.google.com/maps?q=${lat},${lng}`;
      document.getElementById('clientLocation').value = link;
      alert("Localiza√ß√£o capturada com sucesso!");
    },
    (err) => {
      alert("N√£o foi poss√≠vel obter a localiza√ß√£o. Ative o GPS e tente novamente.");
    }
  );
});



//-----------------------------------------------------------------------------------------------

// ========CORRIGIDO===========
// INICIALIZA√á√ÉO OTIMIZADA COM LISTENER DE TEMPO REAL
// =========================

// Modificar a inicializa√ß√£o para usar cache
  document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log(' Sistema inicializando (vers√£o otimizada)...');
    
    // PASSO 4: Inicializar exibi√ß√£o do usu√°rio (antes de tudo)
    atualizarExibicaoUsuario();
    
    // 1. PRIMEIRO: Autenticar
      await auth.signInAnonymously().catch(() => {
        console.log(' Autentica√ß√£o em segundo plano');
      });

      // 2. CARREGAR TAXA DE ENTREGA PRIMEIRO
      await carregarTaxaEntrega();

      // 3. DEPOIS carregar PIX (que depende da taxa)
      await inicializarPix();
    
    // 2. Carregar carrinho do localStorage AP√ìS autentica√ß√£o
    const savedCart = localStorage.getItem('cart'); // Isso ser√° redirecionado para horti2_cart
    if (savedCart) {
      try {
        cart = JSON.parse(savedCart);
        console.log('üõí Carrinho carregado do localStorage:', cart.length, 'itens');
      } catch (e) {
        console.error('‚ùå Erro ao carregar carrinho:', e);
        cart = [];
      }
    }
   //------------ 
    // 3. Adicionar real-time listener para produtos (ATUALIZA√á√ÉO EM TEMPO REAL)
    db.collection('produtos').onSnapshot((snapshot) => {
      console.log(' Atualiza√ß√£o em tempo real de produtos detectada');
      
      // Invalidar cache quando houver mudan√ßas
      produtosCache = null;
      ultimoCarregamentoCache = null;
      
      // Recarregar produtos se o cat√°logo estiver vis√≠vel
      if (typeof carregarProdutos === 'function' && 
          document.getElementById('catalogCard').style.display !== 'none') {
        setTimeout(() => {
          carregarProdutos();
        }, 500);
      }
    });
    
    // 4. Configurar listener do status do carrinho
    db.collection("config").doc("cart").onSnapshot(() => {
      atualizarStatusCarrinhoUnificado();
    });
    
    // 5. Carregar status inicial do carrinho
    await atualizarStatusCarrinhoUnificado();
    
    // 6. Atualizar contador do carrinho IMEDIATAMENTE
    updateCartCount();
    
    // 7. Carregar produtos (usando vers√£o otimizada)
    await carregarProdutosOtimizado();
    
    // 8. Adicionar evento de pesquisa
    document.getElementById('searchInput').addEventListener('input', () => {
      carregarProdutos();
    });
    
    // 9. Atualizar carrinho visual se houver itens
    if (cart.length > 0) {
      console.log(' Renderizando carrinho com', cart.length, 'itens...');
      renderCart();
    }
    
    console.log('‚úÖ Sistema inicializado com sucesso!');
    
  } catch (error) {
    console.error(' Erro na inicializa√ß√£o:', error);
    alert('Erro ao carregar o sistema. Recarregue a p√°gina.');
  }
});

// =========================
// FERRAMENTA DE EMERG√äNCIA AVAN√áADA - VERS√ÉO COM MODAL HTML (CORRIGIDA)
// =========================

window.reporEstoqueManual = async function() {
  try {
    console.log('üîç Buscando produtos para reposi√ß√£o...');
    
    // Buscar produtos
    const querySnapshot = await db.collection('produtos').orderBy('name').get();
    const produtos = [];
    
    // Usar contador MANUAL para garantir n√∫meros corretos
    let contador = 0;
    
    querySnapshot.forEach((doc) => {
      contador++; // Incrementar primeiro
      const dados = doc.data();
      produtos.push({
        id: doc.id,
        numero: contador, // Usar contador manual
        nome: dados.name || 'Produto sem nome',
        estoque: dados.stock || 0,
        precoUnidade: dados.priceUnit || 0,
        precoKg: dados.priceKg || 0,
        imagem: dados.img || 'https://via.placeholder.com/100x100?text=Sem+imagem' // <-- ADICIONADO
      });
    });
    
    console.log(` ${produtos.length} produtos carregados`);
    
    // Criar modal HTML
    const modalHTML = `
      <div id="estoqueModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100002 !important;  // <-- AQUI EST√Å A CORRE√á√ÉO
        font-family: Arial, sans-serif;
      ">
        <div style="
          background: white;
          border-radius: 10px;
          width: 90%;
          max-width: 900px; <!-- Aumentado para caber imagens -->
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="
            background: linear-gradient(90deg, #16a085, #1abc9c);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0; font-size: 18px;">
              üì¶ REPOSI√á√ÉO DE ESTOQUE - ${produtos.length} PRODUTOS
            </h3>
            <button id="closeModalBtn" style="
              background: #e74c3c;
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 4px;
              cursor: pointer;
              font-weight: bold;
            ">
              X FECHAR
            </button>
          </div>
          
          <div style="padding: 15px; max-height: 60vh; overflow-y: auto;">
            <div style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); <!-- Aumentado -->
              gap: 15px;
              margin-bottom: 15px;
            " id="produtosGrid">
              ${produtos.map(prod => {
                // Calcular pre√ßo para mostrar
                let precoMostrar = 0;
                let tipoPreco = '';
                
                if (prod.precoUnidade > 0) {
                  precoMostrar = prod.precoUnidade;
                  tipoPreco = '(unidade)';
                } else if (prod.precoKg > 0) {
                  precoMostrar = prod.precoKg;
                  tipoPreco = '(kg)';
                }
                
                return `
                <div style="
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  padding: 12px;
                  background: #f9f9f9;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  text-align: center;
                " 
                class="produto-item"
                data-numero="${prod.numero}"
                onclick="selecionarProdutoEstoqueModal(${prod.numero})">
                
                  <!-- IMAGEM DO PRODUTO (NOVA) -->
                  <div style="
                    width: 100%;
                    height: 120px;
                    margin-bottom: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    overflow: hidden;
                    border-radius: 6px;
                    background: #f0f0f0;
                  ">
                    <img src="${prod.imagem}" 
                         alt="${prod.nome}"
                         style="
                           max-width: 100%;
                           max-height: 100%;
                           object-fit: contain;
                         "
                         onerror="this.src='https://via.placeholder.com/100x100?text=Sem+imagem'">
                  </div>
                  
                  <!-- INFORMA√á√ïES DO PRODUTO -->
                  <div style="width: 100%;">
                    <div style="
                      font-weight: bold; 
                      color: #2c3e50; 
                      margin-bottom: 5px;
                      font-size: 14px;
                      height: 40px;
                      overflow: hidden;
                      display: -webkit-box;
                      -webkit-line-clamp: 2;
                      -webkit-box-orient: vertical;
                    ">
                      [${prod.numero}] ${prod.nome}
                    </div>
                    
                    <!-- ESTOQUE COM √çCONE -->
                    <div style="
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      gap: 5px;
                      margin: 8px 0;
                      font-size: 13px;
                      color: #555;
                      background: #e8f5e9;
                      padding: 4px 8px;
                      border-radius: 4px;
                    ">
                      <span style="font-weight: bold;">üì¶</span>
                      <span>Estoque: <strong>${prod.estoque}</strong></span>
                    </div>
                    
                    <!-- PRE√áO -->
                    <div style="
                      font-size: 13px; 
                      color: ${precoMostrar > 0 ? '#27ae60' : '#e74c3c'}; 
                      background: ${precoMostrar > 0 ? '#f0f9f0' : '#fef0f0'};
                      padding: 4px 8px;
                      border-radius: 4px;
                      margin-top: 5px;
                    ">
                      <span style="font-weight: bold;">üí∞</span>
                      R$ ${precoMostrar.toFixed(2)}
                      ${tipoPreco ? ' ' + tipoPreco : ''}
                    </div>
                  </div>
                </div>
              `}).join('')}
            </div>
            
            <div style="
              border-top: 2px solid #eee;
              padding-top: 15px;
              text-align: center;
            ">
              <div style="margin-bottom: 10px; font-weight: bold; color: #7f8c8d;">
                OU DIGITE O N√öMERO DO PRODUTO:
              </div>
              <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <input type="number" 
                  id="numeroProdutoInput"
                  placeholder="N√∫mero (1-${produtos.length})"
                  min="1"
                  max="${produtos.length}"
                  style="
                    padding: 10px;
                    border: 2px solid #3498db;
                    border-radius: 6px;
                    width: 120px;
                    text-align: center;
                    font-size: 16px;
                  ">
                <button id="selecionarPorNumeroBtn" style="
                  background: #3498db;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: bold;
                  font-size: 14px;
                ">
                  üìã SELECIONAR
                </button>
              </div>
            </div>
          </div>
          
          <div style="
            background: #f8f9fa;
            padding: 12px 20px;
            text-align: center;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 13px;
          ">
            <strong>${produtos.length}</strong> produtos dispon√≠veis ‚Ä¢ Clique em um produto ou digite o n√∫mero
          </div>
        </div>
      </div>
    `;
    
    // Remover modal anterior se existir
    const modalAntigo = document.getElementById('estoqueModal');
    if (modalAntigo) modalAntigo.remove();
    
    // Limpar fun√ß√£o anterior
    if (window.selecionarProdutoEstoqueModal) {
      delete window.selecionarProdutoEstoqueModal;
    }
    
    // Adicionar modal ao corpo
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Fun√ß√£o para selecionar produto
    window.selecionarProdutoEstoqueModal = async function(numeroProduto) {
      console.log(' Produto selecionado:', numeroProduto);
      
      const produto = produtos.find(p => p.numero === numeroProduto);
      
      if (!produto) {
        alert('‚ùå Produto n√£o encontrado!');
        return;
      }
      
      // Remover modal
      const modal = document.getElementById('estoqueModal');
      if (modal) modal.remove();
      
      // Pedir nova quantidade
      const novaQtd = prompt(
        `üìä ATUALIZAR ESTOQUE\n\n` +
        `Produto: ${produto.nome}\n` +
        `Estoque atual: ${produto.estoque}\n\n` +
        `Digite a nova quantidade:`
      );
      
      if (novaQtd === null) {
        console.log(' Opera√ß√£o cancelada pelo usu√°rio');
        return;
      }
      
      const quantidade = parseInt(novaQtd);
      
      if (isNaN(quantidade) || quantidade < 0) {
        alert('‚ùå Quantidade inv√°lida! Digite um n√∫mero v√°lido (ex: 0, 10, 25).');
        return;
      }
      
      // Confirmar
      const diferenca = quantidade - produto.estoque;
      const confirmar = confirm(
        `‚ö†Ô∏è CONFIRMAR ATUALIZA√á√ÉO?\n\n` +
        `Produto: ${produto.nome}\n` +
        `Estoque atual: ${produto.estoque}\n` +
        `Novo estoque: ${quantidade}\n` +
        `Diferen√ßa: ${diferenca >= 0 ? '+' : ''}${diferenca} unidades`
      );
      
      if (!confirmar) {
        alert('‚ùå Atualiza√ß√£o cancelada.');
        return;
      }
      
      // Mostrar loading
      const loadingMsg = `üîÑ Atualizando ${produto.nome}...`;
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #2c3e50;
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: bold;
      `;
      loadingDiv.textContent = loadingMsg;
      document.body.appendChild(loadingDiv);
      
      try {
        // Atualizar no Firebase
        await db.collection('produtos').doc(produto.id).update({
          stock: quantidade,
          atualizadoEm: new Date().toISOString()
        });
        
        // üìù LOG DE ALTERA√á√ÉO DE ESTOQUE
        if (typeof sistemaLogs !== 'undefined' && sistemaLogs.registrar) {
          await sistemaLogs.registrar('estoque_alterado', {
            produtoId: produto.id,
            produtoNome: produto.nome,
            estoqueAnterior: produto.estoque,
            estoqueNovo: quantidade,
            diferenca: diferenca,
            adminId: auth.currentUser?.uid
          });
        }
        
        // Remover loading
        loadingDiv.remove();
        
        // Mostrar sucesso
        alert(`‚úÖ ESTOQUE ATUALIZADO!\n\n` +
              `üì¶ ${produto.nome}\n` +
              `üîÑ ${produto.estoque} ‚Üí ${quantidade}\n` +
              `üìà ${diferenca >= 0 ? '+' : ''}${diferenca} unidades`);
        
        // üî• INVALIDAR CACHE
        if (typeof produtosCache !== 'undefined') {
          produtosCache = null;
        }
        if (typeof ultimoCarregamentoCache !== 'undefined') {
          ultimoCarregamentoCache = null;
        }
        
        // Recarregar produtos
        if (typeof carregarProdutos === 'function') {
          setTimeout(() => {
            carregarProdutos();
            console.log(' Cat√°logo recarregado');
          }, 500);
        }
        
      } catch (error) {
        loadingDiv.remove();
        console.error(' Erro ao atualizar:', error);
        if (typeof sistemaLogs !== 'undefined' && sistemaLogs.registrar) {
          await sistemaLogs.registrar('estoque_erro', {
            erro: error.message,
            produtoId: produto.id,
            adminId: auth.currentUser?.uid
          });
        }
        alert(`‚ùå Erro ao atualizar estoque:\n\n${error.message}`);
      }
    };
    
    // Configurar eventos
    document.getElementById('closeModalBtn').addEventListener('click', function() {
      const modal = document.getElementById('estoqueModal');
      if (modal) modal.remove();
    });
    
    document.getElementById('selecionarPorNumeroBtn').addEventListener('click', function() {
      const input = document.getElementById('numeroProdutoInput');
      const numero = parseInt(input.value);
      
      if (isNaN(numero) || numero < 1 || numero > produtos.length) {
        alert(`‚ùå N√∫mero inv√°lido!\n\nDigite um n√∫mero entre 1 e ${produtos.length}`);
        return;
      }
      
      window.selecionarProdutoEstoqueModal(numero);
    });
    
    document.getElementById('numeroProdutoInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('selecionarPorNumeroBtn').click();
      }
    });
    
    // Fechar modal ao clicar fora
    document.getElementById('estoqueModal').addEventListener('click', function(e) {
      if (e.target.id === 'estoqueModal') {
        this.remove();
      }
    });
    
    // Adicionar efeito hover aos cards
    setTimeout(() => {
      const cards = document.querySelectorAll('.produto-item');
      cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-3px)';
          this.style.boxShadow = '0 6px 15px rgba(0,0,0,0.1)';
          this.style.borderColor = '#3498db';
          this.style.background = '#f0f8ff';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
          this.style.borderColor = '#ddd';
          this.style.background = '#f9f9f9';
        });
      });
    }, 100);
    
  } catch (error) {
    console.error(' Erro na fun√ß√£o reporEstoqueManual:', error);
    alert('‚ùå Erro ao carregar produtos: ' + error.message);
  }
};
// =========================
// FUN√á√ÉO PARA CORRIGIR PIX EXISTENTE (executar no console F12)
// =========================
window.corrigirPixNoFirebase = async function() {
  try {
    const pixSnap = await db.collection('config').doc('pix').get();
    
    if (pixSnap.exists) {
      const dados = pixSnap.data();
      
      // Se j√° tem chave mas n√£o tem nome, adiciona
      if (dados.chave && !dados.nomeTitular) {
        const nome = prompt(
          'Digite o nome do titular da chave PIX:\n\n' +
          'Chave atual: ' + dados.chave + '\n\n' +
          'Este nome aparecer√° no QR Code PIX:',
          'NOME DO TITULAR'
        );
        
        const cidade = prompt(
          'Digite a cidade do titular:',
          'CIDADE'
        );
        
        if (nome && cidade) {
          await db.collection('config').doc('pix').update({
            nomeTitular: nome.trim(),
            cidadeTitular: cidade.trim(),
            atualizadoEm: new Date().toISOString()
          });
          
          alert('‚úÖ PIX corrigido no Firebase!\n\nNome: ' + nome + '\nCidade: ' + cidade);
          
          // Recarregar p√°gina para aplicar
          location.reload();
        }
      } else {
        alert('‚úÖ PIX j√° est√° configurado corretamente.');
      }
    } else {
      alert('‚ùå Nenhuma configura√ß√£o PIX encontrada.');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('‚ùå Erro: ' + error.message);
  }
};

// =========================
// MODO T√âCNICO - FUN√á√ÉO COM SENHA EXCLUSIVA (MODIFICADA)
// =========================
window.ativarModoTecnico = async function() {
    console.log('üîß Solicitando acesso ao modo t√©cnico...');
    
    // Fun√ß√£o para criar modal de senha
    function criarModalSenhaTecnico() {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                font-family: Arial, sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <h3 style="color: #f39c12; margin-top: 0; text-align: center;">üîß ACESSO MODO T√âCNICO</h3>
                    
                    <p style="text-align: center; color: #bdc3c7; margin-bottom: 20px;">
                        Digite a senha do modo t√©cnico (senha exclusiva):
                    </p>
                    
                    <input type="password" 
                           id="senhaModoTecnico" 
                           placeholder="Digite a senha do t√©cnico"
                           style="
                               width: 100%;
                               padding: 12px;
                               border-radius: 6px;
                               border: 2px solid #f39c12;
                               background: #34495e;
                               color: white;
                               font-size: 16px;
                               margin-bottom: 20px;
                               box-sizing: border-box;
                           "
                           autofocus>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="btnCancelarTecnico"
                                style="
                                    background: #7f8c8d;
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    flex: 1;
                                    font-weight: bold;
                                ">
                            ‚ùå Cancelar
                        </button>
                        
                        <button id="btnConfirmarTecnico"
                                style="
                                    background: #2ecc71;
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    flex: 1;
                                    font-weight: bold;
                                ">
                            ‚úÖ Acessar
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: #95a5a6; text-align: center;">
                        Senha exclusiva para acesso t√©cnico (diferente do admin)
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const senhaInput = document.getElementById('senhaModoTecnico');
            const btnConfirmar = document.getElementById('btnConfirmarTecnico');
            const btnCancelar = document.getElementById('btnCancelarTecnico');
            
            senhaInput.focus();
            
            const removerModal = () => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            };
            
            btnConfirmar.onclick = async () => {
                const senha = senhaInput.value;
                if (!senha) {
                    alert('‚ùå Digite a senha do t√©cnico!');
                    return;
                }
                
                // Verificar senha DO T√âCNICO (exclusiva)
                const senhaHash = await hashSenha(senha);
                const senhaValida = await verificarSenhaTecnico(senhaHash); // <-- MUDAN√áA AQUI
                
                if (!senhaValida) {
                    // Log de tentativa falha
                    await sistemaLogs.registrar('acesso_tecnico_falha', {
                        motivo: 'senha_incorreta',
                        ip: await getUserIP()
                    });
                    
                    alert('‚ùå Senha do modo t√©cnico incorreta!');
                    return;
                }
                
                removerModal();
                
                // Log de acesso bem-sucedido
                await sistemaLogs.registrar('acesso_tecnico_sucesso', {
                    usuario: auth.currentUser?.uid,
                    ip: await getUserIP()
                });
                
                resolve(true); // Acesso permitido
            };
            
            btnCancelar.onclick = () => {
                removerModal();
                resolve(false); // Acesso cancelado
            };
            
            // Enter para confirmar
            senhaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    btnConfirmar.click();
                }
            });
            
            // ESC para cancelar
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    btnCancelar.click();
                }
            });
        });
    }
    
    // Solicitar senha do t√©cnico (n√£o do admin)
    const acessoPermitido = await criarModalSenhaTecnico();
    
    if (acessoPermitido) {
        console.log(' Acesso ao modo t√©cnico autorizado!');
        adminAutenticado = true; // Permite acesso √†s fun√ß√µes protegidas
        criarPainelTecnico();
    } else {
        console.log(' Acesso ao modo t√©cnico negado ou cancelado.');
    }
};

//------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO SEPARADA PARA CRIAR O PAINEL T√âCNICO (MODIFICADA)
// =========================
function criarPainelTecnico() {
    console.log('üîß Criando painel t√©cnico...');
    
    // Remover painel anterior se existir
    const painelAnterior = document.getElementById('painelTecnico');
    if (painelAnterior) {
        painelAnterior.remove();
    }
    
    // Criar painel t√©cnico flutuante
    const painelTecnico = document.createElement('div');
    painelTecnico.id = 'painelTecnico';
    painelTecnico.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: #2c3e50;
        color: white;
        padding: 15px;
        border-radius: 10px;
        z-index: 999998;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        width: 320px;
        max-height: 80vh;
        overflow-y: auto;
        font-family: Arial, sans-serif;
        border: 2px solid #f39c12;
    `;
    
    painelTecnico.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #34495e; padding-bottom: 10px;">
            <h3 style="margin: 0; color: #f39c12; font-size: 16px;">üîß MODO T√âCNICO</h3>
            <button id="fecharPainelTecnico" style="background: #e74c3c; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 12px;">
                ‚úï FECHAR
            </button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: #2ecc71;">üìä STATUS DO SISTEMA:</strong>
            <div style="font-size: 12px; margin-top: 8px; background: #34495e; padding: 8px; border-radius: 5px;">
                <div>UID: ${auth.currentUser?.uid || 'N√£o autenticado'}</div>
                <div>Email: ${auth.currentUser?.email || 'An√¥nimo'}</div>
                <div>PIX: ${rawPixPhone ? '***' + rawPixPhone.slice(-4) : 'N√£o configurado'}</div>
                <div>Carrinho: ${cartEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</div>
                <div>Itens no carrinho: ${cart.length}</div>
                <div>Modo T√©cnico: ‚úÖ Ativo</div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: #f39c12;">‚öôÔ∏è FERRAMENTAS R√ÅPIDAS:</strong>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                <button onclick="testarPIX()" style="background: #9b59b6; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîç Testar PIX
                </button>
                <button onclick="verLogs()" style="background: #3498db; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üìã Ver Logs
                </button>
                <button onclick="limparCacheLocal()" style="background: #e74c3c; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üóëÔ∏è Limpar Cache
                </button>
                <button onclick="recarregarProdutos()" style="background: #2ecc71; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîÑ Recarregar Produtos
                </button>
                <button onclick="verSenhasSistema()" style="background: #8e44ad; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîê Ver Senhas
                </button>
                <button onclick="trocarSenhaTecnico()" style="background: #f39c12; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîß Alterar Senha T√©cnico
                </button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: #9b59b6;">üíæ BACKUP & RESTAURA√á√ÉO:</strong>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                <button onclick="criarBackupCompleto()" style="background: #9b59b6; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üíæ Criar Backup Completo
                </button>
                <button onclick="restaurarBackup()" style="background: #3498db; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîÑ Restaurar Backup
                </button>
                <button onclick="configurarBackupAutomatico()" style="background: #f39c12; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    ‚è∞ Backup Autom√°tico
                </button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: #1abc9c;">üîç DIAGN√ìSTICO:</strong>
            <div style="font-size: 12px; margin-top: 8px; background: #34495e; padding: 8px; border-radius: 5px;">
                <button onclick="executarDiagnostico()" style="width: 100%; background: #16a085; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-bottom: 8px;">
                    ü©∫ Diagn√≥stico Completo
                </button>
                <div id="resultadoDiagnostico" style="font-size: 11px; color: #bdc3c7; max-height: 100px; overflow-y: auto; margin-top: 8px;"></div>
            </div>
        </div>
        
        <div>
            <strong style="color: #e74c3c;">‚ö†Ô∏è EMERG√äNCIA:</strong>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                <button onclick="window.forceCloseButton()" style="background: #c0392b; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üí£ Fechar Tudo
                </button>
                <button onclick="resetarSistema()" style="background: #d35400; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    ‚ôªÔ∏è Resetar Sistema
                </button>
                <button onclick="resetarSenhasPadrao()" style="background: #d35400; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 13px; text-align: left;">
                    üîÑ Redefinir Senhas
                </button>
            </div>
        </div>
        
        <div style="margin-top: 15px; font-size: 10px; color: #95a5a6; text-align: center; border-top: 1px solid #34495e; padding-top: 10px;">
            Modo T√©cnico - ${new Date().toLocaleTimeString('pt-BR')}
        </div>
    `;
    
    document.body.appendChild(painelTecnico);
    
    // Configurar bot√£o fechar
    document.getElementById('fecharPainelTecnico').onclick = function() {
        painelTecnico.remove();
    };
    
    // Fechar com ESC
    const fecharComESC = function(e) {
        if (e.key === 'Escape' && document.getElementById('painelTecnico')) {
            document.getElementById('painelTecnico').remove();
            document.removeEventListener('keydown', fecharComESC);
        }
    };
    document.addEventListener('keydown', fecharComESC);
    
    console.log('‚úÖ Painel t√©cnico criado com backup!');
}

//------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA ALTERAR SENHA DO T√âCNICO - NOVA
// =========================
window.trocarSenhaTecnico = async function() {
  console.log(' Alterando senha do modo t√©cnico...');
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000001;
  `;
  
  modal.innerHTML = `
    <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
      <h3 style="color: #f39c12; margin-top: 0; text-align: center;">üîß ALTERAR SENHA DO MODO T√âCNICO</h3>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Senha Atual do T√©cnico:</label>
        <input type="password" id="senhaAtualTecnico" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #f39c12; background: #34495e; color: white;"
              placeholder="Digite a senha atual">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Nova Senha:</label>
        <input type="password" id="novaSenhaTecnico" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
              placeholder="Digite a nova senha">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px;">Confirmar Nova Senha:</label>
        <input type="password" id="confirmarSenhaTecnico" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
              placeholder="Digite novamente">
      </div>
      
      <div style="background: #34495e; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;">
        <strong>üìù Importante:</strong><br>
        ‚Ä¢ Esta senha √© usada APENAS para o modo t√©cnico<br>
        ‚Ä¢ N√£o afeta a senha do administrador<br>
        ‚Ä¢ Recomendado: senha diferente da admin
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="btnCancelarTec" 
                style="background: #7f8c8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
          ‚ùå Cancelar
        </button>
        <button id="btnConfirmarTec" 
                style="background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
          ‚úÖ Confirmar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Fechar modal ao clicar fora
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  document.getElementById('btnCancelarTec').onclick = function() {
    modal.remove();
  };
  
  document.getElementById('btnConfirmarTec').onclick = async function() {
    const senhaAtual = document.getElementById('senhaAtualTecnico').value;
    const novaSenha = document.getElementById('novaSenhaTecnico').value;
    const confirmarSenha = document.getElementById('confirmarSenhaTecnico').value;
    
    // Valida√ß√µes
    if (!senhaAtual || !novaSenha || !confirmarSenha) {
      alert('‚ùå Todos os campos s√£o obrigat√≥rios!');
      return;
    }
    
    if (novaSenha !== confirmarSenha) {
      alert('‚ùå As novas senhas n√£o coincidem!');
      return;
    }
    
    if (novaSenha.length < 4) {
      alert('‚ùå A senha deve ter pelo menos 4 caracteres!');
      return;
    }
    
    try {
      // Verificar senha atual
      const senhaAtualHash = await hashSenha(senhaAtual);
      const senhaValida = await verificarSenhaTecnico(senhaAtualHash);
      
      if (!senhaValida) {
        alert('‚ùå Senha atual incorreta!');
        return;
      }
      
      // Calcular hash da nova senha
      const novaSenhaHash = await hashSenha(novaSenha);
      
      // Atualizar no Firebase
      await db.collection('config').doc('tecnico_senha').set({
        senha: novaSenhaHash,
        atualizadoEm: new Date().toISOString(),
        atualizadoPor: auth.currentUser?.uid,
        ultimaAlteracao: new Date().toISOString()
      }, { merge: true });
      
      // Log da altera√ß√£o
      await sistemaLogs.registrar('senha_tecnico_alterada', {
        alteradoPor: auth.currentUser?.uid,
        ip: await getUserIP()
      });
      
      // Fechar modal
      modal.remove();
      
      // Mostrar sucesso
      alert(`‚úÖ SENHA DO T√âCNICO ALTERADA!\n\nNova senha configurada com sucesso.\n\nAnote em local seguro!`);
      
      console.log(' Senha do t√©cnico alterada com sucesso!');
      
    } catch (error) {
      console.error(' Erro ao alterar senha:', error);
      alert('‚ùå Erro: ' + error.message);
    }
  };
  
  // Focar no primeiro campo
  document.getElementById('senhaAtualTecnico').focus();
  
  // Enter para confirmar
  modal.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('btnConfirmarTec').click();
    }
  });
};

// =========================
// PROTEGER FUN√á√ïES T√âCNICAS
// =========================
const funcoesTecnicasOriginais = {
    testarPIX: window.testarPIX,
    verLogs: window.verLogs,
    executarDiagnostico: window.executarDiagnostico,
    verSenhasSistema: window.verSenhasSistema,
    resetarSenhasPadrao: window.resetarSenhasPadrao
};

// Sobrescrever fun√ß√µes para exigir autentica√ß√£o
window.testarPIX = async function() {
    if (!adminAutenticado) {
        console.log(' Acesso n√£o autorizado. Use ativarModoTecnico() primeiro.');
        alert('‚ùå Acesso n√£o autorizado!\n\nUse ativarModoTecnico() e autentique-se primeiro.');
        return;
    }
    return funcoesTecnicasOriginais.testarPIX();
};

window.verLogs = async function() {
    if (!adminAutenticado) {
        alert('‚ùå Acesso n√£o autorizado!\n\nAutentique-se no modo t√©cnico primeiro.');
        return;
    }
    return funcoesTecnicasOriginais.verLogs();
};

window.executarDiagnostico = async function() {
    if (!adminAutenticado) {
        alert('‚ùå Acesso n√£o autorizado!\n\nAutentique-se no modo t√©cnico primeiro.');
        return;
    }
    return funcoesTecnicasOriginais.executarDiagnostico();
};

window.verSenhasSistema = async function() {
    if (!adminAutenticado) {
        alert('‚ùå Acesso restrito!\n\nSomente usu√°rios autenticados podem ver senhas.');
        return;
    }
    return funcoesTecnicasOriginais.verSenhasSistema();
};

window.resetarSenhasPadrao = async function() {
    if (!adminAutenticado) {
        alert('‚ùå Opera√ß√£o n√£o permitida!\n\nAutentique-se primeiro.');
        return;
    }
    return funcoesTecnicasOriginais.resetarSenhasPadrao();
};

// ============================================
// GARANTIA EXTRA: SISTEMA QUE MONITORA O BOT√ÉO
// ============================================

// Observador para garantir que o bot√£o sempre funcione
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.type === 'childList') {
      const closeBtn = document.getElementById('adminCloseBtn');
      if (closeBtn && !closeBtn.hasAttribute('data-ja-configurado')) {
        console.log(' Bot√£o detectado - aplicando garantia...');
        
        // Marcar como configurado
        closeBtn.setAttribute('data-ja-configurado', 'true');
        
        // Configurar evento COM INVALIDA√á√ÉO DE CACHE
        closeBtn.onclick = function(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
          }
          
          console.log(' Bot√£o (garantia) clicado - Fechando...');
          
          // Remover modal
          const modal = document.querySelector('.modal-backdrop');
          if (modal) {
            modal.remove();
          }
          
          // Limpar timeout
          if (window.adminSessaoTimeout) {
            clearTimeout(window.adminSessaoTimeout);
            window.adminSessaoTimeout = null;
          }
          
          // üî• INVALIDAR CACHE
          produtosCache = null;
          ultimoCarregamentoCache = null;
          
          // Recarregar produtos
          if (typeof window.carregarProdutos === 'function') {
            setTimeout(() => {
              window.carregarProdutos();
            }, 300);
          }
          
          return false;
        };
        
       // Aplicar estilo verde
        closeBtn.style.cssText = `
          background: #2ecc71 !important;
          color: white !important;
          border: none !important;
          padding: 10px 20px !important;
          border-radius: 8px !important;
          cursor: pointer !important;
          font-weight: bold !important;
          font-size: 15px !important;
          box-shadow: 0 4px 15px rgba(46, 204, 113, 0.7) !important;
          position: relative !important;
          z-index: 9999 !important;
          min-width: 140px !important;
          text-align: center !important;
        `;
      }
    }
  });
});

// Iniciar observa√ß√£o
observer.observe(document.body, {
  childList: true,
  subtree: true
});

console.log(' Sistema de garantia carregado! O bot√£o agora funcionar√° sempre.');

// ============================================
// SOLU√á√ÉO NUCLEAR DEFINITIVA - REMOVA TUDO E COLE ISSO
// ============================================

// 1. REMOVER QUALQUER SISTEMA ANTIGO DO BOT√ÉO
document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());

// 2. SOBRESCREVER COMPLETAMENTE A FUN√á√ÉO QUE CRIA O PAINEL
const originalRenderAdminProductsContent = window.renderAdminProductsContent;

window.renderAdminProductsContent = async function() {
    console.log(' Criando painel com solu√ß√£o nuclear...');
    
    // Executar fun√ß√£o original mas capturar o resultado
    if (originalRenderAdminProductsContent) {
        await originalRenderAdminProductsContent.apply(this, arguments);
    }
    
    // 3. AGORA CONFIGURAR O BOT√ÉO COM PRIORIDADE M√ÅXIMA
    setTimeout(() => {
        console.log(' Configurando bot√£o FECHAR (solu√ß√£o nuclear)...');
        
        // Encontrar TODOS os bot√µes e substituir
        document.querySelectorAll('#adminCloseBtn').forEach(oldBtn => {
            // Criar NOVO bot√£o do ZERO
            const novoBotao = document.createElement('button');
            novoBotao.id = 'adminCloseBtn';
            novoBotao.textContent = 'üöÄ FECHAR ADM';
            novoBotao.title = 'Clique 1 vez para fechar';
            
            // COMPORTAMENTO ABSOLUTO (nada pode impedir) COM INVALIDA√á√ÉO DE CACHE
            novoBotao.addEventListener('click', function handler(e) {
                console.log(' CLIQUE NUCLEAR ATIVADO!');
                
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
                
                // Remover este handler depois de executar (evitar duplica√ß√£o)
                this.removeEventListener('click', handler);
                
                // FECHAR TUDO IMEDIATAMENTE
                document.querySelectorAll('.modal-backdrop, .modal, [class*="backdrop"]').forEach(el => {
                    console.log(' Removendo:', el.className);
                    el.remove();
                });
                
                // Resetar body
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
                
                // Limpar timeout admin
                if (window.adminSessaoTimeout) {
                    clearTimeout(window.adminSessaoTimeout);
                    window.adminSessaoTimeout = null;
                }
                
                // üî• INVALIDAR CACHE
                produtosCache = null;
                ultimoCarregamentoCache = null;
                
                // Recarregar produtos
                if (typeof window.carregarProdutos === 'function') {
                    setTimeout(() => {
                        window.carregarProdutos();
                        console.log(' Produtos recarregados');
                    }, 300);
                }
                
                console.log(' Painel FECHADO com sucesso!');
                alert('‚úÖ Painel fechado com 1 clique!');
                
                return false;
            }, true); // true = usar captura (maior prioridade)
            
            // ESTILO IMPOSS√çVEL DE IGNORAR
            novoBotao.style.cssText = `
                background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
                color: white !important;
                border: 4px solid yellow !important;
                padding: 12px 24px !important;
                border-radius: 10px !important;
                cursor: pointer !important;
                font-weight: bold !important;
                font-size: 16px !important;
                box-shadow: 0 0 25px #2ecc71, 0 0 45px rgba(46, 204, 113, 0.8) !important;
                position: relative !important;
                z-index: 999999 !important;
                animation: pulsar-nuclear 0.8s infinite !important;
                min-width: 180px !important;
                text-align: center !important;
                margin-left: 10px !important;
            `;
            
            // Substituir o bot√£o antigo
            oldBtn.parentNode.replaceChild(novoBotao, oldBtn);
            console.log(' Bot√£o substitu√≠do com solu√ß√£o nuclear');
        });
        
        // 4. SE N√ÉO ENCONTRAR BOT√ÉO, CRIAR UM NOVO
        if (!document.querySelector('#adminCloseBtn')) {
            console.log(' Bot√£o n√£o encontrado, criando novo...');
            
            const novoBotao = document.createElement('button');
            novoBotao.id = 'adminCloseBtn';
            novoBotao.textContent = 'üöÄ FECHAR PAINEL';
            
            // Colocar no lugar correto
            const headerDiv = document.querySelector('.modal div:first-child div:last-child');
            if (headerDiv) {
                headerDiv.appendChild(novoBotao);
                console.log(' Novo bot√£o criado');
            }
        }
        
        // 5. ADICIONAR ANIMA√á√ÉO CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulsar-nuclear {
                0% { transform: scale(1); box-shadow: 0 0 25px #2ecc71, 0 0 45px rgba(46, 204, 113, 0.8); }
                50% { transform: scale(1.05); box-shadow: 0 0 35px #2ecc71, 0 0 65px rgba(46, 204, 113, 1); }
                100% { transform: scale(1); box-shadow: 0 0 25px #2ecc71, 0 0 45px rgba(46, 204, 113, 0.8); }
            }
        `;
        document.head.appendChild(style);
        
        console.log(' Solu√ß√£o nuclear aplicada!');
        
    }, 100); // Pequeno delay para garantir que o DOM foi atualizado
};

// 6. INTERCEPTAR TODAS AS CHAMADAS DE RECARGA
const originais = {
    renderAdminProducts: window.renderAdminProducts,
    askAdminPassword: window.askAdminPassword
};

// Sobrescrever renderAdminProducts para garantir consist√™ncia
if (originais.renderAdminProducts) {
    window.renderAdminProducts = async function() {
        console.log(' Abrindo painel admin (interceptado)...');
        // Primeiro fechar qualquer modal existente
        document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());
        
        // Chamar fun√ß√£o original
        return originais.renderAdminProducts.apply(this, arguments);
    };
}


// 8. FUN√á√ÉO DE EMERG√äNCIA MANUAL (chame no console se precisar) COM INVALIDA√á√ÉO DE CACHE
window.forceCloseButton = function() {
    console.log(' FOR√áANDO BOT√ÉO FECHAR...');
    
    // Remover tudo
    document.querySelectorAll('.modal-backdrop, .modal').forEach(el => el.remove());
    
    // üî• INVALIDAR CACHE
    produtosCache = null;
    ultimoCarregamentoCache = null;
    
    // Recarregar produtos
    if (typeof carregarProdutos === 'function') {
      setTimeout(() => {
        carregarProdutos();
      }, 300);
    }
    
    // Criar bot√£o de emerg√™ncia
    const emergencyBtn = document.createElement('button');
    emergencyBtn.textContent = 'üí£ FECHAR TUDO (EMERG√äNCIA)';
    emergencyBtn.style.cssText = `
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        background: red !important;
        color: white !important;
        padding: 15px 25px !important;
        border: 3px solid yellow !important;
        border-radius: 10px !important;
        cursor: pointer !important;
        z-index: 1000000 !important;
        font-weight: bold !important;
    `;
    
    emergencyBtn.onclick = function() {
        document.querySelectorAll('.modal-backdrop, .modal').forEach(el => el.remove());
        this.remove();
        alert('‚úÖ Tudo fechado!');
    };
    
    document.body.appendChild(emergencyBtn);
    
    console.log(' Bot√£o emerg√™ncia criado!');
    alert('üö® Bot√£o de emerg√™ncia criado no canto superior direito!');
};

// =========================
// FUN√á√ïES DO MODO T√âCNICO (mantidas para compatibilidade)
// =========================

// 1. TESTAR PIX
window.testarPIX = async function() {
    console.log(' Testando sistema PIX...');
    
    try {
        const resultado = document.getElementById('resultadoDiagnostico') || document.createElement('div');
        resultado.innerHTML = 'üîÑ Testando PIX...';
        
        // Verificar configura√ß√£o atual
        const pixSnap = await db.collection('config').doc('pix').get();
        
        if (!pixSnap.exists) {
            resultado.innerHTML = '‚ùå PIX n√£o configurado no Firebase';
            alert('‚ùå PIX n√£o configurado! Use o bot√£o "Configurar PIX" no painel admin.');
            return;
        }
        
        const dadosPIX = pixSnap.data();
        
        // Verificar se tem chave
        if (!dadosPIX.chave || dadosPIX.chave.trim() === '') {
            resultado.innerHTML = '‚ùå Chave PIX vazia';
            alert('‚ùå Chave PIX est√° vazia! Configure uma chave v√°lida.');
            return;
        }
        
        // Verificar formato
        const chave = dadosPIX.chave;
        const apenasNumeros = chave.replace(/\D/g, '');
        const temPrefixo = chave.startsWith('+55');
        
        let status = '';
        if (temPrefixo && apenasNumeros.length === 13) {
            status = '‚úÖ FORMATO CORRETO';
        } else if (apenasNumeros.length === 13 && !temPrefixo) {
            status = '‚ö†Ô∏è FALTA +55';
        } else if (apenasNumeros.length === 11) {
            status = '‚ùå INCOMPLETO (11 d√≠gitos)';
        } else {
            status = '‚ö†Ô∏è FORMATO INUSITADO';
        }
        
        // Mostrar resultado
        const resumo = `
        üìä RESULTADO DO TESTE PIX:
        
        üîë Chave: ***${chave.slice(-4)}
        üì± D√≠gitos: ${apenasNumeros.length}
        üåç Prefixo: ${temPrefixo ? '‚úÖ +55 presente' : '‚ùå Faltando +55'}
        üìã Status: ${status}
        üë§ Titular: ${dadosPIX.nomeTitular || 'N√£o configurado'}
        üèôÔ∏è Cidade: ${dadosPIX.cidadeTitular || 'N√£o configurada'}
        
        ${temPrefixo && apenasNumeros.length === 13 ? '‚úÖ PIX CONFIGURADO CORRETAMENTE!' : '‚ö†Ô∏è VERIFIQUE A CONFIGURA√á√ÉO'}
        `;
        
        if (resultado.parentNode) {
            resultado.innerHTML = resumo.replace(/\n/g, '<br>');
        }
        
        alert(resumo);
        console.log(' Teste PIX conclu√≠do:', { chave: '***' + chave.slice(-4), status });
        
    } catch (error) {
        console.error(' Erro no teste PIX:', error);
        alert('‚ùå Erro ao testar PIX: ' + error.message);
    }
};

// 2. VER LOGS
window.verLogs = async function() {
    console.log('üìã Buscando logs...');
    
    try {
        const logsSnap = await db.collection('logs_seguranca')
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();
        
        let logsHTML = '<strong>üìã √öLTIMOS 20 LOGS:</strong><br><br>';
        let logsConsole = 'üìã LOGS DO SISTEMA:\n\n';
        
        if (logsSnap.empty) {
            logsHTML += 'Nenhum log encontrado.';
            logsConsole += 'Nenhum log encontrado.';
        } else {
            logsSnap.forEach(doc => {
                const log = doc.data();
                const data = new Date(log.timestamp).toLocaleString('pt-BR');
                const tipo = log.tipo || 'desconhecido';
                
                logsHTML += `
                <div style="border-left: 3px solid #3498db; padding-left: 8px; margin-bottom: 8px; font-size: 11px;">
                    <strong>${data}</strong><br>
                    <span style="color: #${tipo.includes('sucesso') ? '2ecc71' : tipo.includes('erro') ? 'e74c3c' : '3498db'}">
                        ${tipo.toUpperCase()}
                    </span><br>
                    ${log.dados ? JSON.stringify(log.dados).substring(0, 100) + '...' : ''}
                </div>
                `;
                
                logsConsole += `${data} - ${tipo}\n`;
            });
        }
        
        // Mostrar em modal
        const modalLogs = document.createElement('div');
        modalLogs.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
        `;
        
        modalLogs.innerHTML = `
            <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #3498db;">üìã LOGS DO SISTEMA</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        FECHAR
                    </button>
                </div>
                <div style="font-family: monospace; font-size: 12px;">
                    ${logsHTML}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="navigator.clipboard.writeText(\`${logsConsole}\'); alert('Logs copiados!');"
                            style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        üìã Copiar para √Årea de Transfer√™ncia
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modalLogs);
        console.log(' Logs carregados:', logsSnap.size, 'registros');
        
    } catch (error) {
        console.error(' Erro ao buscar logs:', error);
        alert('‚ùå Erro ao buscar logs: ' + error.message);
    }
};

// 3. LIMPAR CACHE LOCAL
window.limparCacheLocal = function() {
    console.log(' Limpando cache local...');
    
    if (confirm('‚ö†Ô∏è LIMPAR CACHE LOCAL?\n\nIsso ir√°:\n‚Ä¢ Limpar carrinho atual\n‚Ä¢ Remover dados locais\n‚Ä¢ Manter configura√ß√µes do Firebase\n\nContinuar?')) {
        // Limpar localStorage
        localStorage.clear();
        
        // Limpar carrinho
        cart = [];
        
        // üî• INVALIDAR CACHE
        produtosCache = null;
        ultimoCarregamentoCache = null;
        
        // Recarregar produtos
        if (typeof carregarProdutos === 'function') {
            carregarProdutos();
        }
        
        if (typeof renderCart === 'function') {
            renderCart();
        }
        
        // Limpar sessionStorage
        sessionStorage.clear();
        
        console.log(' Cache local limpo!');
        alert('‚úÖ Cache local limpo com sucesso!\n\nO sistema ser√° recarregado.');
        
        // Recarregar a p√°gina
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
};

// 4. RECARREGAR PRODUTOS
window.recarregarProdutos = function() {
  console.log(' Recarregando produtos...');
  
  // üî• INVALIDAR CACHE
  produtosCache = null;
  ultimoCarregamentoCache = null;
  
  if (typeof carregarProdutos === 'function') {
    carregarProdutos();
    alert('‚úÖ Produtos recarregados!');
    console.log('‚úÖ Produtos recarregados');
  } else {
    alert('‚ùå Fun√ß√£o carregarProdutos n√£o dispon√≠vel');
  }
};

// 5. EXECUTAR DIAGN√ìSTICO
window.executarDiagnostico = async function() {
    console.log(' Executando diagn√≥stico completo...');
    
    const resultado = document.getElementById('resultadoDiagnostico');
    if (resultado) {
        resultado.innerHTML = 'üîÑ Executando diagn√≥stico...';
    }
    
    let diagnostico = 'ü©∫ DIAGN√ìSTICO DO SISTEMA:\n\n';
    
    try {
        // 1. Verificar Firebase
        diagnostico += '1. üî• FIREBASE:\n';
        try {
            const user = auth.currentUser;
            diagnostico += `   ‚Ä¢ Autenticado: ${user ? '‚úÖ Sim' : '‚ùå N√£o'}\n`;
            diagnostico += `   ‚Ä¢ UID: ${user?.uid || 'N/A'}\n`;
            diagnostico += `   ‚Ä¢ Email: ${user?.email || 'An√¥nimo'}\n`;
        } catch (e) {
            diagnostico += `   ‚Ä¢ Erro: ${e.message}\n`;
        }
        
        // 2. Verificar PIX
        diagnostico += '\n2. üí∞ PIX:\n';
        try {
            const pixSnap = await db.collection('config').doc('pix').get();
            if (pixSnap.exists) {
                const pixData = pixSnap.data();
                diagnostico += `   ‚Ä¢ Configurado: ‚úÖ Sim\n`;
                diagnostico += `   ‚Ä¢ Chave: ***${pixData.chave?.slice(-4) || 'N/A'}\n`;
                diagnostico += `   ‚Ä¢ Nome: ${pixData.nomeTitular || 'N/A'}\n`;
                diagnostico += `   ‚Ä¢ Cidade: ${pixData.cidadeTitular || 'N/A'}\n`;
            } else {
                diagnostico += `   ‚Ä¢ Configurado: ‚ùå N√£o\n`;
            }
        } catch (e) {
            diagnostico += `   ‚Ä¢ Erro: ${e.message}\n`;
        }
        
        // 3. Verificar Carrinho
        diagnostico += '\n3. üõí CARRINHO:\n';
        diagnostico += `   ‚Ä¢ Status: ${cartEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}\n`;
        diagnostico += `   ‚Ä¢ Itens: ${cart.length}\n`;
        diagnostico += `   ‚Ä¢ Total: R$ ${calcTotal().toFixed(2)}\n`;
        
        // 4. Verificar LocalStorage
        diagnostico += '\n4. üíæ LOCAL STORAGE:\n';
        try {
            const cartLS = localStorage.getItem('cart');
            diagnostico += `   ‚Ä¢ Carrinho salvo: ${cartLS ? '‚úÖ Sim' : '‚ùå N√£o'}\n`;
            diagnostico += `   ‚Ä¢ Tamanho: ${localStorage.length} itens\n`;
        } catch (e) {
            diagnostico += `   ‚Ä¢ Erro: ${e.message}\n`;
        }
        
        // 5. Verificar Navegador
        diagnostico += '\n5. üåê NAVEGADOR:\n';
        diagnostico += `   ‚Ä¢ Online: ${navigator.onLine ? '‚úÖ Sim' : '‚ùå N√£o'}\n`;
        diagnostico += `   ‚Ä¢ User Agent: ${navigator.userAgent.substring(0, 50)}...\n`;
        
        // 6. Verificar Permiss√µes
        diagnostico += '\n6. üîê PERMISS√ïES:\n';
        diagnostico += `   ‚Ä¢ Clipboard: ${navigator.clipboard ? '‚úÖ Dispon√≠vel' : '‚ùå Indispon√≠vel'}\n`;
        diagnostico += `   ‚Ä¢ Geolocation: ${navigator.geolocation ? '‚úÖ Dispon√≠vel' : '‚ùå Indispon√≠vel'}\n`;
        
        // Mostrar resultado
        console.log(diagnostico);
        
        if (resultado) {
            resultado.innerHTML = diagnostico.replace(/\n/g, '<br>');
        }
        
        // Criar modal com resultado completo
        const modalDiagnostico = document.createElement('div');
        modalDiagnostico.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
            font-family: monospace;
        `;
        
        modalDiagnostico.innerHTML = `
            <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #3498db;">ü©∫ DIAGN√ìSTICO COMPLETO</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        FECHAR
                    </button>
                </div>
                <div style="font-size: 12px; line-height: 1.6; white-space: pre-wrap;">
                    ${diagnostico}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="navigator.clipboard.writeText(\`${diagnostico}\'); alert('Diagn√≥stico copiado!');"
                            style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        üìã Copiar Diagn√≥stico
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modalDiagnostico);
        
    } catch (error) {
        console.error(' Erro no diagn√≥stico:', error);
        if (resultado) {
            resultado.innerHTML = `‚ùå Erro no diagn√≥stico: ${error.message}`;
        }
        alert('‚ùå Erro no diagn√≥stico: ' + error.message);
    }
};

//---------------------------------------------------------------------------------------------------

// ============================================
// SISTEMA DE BACKUP & RESTAURA√á√ÉO - MODO T√âCNICO
// ============================================

// 1. CRIAR BACKUP COMPLETO
window.criarBackupCompleto = async function() {
  console.log('üîÑ Criando backup completo...');
  
  if (!adminAutenticado) {
    alert('‚ùå Acesso n√£o autorizado! Use ativarModoTecnico() primeiro.');
    return;
  }
  
  try {
    // Mostrar loading
    const loadingMsg = 'üîÑ Criando backup...';
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      z-index: 1000000;
      font-weight: bold;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    `;
    loadingDiv.textContent = loadingMsg;
    document.body.appendChild(loadingDiv);
    
    // Coletar todos os dados
    console.log('üìä Coletando dados do sistema...');
    
    // 1. PRODUTOS
    const produtosSnapshot = await db.collection('produtos').get();
    const produtos = [];
    produtosSnapshot.forEach(doc => {
      produtos.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // 2. CONFIGURA√á√ïES
    const configs = {};
    const configDocs = ['config', 'pix', 'whatsapp', 'admin', 'cart', 'estoque'];
    
    for (const docName of configDocs) {
      const docSnap = await db.collection('config').doc(docName).get();
      if (docSnap.exists) {
        configs[docName] = docSnap.data();
      }
    }
    
    // 3. TRANSA√á√ïES (√∫ltimas 100)
    const transacoesSnapshot = await db.collection('transacoes_ton')
      .orderBy('data', 'desc')
      .limit(100)
      .get();
    
    const transacoes = [];
    transacoesSnapshot.forEach(doc => {
      transacoes.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // 4. LOGS (√∫ltimos 50)
    const logsSnapshot = await db.collection('logs_seguranca')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get();
    
    const logs = [];
    logsSnapshot.forEach(doc => {
      logs.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Criar objeto de backup
    const backupData = {
      metadata: {
        sistema: 'Hortifruti Cliente 2',
        versao: '1.0',
        dataBackup: new Date().toISOString(),
        totalProdutos: produtos.length,
        totalConfigs: Object.keys(configs).length,
        totalTransacoes: transacoes.length,
        totalLogs: logs.length
      },
      produtos: produtos,
      configs: configs,
      transacoes: transacoes,
      logs: logs,
      carrinhoAtual: cart, // Carrinho atual dos clientes
      configLocal: {
        rawPixPhone: rawPixPhone,
        sellerPhone: sellerPhone,
        merchantName: merchantName,
        merchantCity: merchantCity,
        cartEnabled: cartEnabled
      }
    };
    
    // Converter para JSON
    const backupJSON = JSON.stringify(backupData, null, 2);
    const backupSize = (new Blob([backupJSON]).size / 1024).toFixed(2); // KB
    
    // Remover loading
    loadingDiv.remove();
    
    // Criar modal para download
    const modalBackup = document.createElement('div');
    modalBackup.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000000;
    `;
    
    modalBackup.innerHTML = `
      <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        <h3 style="color: #2ecc71; margin-top: 0; text-align: center;">üíæ BACKUP COMPLETO CRIADO</h3>
        
        <div style="background: #34495e; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
          <strong>üìä RESUMO DO BACKUP:</strong>
          <div style="margin-top: 10px;">
            <div>üì¶ Produtos: <strong>${produtos.length}</strong></div>
            <div>‚öôÔ∏è Configura√ß√µes: <strong>${Object.keys(configs).length}</strong></div>
            <div>üí∞ Transa√ß√µes: <strong>${transacoes.length}</strong></div>
            <div>üìù Logs: <strong>${logs.length}</strong></div>
            <div>üíæ Tamanho: <strong>${backupSize} KB</strong></div>
            <div>üìÖ Data: <strong>${new Date().toLocaleString('pt-BR')}</strong></div>
          </div>
        </div>
        
        <div style="margin-bottom: 20px; font-size: 13px; color: #bdc3c7;">
          ‚ö†Ô∏è <strong>Armazene este arquivo em local seguro!</strong><br>
          Ele cont√©m todos os dados do seu sistema.
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button id="btnDownloadBackup" style="
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
          ">
            ‚¨áÔ∏è BAIXAR BACKUP (.json)
          </button>
          
          <button id="btnCopiarBackup" style="
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
          ">
            üìã COPIAR PARA √ÅREA DE TRANSFER√äNCIA
          </button>
          
          <button id="btnFecharBackup" style="
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
          ">
            ‚ùå FECHAR
          </button>
        </div>
        
        <div style="margin-top: 15px; font-size: 11px; color: #95a5a6; text-align: center;">
          Backup autom√°tico ‚Ä¢ Sistema Hortifruti 2
        </div>
      </div>
    `;
    
    document.body.appendChild(modalBackup);
    
    // Configurar eventos
    document.getElementById('btnDownloadBackup').onclick = function() {
      // Criar arquivo para download
      const blob = new Blob([backupJSON], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_hortifruti_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('‚úÖ Backup baixado com sucesso!');
    };
    
    document.getElementById('btnCopiarBackup').onclick = async function() {
      try {
        await navigator.clipboard.writeText(backupJSON);
        this.textContent = '‚úÖ Copiado!';
        this.style.background = '#2ecc71';
        setTimeout(() => {
          this.textContent = 'üìã COPIAR PARA √ÅREA DE TRANSFER√äNCIA';
          this.style.background = '#3498db';
        }, 2000);
      } catch (err) {
        alert('‚ùå Erro ao copiar: ' + err.message);
      }
    };
    
    document.getElementById('btnFecharBackup').onclick = function() {
      modalBackup.remove();
    };
    
    // Fechar com ESC
    modalBackup.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        modalBackup.remove();
      }
    });
    
    // Log do backup
    await sistemaLogs.registrar('backup_criado', {
      tamanho: backupSize + ' KB',
      produtos: produtos.length,
      configs: Object.keys(configs).length,
      por: auth.currentUser?.uid
    });
    
    console.log('‚úÖ Backup criado:', backupData.metadata);
    
  } catch (error) {
    console.error('‚ùå Erro ao criar backup:', error);
    alert('‚ùå Erro ao criar backup:\n\n' + error.message);
  }
};

// 2. RESTAURAR BACKUP
window.restaurarBackup = async function() {
  console.log('üîÑ Iniciando restaura√ß√£o de backup...');
  
  if (!adminAutenticado) {
    alert('‚ùå Acesso n√£o autorizado! Use ativarModoTecnico() primeiro.');
    return;
  }
  
  // AVISO IMPORTANTE
  const confirmar = confirm(
    '‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è  RESTAURAR BACKUP ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è\n\n' +
    'Esta a√ß√£o ir√°:\n' +
    '‚Ä¢ SOBRESCREVER dados existentes\n' +
    '‚Ä¢ Restaurar produtos e configura√ß√µes\n' +
    '‚Ä¢ Pode causar perda de dados recentes\n\n' +
    'üö® FA√áA BACKUP ANTES DE CONTINUAR!\n\n' +
    'Deseja prosseguir?'
  );
  
  if (!confirmar) {
    console.log(' Restaura√ß√£o cancelada pelo usu√°rio');
    return;
  }
  
  // Criar input de arquivo
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json,.txt';
  fileInput.style.display = 'none';
  
  fileInput.onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Verificar tamanho (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('‚ùå Arquivo muito grande! M√°ximo 10MB.');
      return;
    }
    
    // Ler arquivo
    const reader = new FileReader();
    
    reader.onload = async function(event) {
      try {
        const backupData = JSON.parse(event.target.result);
        
        // Validar estrutura do backup
        if (!backupData.metadata || !backupData.produtos) {
          throw new Error('Arquivo de backup inv√°lido!');
        }
        
        // Mostrar preview
        const preview = `
          üìä BACKUP DETECTADO:
          
          Sistema: ${backupData.metadata.sistema || 'Desconhecido'}
          Data: ${backupData.metadata.dataBackup || 'Desconhecida'}
          Produtos: ${backupData.produtos.length}
          Configura√ß√µes: ${Object.keys(backupData.configs || {}).length}
          
          Deseja restaurar este backup?
        `;
        
        const confirmarRestauracao = confirm(preview);
        if (!confirmarRestauracao) return;
        
        // Mostrar loading
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #2c3e50;
          color: white;
          padding: 20px 30px;
          border-radius: 10px;
          z-index: 1000000;
          font-weight: bold;
          text-align: center;
          min-width: 300px;
        `;
        loadingDiv.innerHTML = `
          <div>üîÑ Restaurando backup...</div>
          <div style="margin-top: 10px; font-size: 14px;" id="restoreStatus">
            Preparando...
          </div>
          <div style="margin-top: 15px; width: 100%; height: 10px; background: #34495e; border-radius: 5px;">
            <div id="restoreProgress" style="height: 100%; background: #2ecc71; border-radius: 5px; width: 0%;"></div>
          </div>
        `;
        document.body.appendChild(loadingDiv);
        
        // Fun√ß√£o para atualizar progresso
        const updateProgress = (step, total, message) => {
          const progress = Math.round((step / total) * 100);
          document.getElementById('restoreProgress').style.width = progress + '%';
          document.getElementById('restoreStatus').textContent = message;
        };
        
        try {
          // 1. RESTAURAR PRODUTOS
          console.log(' Restaurando produtos...');
          updateProgress(1, 4, `Restaurando ${backupData.produtos.length} produtos...`);
          
          for (let i = 0; i < backupData.produtos.length; i++) {
            const produto = backupData.produtos[i];
            await db.collection('produtos').doc(produto.id).set(produto, { merge: true });
            
            // Atualizar progresso parcial
            if (i % 5 === 0) {
              updateProgress(1, 4, `Produtos: ${i + 1}/${backupData.produtos.length}`);
            }
          }
          
          // 2. RESTAURAR CONFIGURA√á√ïES
          console.log(' Restaurando configura√ß√µes...');
          updateProgress(2, 4, 'Restaurando configura√ß√µes...');
          
          for (const [docName, data] of Object.entries(backupData.configs)) {
            await db.collection('config').doc(docName).set(data, { merge: true });
          }
          
          // 3. RESTAURAR VARI√ÅVEIS LOCAIS
          console.log(' Restaurando vari√°veis locais...');
          updateProgress(3, 4, 'Restaurando vari√°veis locais...');
          
          if (backupData.configLocal) {
            rawPixPhone = backupData.configLocal.rawPixPhone || '';
            sellerPhone = backupData.configLocal.sellerPhone || '';
            merchantName = backupData.configLocal.merchantName || '';
            merchantCity = backupData.configLocal.merchantCity || '';
            cartEnabled = backupData.configLocal.cartEnabled !== false;
          }
          
          // 4. ATUALIZAR INTERFACE
          console.log(' Atualizando interface...');
          updateProgress(4, 4, 'Atualizando interface...');
          
          // Recarregar tudo
          produtosCache = null;
          ultimoCarregamentoCache = null;
          
          if (typeof carregarProdutos === 'function') {
            setTimeout(() => {
              carregarProdutos();
            }, 500);
          }
          
          // Atualizar PIX
          if (typeof atualizarPixDisplay === 'function') {
            atualizarPixDisplay();
          }
          
          // Remover loading
          setTimeout(() => {
            loadingDiv.remove();
            
            // Mostrar sucesso
            alert(
              `‚úÖ BACKUP RESTAURADO COM SUCESSO!\n\n` +
              `üì¶ Produtos: ${backupData.produtos.length}\n` +
              `‚öôÔ∏è Configura√ß√µes: ${Object.keys(backupData.configs || {}).length}\n` +
              `üìÖ Data original: ${new Date(backupData.metadata.dataBackup).toLocaleDateString('pt-BR')}\n\n` +
              `O sistema ser√° recarregado para aplicar todas as mudan√ßas.`
            );
            
            // Recarregar p√°gina
            setTimeout(() => {
              location.reload();
            }, 1000);
            
          }, 1000);
          
          // Log da restaura√ß√£o
          await sistemaLogs.registrar('backup_restaurado', {
            backupData: backupData.metadata.dataBackup,
            produtosRestaurados: backupData.produtos.length,
            configsRestauradas: Object.keys(backupData.configs || {}).length,
            por: auth.currentUser?.uid
          });
          
        } catch (error) {
          loadingDiv.remove();
          throw error;
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao restaurar backup:', error);
        alert('‚ùå Erro ao restaurar backup:\n\n' + error.message);
      }
    };
    
    reader.readAsText(file);
  };
  
  // Disparar click no input
  document.body.appendChild(fileInput);
  fileInput.click();
  document.body.removeChild(fileInput);
};

// 3. BACKUP AUTOM√ÅTICO DI√ÅRIO (opcional)
window.configurarBackupAutomatico = async function() {
  console.log('‚öôÔ∏è Configurando backup autom√°tico...');
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000000;
  `;
  
  modal.innerHTML = `
    <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
      <h3 style="color: #f39c12; margin-top: 0; text-align: center;">‚è∞ BACKUP AUTOM√ÅTICO</h3>
      
      <div style="margin-bottom: 20px;">
        <p style="color: #bdc3c7;">Configure backups autom√°ticos di√°rios:</p>
        
        <div style="background: #34495e; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <label style="display: block; margin-bottom: 10px;">
            <input type="checkbox" id="autoBackupEnabled" checked>
            Ativar backup autom√°tico
          </label>
          
          <label style="display: block; margin-bottom: 10px;">
            <input type="time" id="backupTime" value="02:00" style="width: 100%; padding: 8px; background: #2c3e50; color: white; border: 1px solid #7f8c8d; border-radius: 4px;">
            Hor√°rio do backup (recomendado: madrugada)
          </label>
          
          <label style="display: block; margin-bottom: 10px;">
            <input type="number" id="backupDays" value="7" min="1" max="30" style="width: 100%; padding: 8px; background: #2c3e50; color: white; border: 1px solid #7f8c8d; border-radius: 4px;">
            Manter backups por (dias)
          </label>
        </div>
        
        <div style="font-size: 12px; color: #95a5a6; background: #34495e; padding: 10px; border-radius: 5px;">
          ‚ö†Ô∏è Backups autom√°ticos s√£o salvos no Firebase e podem ser restaurados a qualquer momento.
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="btnCancelarAutoBackup" style="
          background: #7f8c8d;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          flex: 1;
        ">
          ‚ùå Cancelar
        </button>
        
        <button id="btnSalvarAutoBackup" style="
          background: #2ecc71;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          flex: 1;
        ">
          üíæ Salvar Configura√ß√£o
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  document.getElementById('btnCancelarAutoBackup').onclick = function() {
    modal.remove();
  };
  
  document.getElementById('btnSalvarAutoBackup').onclick = async function() {
    const enabled = document.getElementById('autoBackupEnabled').checked;
    const time = document.getElementById('backupTime').value;
    const days = document.getElementById('backupDays').value;
    
    try {
      await db.collection('config').doc('auto_backup').set({
        enabled: enabled,
        time: time,
        keepDays: parseInt(days),
        configuradoEm: new Date().toISOString(),
        configuradoPor: auth.currentUser?.uid
      }, { merge: true });
      
      alert(`‚úÖ Backup autom√°tico ${enabled ? 'ativado' : 'desativado'}!\n\nHor√°rio: ${time}\nManter por: ${days} dias`);
      modal.remove();
      
    } catch (error) {
      alert('‚ùå Erro ao salvar configura√ß√£o: ' + error.message);
    }
  };
};

//----------------------------------------------------------------------------------------------------

// 6. RESETAR SISTEMA
window.resetarSistema = function() {
    if (confirm('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è  RESETAR SISTEMA COMPLETO?\n\nIsso ir√°:\n‚Ä¢ Limpar TODO o cache local\n‚Ä¢ Remover carrinho atual\n‚Ä¢ Recarregar TODOS os dados\n‚Ä¢ Manter configura√ß√µes do Firebase\n\nüö® Esta a√ß√£o n√£o pode ser desfeita!\n\nContinuar?')) {
        console.log(' Resetando sistema...');
        
        // Limpar tudo
        localStorage.clear();
        sessionStorage.clear();
        
        // Resetar vari√°veis
        cart = [];
        cartEnabled = true;
        
        // üî• INVALIDAR CACHE COMPLETAMENTE
        produtosCache = null;
        ultimoCarregamentoCache = null;
        
        // Mostrar loading
        const loading = document.createElement('div');
        loading.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
            color: white;
            font-family: Arial, sans-serif;
        `;
        loading.innerHTML = `
            <h2 style="color: #2ecc71;">‚ôªÔ∏è RESETANDO SISTEMA...</h2>
            <p>Aguarde enquanto o sistema √© reinicializado.</p>
            <div style="border: 2px solid #3498db; width: 200px; height: 10px; border-radius: 5px; margin: 20px;">
                <div id="progressoReset" style="background: #2ecc71; height: 100%; width: 0%; border-radius: 3px;"></div>
            </div>
        `;
        
        document.body.appendChild(loading);
        
        // Animar progresso
        let progresso = 0;
        const intervalo = setInterval(() => {
            progresso += 20;
            const barra = document.getElementById('progressoReset');
            if (barra) barra.style.width = progresso + '%';
            
            if (progresso >= 100) {
                clearInterval(intervalo);
                setTimeout(() => {
                    loading.remove();
                    location.reload();
                }, 500);
            }
        }, 200);
    }
};

// =========================
  // SISTEMA DE GEST√ÉO DE SENHAS (MODO T√âCNICO) - MODIFICADO
  // =========================

  // 1. VER SENHAS CONFIGURADAS (MODIFICADO)
  window.verSenhasSistema = async function() {
      console.log(' Buscando senhas do sistema...');
      
      try {
          // Buscar todas as senhas/configura√ß√µes
          const [adminSnap, pixSnap, whatsappSnap, tecnicoSnap, whatsappSenhaSnap] = await Promise.all([
              db.collection('config').doc('admin').get(),
              db.collection('config').doc('pix').get(),
              db.collection('config').doc('whatsapp').get(),
              db.collection('config').doc('tecnico_senha').get(),
              db.collection('config').doc('whatsapp_senha').get() // <-- ADICIONADO
          ]);
          
          // Criar modal de senhas
          const modalSenhas = document.createElement('div');
          modalSenhas.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.9);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 1000000;
              font-family: 'Courier New', monospace;
          `;
          
          let conteudoSenhas = '<h3 style="color: #3498db; text-align: center;">üîê SENHAS DO SISTEMA</h3>';
          
          // Senha Admin
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #e74c3c;">';
          conteudoSenhas += '<strong style="color: #e74c3c;">üëë ADMINISTRADOR</strong><br>';
          if (adminSnap.exists) {
              const adminData = adminSnap.data();
              conteudoSenhas += `‚Ä¢ Senha hash: <code style="color: #f39c12;">${adminData.senha ? adminData.senha.substring(0, 20) + '...' : 'N√£o configurada'}</code><br>`;
              conteudoSenhas += `‚Ä¢ √öltima atualiza√ß√£o: ${adminData.atualizadoEm || 'N/A'}<br>`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurada<br>';
          }
          conteudoSenhas += '<button onclick="trocarSenhaAdmin()" style="margin-top: 10px; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">';
          conteudoSenhas += 'üîë Trocar Senha Admin</button>';
          conteudoSenhas += '</div>';
          
          // Configura√ß√£o PIX
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #9b59b6;">';
          conteudoSenhas += '<strong style="color: #9b59b6;">üí∞ CONFIGURA√á√ÉO PIX</strong><br>';
          if (pixSnap.exists) {
              const pixData = pixSnap.data();
              conteudoSenhas += `‚Ä¢ Chave PIX: <code style="color: #2ecc71;">${pixData.chave || 'N√£o configurada'}</code><br>`;
              conteudoSenhas += `‚Ä¢ Nome: ${pixData.nomeTitular || 'N/A'}<br>`;
              conteudoSenhas += `‚Ä¢ Cidade: ${pixData.cidadeTitular || 'N/A'}<br>`;
              conteudoSenhas += `‚Ä¢ Ativado: ${pixData.isPixEnabled ? '‚úÖ Sim' : '‚ùå N√£o'}<br>`;
              conteudoSenhas += `‚Ä¢ Senha PIX: ${pixData.senha ? 'üîí Configurada' : '‚ùå N√£o tem senha separada'}<br>`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurado<br>';
          }
          conteudoSenhas += '</div>';
          
          // Senha WhatsApp (SEPARADA) - NOVA SE√á√ÉO
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #25D366;">';
          conteudoSenhas += '<strong style="color: #25D366;">üì± WHATSAPP (SEPARADA)</strong><br>';
          if (whatsappSenhaSnap.exists) {
              const whatsappSenhaData = whatsappSenhaSnap.data();
              conteudoSenhas += `‚Ä¢ Senha hash: <code style="color: #25D366;">${whatsappSenhaData.hash ? whatsappSenhaData.hash.substring(0, 20) + '...' : 'N√£o configurada'}</code><br>`;
              conteudoSenhas += `‚Ä¢ √öltima atualiza√ß√£o: ${whatsappSenhaData.criadoEm || 'N/A'}<br>`;
              conteudoSenhas += `‚Ä¢ Primeiro acesso: ${whatsappSenhaData.primeiroAcesso ? '‚úÖ Sim' : '‚ùå N√£o'}<br>`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurada (ser√° criada no primeiro acesso)<br>';
          }
          conteudoSenhas += '<button onclick="trocarSenhaWhatsApp()" style="margin-top: 10px; background: #25D366; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">';
          conteudoSenhas += 'üì± Alterar Senha WhatsApp</button>';
          conteudoSenhas += '</div>';
          
          // Configura√ß√£o WhatsApp
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #25D366;">';
          conteudoSenhas += '<strong style="color: #25D366;">üì± WHATSAPP (N√öMERO)</strong><br>';
          if (whatsappSnap.exists) {
              const whatsData = whatsappSnap.data();
              conteudoSenhas += `‚Ä¢ N√∫mero: <code style="color: #2ecc71;">${whatsData.numero || 'N√£o configurado'}</code><br>`;
              conteudoSenhas += `‚Ä¢ Atualizado: ${whatsData.atualizadoEm || 'N/A'}<br>`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurado<br>';
          }
          conteudoSenhas += '</div>';
          
          // Senha T√©cnico (EXCLUSIVA) - NOVA SE√á√ÉO
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #f39c12;">';
          conteudoSenhas += '<strong style="color: #f39c12;">üîß MODO T√âCNICO (EXCLUSIVA)</strong><br>';
          if (tecnicoSnap.exists) {
              const tecnicoData = tecnicoSnap.data();
              conteudoSenhas += `‚Ä¢ Senha hash: <code style="color: #f39c12;">${tecnicoData.senha ? tecnicoData.senha.substring(0, 20) + '...' : 'N√£o configurada'}</code><br>`;
              conteudoSenhas += `‚Ä¢ √öltima altera√ß√£o: ${tecnicoData.atualizadoEm || 'N/A'}\n`;
              conteudoSenhas += `‚Ä¢ Tipo: ${tecnicoData.tipo || 'modo_tecnico'}\n`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurada (usar√° padr√£o: tecnico123)<br>';
          }
          conteudoSenhas += '<button onclick="trocarSenhaTecnico()" style="margin-top: 10px; background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">';
          conteudoSenhas += 'üîß Alterar Senha T√©cnico</button>';
          conteudoSenhas += '</div>';

          // ========== üöö ADICIONE AQUI A SE√á√ÉO DA TAXA DE ENTREGA ==========
          // Senha Taxa de Entrega (NOVA)
          conteudoSenhas += '<div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #d35400;">';
          conteudoSenhas += '<strong style="color: #d35400;">üöö TAXA DE ENTREGA</strong><br>';

          if (taxaEntregaSnap.exists) {
              const taxaEntregaData = taxaEntregaSnap.data();
              conteudoSenhas += `‚Ä¢ Senha hash: <code style="color: #d35400;">`;
              if (taxaEntregaData.hash) {
                  conteudoSenhas += `${taxaEntregaData.hash.substring(0, 20)}...`;
              } else {
                  conteudoSenhas += 'N√£o configurada';
              }
              conteudoSenhas += `</code><br>`;
              conteudoSenhas += `‚Ä¢ √öltima atualiza√ß√£o: ${taxaEntregaData.criadoEm || 'N/A'}<br>`;
              conteudoSenhas += `‚Ä¢ Primeiro acesso: ${taxaEntregaData.primeiroAcesso ? '‚úÖ Sim' : '‚ùå N√£o'}<br>`;
          } else {
              conteudoSenhas += '‚Ä¢ ‚ùå N√£o configurada (ser√° criada no primeiro acesso)<br>';
          }

          conteudoSenhas += '<button onclick="trocarSenhaTaxaEntrega()" style="margin-top: 10px; background: #d35400; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">';
          conteudoSenhas += 'üöö Alterar Senha Taxa</button>';
          conteudoSenhas += '</div>';
          // ========== FIM DA SE√á√ÉO DA TAXA DE ENTREGA ==========
          
          // Informa√ß√µes de seguran√ßa
          conteudoSenhas += '<div style="background: #c0392b; padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 11px;">';
          conteudoSenhas += '‚ö†Ô∏è <strong>INFORMA√á√ïES SENS√çVEIS!</strong><br>';
          conteudoSenhas += '‚Ä¢ As senhas s√£o armazenadas como HASH (n√£o texto)<br>';
          conteudoSenhas += '‚Ä¢ Esta tela s√≥ √© acess√≠vel via modo t√©cnico<br>';
          conteudoSenhas += '‚Ä¢ Mantenha essas informa√ß√µes em segredo<br>';
          conteudoSenhas += '‚Ä¢ Senha do WhatsApp √© SEPARADA das outras<br>';
          conteudoSenhas += '‚Ä¢ Senha do t√©cnico √© EXCLUSIVA (diferente do admin)';
          conteudoSenhas += '‚Ä¢ Senha da taxa de entrega √© INDEPENDENTE</br>'; // <-- ADICIONE ESTA LINHA
          conteudoSenhas += '</div>';
          
          modalSenhas.innerHTML = `
              <div style="background: #34495e; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                  ${conteudoSenhas}
                  <div style="text-align: center; margin-top: 20px;">
                      <button onclick="this.parentElement.parentElement.remove()" 
                              style="background: #7f8c8d; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                          üîí Fechar
                      </button>
                      <button onclick="navigator.clipboard.writeText(document.querySelector('#senhasTexto').innerText); alert('Copiado!');"
                              style="background: #3498db; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px;">
                          üìã Copiar
                      </button>
                  </div>
                  <div id="senhasTexto" style="display: none;">
                      SENHAS DO SISTEMA - ${new Date().toLocaleString()}
                      Admin: ${adminSnap.exists ? 'Configurado' : 'N√£o configurado'}
                      PIX: ${pixSnap.exists ? 'Configurado' : 'N√£o configurado'}
                      WhatsApp: ${whatsappSenhaSnap.exists ? 'Configurado' : 'N√£o configurado'}
                      T√©cnico: ${tecnicoSnap.exists ? 'Configurado' : 'N√£o configurado'}
                      Taxa de Entrega: ${taxaEntregaSnap.exists ? 'Configurado' : 'N√£o configurado'}
                  </div>
              </div>
          `;
          
          document.body.appendChild(modalSenhas);
          console.log('‚úÖ Senhas carregadas com sucesso!');
          
      } catch (error) {
          console.error(' Erro ao buscar senhas:', error);
          alert('‚ùå Erro: ' + error.message);
      }
  };

  // 2. TROCAR SENHA DO ADMIN (j√° existe, mantida para refer√™ncia)
  window.trocarSenhaAdmin = async function() {
      console.log(' Iniciando troca de senha admin...');
      
      // Modal para nova senha
      const modalSenha = document.createElement('div');
      modalSenha.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000001;
      `;
      
      modalSenha.innerHTML = `
          <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
              <h3 style="color: #e74c3c; margin-top: 0; text-align: center;">üîë ALTERAR SENHA ADMIN</h3>
              
              <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-size: 14px;">Senha Atual (para confirmar):</label>
                  <input type="password" id="senhaAtualAdmin" 
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #3498db; background: #34495e; color: white;"
                        placeholder="Digite a senha atual">
              </div>
              
              <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-size: 14px;">Nova Senha:</label>
                  <input type="password" id="novaSenhaAdmin" 
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
                        placeholder="Digite a nova senha">
              </div>
              
              <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-size: 14px;">Confirmar Nova Senha:</label>
                  <input type="password" id="confirmarSenhaAdmin" 
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
                        placeholder="Digite novamente">
              </div>
              
              <div style="background: #34495e; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;">
                  <strong>üìù Requisitos da senha:</strong><br>
                  ‚Ä¢ M√≠nimo 4 caracteres<br>
                  ‚Ä¢ Recomendado: letras + n√∫meros<br>
                  ‚Ä¢ N√£o usar senhas √≥bvias (1234, admin, etc)
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: center;">
                  <button id="btnCancelarSenha" 
                          style="background: #7f8c8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                      ‚ùå Cancelar
                  </button>
                  <button id="btnConfirmarSenha" 
                          style="background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                      ‚úÖ Confirmar
                  </button>
              </div>
              
              <div style="margin-top: 15px; font-size: 11px; color: #95a5a6; text-align: center;">
                  Esta senha ser√° usada para acessar o painel administrativo
              </div>
          </div>
      `;
      
      document.body.appendChild(modalSenha);
      
      // Configurar eventos
      document.getElementById('btnCancelarSenha').onclick = function() {
          modalSenha.remove();
          console.log(' Troca de senha cancelada');
      };
      
      document.getElementById('btnConfirmarSenha').onclick = async function() {
          const senhaAtual = document.getElementById('senhaAtualAdmin').value;
          const novaSenha = document.getElementById('novaSenhaAdmin').value;
          const confirmarSenha = document.getElementById('confirmarSenhaAdmin').value;
          
          // Valida√ß√µes
          if (!senhaAtual || !novaSenha || !confirmarSenha) {
              alert('‚ùå Todos os campos s√£o obrigat√≥rios!');
              return;
          }
          
          if (novaSenha !== confirmarSenha) {
              alert('‚ùå As novas senhas n√£o coincidem!');
              return;
          }
          
          if (novaSenha.length < 4) {
              alert('‚ùå A nova senha deve ter pelo menos 4 caracteres!');
              return;
          }
          
          try {
              // Verificar senha atual
              const senhaAtualHash = await hashSenha(senhaAtual);
              const senhaValida = await verificarSenhaAdmin(senhaAtualHash);
              
              if (!senhaValida) {
                  alert('‚ùå Senha atual incorreta!');
                  return;
              }
              
              // Calcular hash da nova senha
              const novaSenhaHash = await hashSenha(novaSenha);
              
              // Atualizar no Firebase
              await db.collection('config').doc('admin').set({
                  senha: novaSenhaHash,
                  atualizadoEm: new Date().toISOString(),
                  atualizadoPor: auth.currentUser?.uid || 'modo_tecnico',
                  ip: await getUserIP()
              }, { merge: true });
              
              // Log da altera√ß√£o
              await sistemaLogs.registrar('senha_admin_alterada', {
                  alteradoPor: auth.currentUser?.uid,
                  ip: await getUserIP(),
                  timestamp: new Date().toISOString()
              });
              
              // Fechar modal
              modalSenha.remove();
              
              // Mostrar sucesso
              alert(`‚úÖ SENHA ADMIN ALTERADA COM SUCESSO!\n\nNova senha configurada.\n\nAnote em local seguro!`);
              
              console.log(' Senha admin alterada com sucesso!');
              
          } catch (error) {
              console.error(' Erro ao alterar senha:', error);
              alert('‚ùå Erro: ' + error.message);
          }
      };
      
      // Permitir Enter para confirmar
      modalSenha.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              document.getElementById('btnConfirmarSenha').click();
          }
      });
      
      // Focar no primeiro campo
      document.getElementById('senhaAtualAdmin').focus();
  };

//------------------------------------------------------------------------------------------------------------

window.trocarSenhaTaxaEntrega = async function() {
    console.log(' Alterando senha da taxa de entrega...');
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000001;
    `;
    
    modal.innerHTML = `
        <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
            <h3 style="color: #d35400; margin-top: 0; text-align: center;">üöö ALTERAR SENHA DA TAXA DE ENTREGA</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Senha Atual:</label>
                <input type="password" id="senhaAtualTaxa" 
                      style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #d35400; background: #34495e; color: white;"
                      placeholder="Digite a senha atual">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Nova Senha:</label>
                <input type="password" id="novaSenhaTaxa" 
                      style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #d35400; background: #34495e; color: white;"
                      placeholder="Digite a nova senha (m√≠n. 6 caracteres)">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="flex: 1; background: #7f8c8d; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="confirmarTrocaSenhaTaxa()" 
                        style="flex: 1; background: #d35400; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    Confirmar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
};

async function confirmarTrocaSenhaTaxa() {
    const senhaAtual = document.getElementById('senhaAtualTaxa').value;
    const novaSenha = document.getElementById('novaSenhaTaxa').value;
    
    if (!senhaAtual || !novaSenha) {
        alert('‚ùå Preencha todos os campos!');
        return;
    }
    
    if (novaSenha.length < 6) {
        alert('‚ùå A nova senha deve ter no m√≠nimo 6 caracteres!');
        return;
    }
    
    try {
        // L√≥gica para atualizar a senha da taxa de entrega
        alert('‚úÖ Senha da taxa de entrega atualizada!');
        document.querySelector('div[style*="position: fixed; top: 0"]').remove();
        verSenhasSistema(); // Recarrega as senhas
    } catch (error) {
        alert('‚ùå Erro ao atualizar senha: ' + error.message);
    }
}

//------------------------------------------------------------------------------------------------------------

// =========================
// FUN√á√ÉO PARA ALTERAR SENHA DO WHATSAPP (NOVA)
// =========================
window.trocarSenhaWhatsApp = async function() {
  console.log(' Alterando senha do WhatsApp...');
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000001;
  `;
  
  modal.innerHTML = `
    <div style="background: #2c3e50; color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
      <h3 style="color: #25D366; margin-top: 0; text-align: center;">üì± ALTERAR SENHA DO WHATSAPP</h3>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Senha Atual do WhatsApp:</label>
        <input type="password" id="senhaAtualWhatsApp" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #25D366; background: #34495e; color: white;"
              placeholder="Digite a senha atual">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Nova Senha:</label>
        <input type="password" id="novaSenhaWhatsApp" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
              placeholder="Digite a nova senha">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px;">Confirmar Nova Senha:</label>
        <input type="password" id="confirmarSenhaWhatsApp" 
              style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2ecc71; background: #34495e; color: white;"
              placeholder="Digite novamente">
      </div>
      
      <div style="background: #34495e; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;">
        <strong>üìù Importante:</strong><br>
        ‚Ä¢ Esta senha √© usada APENAS para configurar o WhatsApp<br>
        ‚Ä¢ N√£o afeta a senha do administrador<br>
        ‚Ä¢ Recomendado: senha diferente das outras
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="btnCancelarWhatsApp" 
                style="background: #7f8c8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
          ‚ùå Cancelar
        </button>
        <button id="btnConfirmarWhatsApp" 
                style="background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
          ‚úÖ Confirmar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Fechar modal ao clicar fora
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  document.getElementById('btnCancelarWhatsApp').onclick = function() {
    modal.remove();
  };
  
  document.getElementById('btnConfirmarWhatsApp').onclick = async function() {
    const senhaAtual = document.getElementById('senhaAtualWhatsApp').value;
    const novaSenha = document.getElementById('novaSenhaWhatsApp').value;
    const confirmarSenha = document.getElementById('confirmarSenhaWhatsApp').value;
    
    // Valida√ß√µes
    if (!senhaAtual || !novaSenha || !confirmarSenha) {
      alert('‚ùå Todos os campos s√£o obrigat√≥rios!');
      return;
    }
    
    if (novaSenha !== confirmarSenha) {
      alert('‚ùå As novas senhas n√£o coincidem!');
      return;
    }
    
    if (novaSenha.length < 4) {
      alert('‚ùå A senha deve ter pelo menos 4 caracteres!');
      return;
    }
    
    try {
      // Verificar senha atual
      const senhaAtualHash = await hashSenha(senhaAtual);
      const senhaValida = await verificarSenhaWhatsApp(senhaAtual);
      
      if (!senhaValida) {
        alert('‚ùå Senha atual incorreta!');
        return;
      }
      
      // Calcular hash da nova senha
      const novaSenhaHash = await hashSenha(novaSenha);
      
      // Atualizar no Firebase
      await db.collection('config').doc('whatsapp_senha').set({
        hash: novaSenhaHash,
        atualizadoEm: new Date().toISOString(),
        atualizadoPor: auth.currentUser?.uid,
        ultimaAlteracao: new Date().toISOString()
      }, { merge: true });
      
      // Log da altera√ß√£o
      await sistemaLogs.registrar('senha_whatsapp_alterada', {
        alteradoPor: auth.currentUser?.uid,
        ip: await getUserIP()
      });
      
      // Fechar modal
      modal.remove();
      
      // Mostrar sucesso
      alert(`‚úÖ SENHA DO WHATSAPP ALTERADA!\n\nNova senha configurada com sucesso.\n\nAnote em local seguro!`);
      
      console.log('‚úÖ Senha do WhatsApp alterada com sucesso!');
      
    } catch (error) {
      console.error(' Erro ao alterar senha:', error);
      alert('‚ùå Erro: ' + error.message);
    }
  };
  
  // Focar no primeiro campo
  document.getElementById('senhaAtualWhatsApp').focus();
  
  // Enter para confirmar
  modal.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('btnConfirmarWhatsApp').click();
    }
  });
};

// =========================
// ATIVAR MODO T√âCNICO AUTOMATICAMENTE NO CONSOLE
// =========================
console.log('üîß MODO T√âCNICO DISPON√çVEL!');
console.log('üí° Digite no console:');
console.log('‚Ä¢ ativarModoTecnico() - Abrir painel t√©cnico (senha exclusiva)');

// Atalho de teclado para modo t√©cnico (Ctrl+Alt+T)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.altKey && e.key === 't') {
        e.preventDefault();
        console.log('üéØ Atalho Ctrl+Alt+T detectado - solicitando acesso...');
        if (typeof ativarModoTecnico === 'function') {
            ativarModoTecnico();
        }
    }
});

console.log(' Atalho: Ctrl+Alt+T para modo t√©cnico (com senha exclusiva)');
console.log(' Senha padr√£o do t√©cnico: tecnico123 (altere no primeiro acesso)');

// Ajustar quando a janela for redimensionada
window.addEventListener('resize', function() {
  if (document.querySelector('.modal-backdrop')) {
    melhorarMobileAdmin();
  }
});

//-------------------------------------------------------------------------------------
// =========================
// SISTEMA DE RETIRADA NO LOCAL (OPCIONAL)
// =========================

// Fun√ß√£o para controlar retirada no local
function configurarRetiradaLocal() {
    const checkbox = document.getElementById('retirarLocal');
    if (!checkbox) return;
    
    // Carregar prefer√™ncia salva
    const preferenciaSalva = localStorage.getItem('retirarLocal') === 'true';
    checkbox.checked = preferenciaSalva;
    
    // Aplicar efeito inicial
    if (preferenciaSalva) {
        aplicarModoRetirada(true);
    }
    
    // Adicionar evento de mudan√ßa
    checkbox.addEventListener('change', function() {
        const retirarLocal = this.checked;
        
        // Salvar prefer√™ncia
        localStorage.setItem('retirarLocal', retirarLocal);
        
        // Aplicar/remover taxa
        aplicarModoRetirada(retirarLocal);
        
        // Recarregar carrinho
        if (typeof renderCart === 'function') {
            renderCart();
        }
    });
}

// Fun√ß√£o para aplicar modo retirada
function aplicarModoRetirada(retirarLocal) {
    const checkbox = document.getElementById('retirarLocal');
    const labelDiv = checkbox?.closest('label');
    
    if (retirarLocal) {
        console.log('‚úÖ Modo: Retirar no local (taxa removida)');
        if (labelDiv) {
            labelDiv.style.background = '#f0fff4';
            labelDiv.style.borderColor = '#27ae60';
        }
    } else {
        console.log('üöö Modo: Entrega normal (taxa aplicada)');
        if (labelDiv) {
            labelDiv.style.background = '#f0f8ff';
            labelDiv.style.borderColor = '#3498db';
        }
    }
}

// Chamar fun√ß√£o quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(configurarRetiradaLocal, 1000);
});

//-------------------------------------------------------------------------------------
</script>
</body>
</html>